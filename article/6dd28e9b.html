<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spring Cloud Alibaba学习-一 | 七之月</title><meta name="keywords" content="微服务"><meta name="author" content="七月"><meta name="copyright" content="七月"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="微服务">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud Alibaba学习-一">
<meta property="og:url" content="https://www.isfate.xyz/article/6dd28e9b.html">
<meta property="og:site_name" content="七之月">
<meta property="og:description" content="微服务">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://api.mtyqx.cn/api/random.php?34">
<meta property="article:published_time" content="2021-07-02T02:12:56.000Z">
<meta property="article:modified_time" content="2022-02-07T11:55:22.342Z">
<meta property="article:author" content="七月">
<meta property="article:tag" content="微服务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://api.mtyqx.cn/api/random.php?34"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://www.isfate.xyz/article/6dd28e9b"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.zhimg.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?666c7691895360baeecc42f2ba8ba136";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();

const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://unpkg.zhimg.com/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://unpkg.zhimg.com/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://unpkg.zhimg.com/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://unpkg.zhimg.com/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://unpkg.zhimg.com/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring Cloud Alibaba学习-一',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-07 19:55:22'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/myiszhb/myiszhb.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="七之月" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/my-zhb/CDN/blog/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('http://api.mtyqx.cn/api/random.php?34')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">七之月</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spring Cloud Alibaba学习-一</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-07-02T02:12:56.000Z" title="发表于 2021-07-02 10:12:56">2021-07-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-07T11:55:22.342Z" title="更新于 2022-02-07 19:55:22">2022-02-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/">java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>35分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Spring Cloud Alibaba学习-一"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>Spring Cloud Alibaba是Spring Cloud下的一个子项目Spring Cloud Alibaba为分布式应用程序开发提供了一站式解决方案，它包含开发分布式应用程序所需的所有组件，使您可以轻松使用Spring Cloud开发应用程序，使用Spring Cloud Alibaba你只需要添加一些注解和少量配置即可将Spring Cloud应用程序连接到Alibaba的分布式解决方案，并使用Alibaba中间件构建分布式应用程序系统;</p>
<h1 id="Nacos注册中心"><a href="#Nacos注册中心" class="headerlink" title="Nacos注册中心"></a>Nacos注册中心</h1><p>Nacos主要用于实现动态服务注册实现、服务配置、服务元数据及流量管理；</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/nacos/releases">下载Nacos最新版本</a></p>
<h2 id="提供者-消费端配置"><a href="#提供者-消费端配置" class="headerlink" title="提供者/消费端配置"></a>提供者/消费端配置</h2><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.3.0.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud-alibaba.version</span>&gt;</span>2.2.1.RELEASE <span class="tag">&lt;/<span class="name">spring-cloud-alibaba.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- nacos 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 继承 spring cloud Alibaba依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 继承 spring boot依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">18082</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">spring-cloud-alibaba-nacos-provider</span></span><br><span class="line">  <span class="comment"># 连接 nacos</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment"># ip：port</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">111.231</span><span class="number">.207</span><span class="number">.228</span><span class="string">:8848</span></span><br><span class="line">        <span class="comment"># 账号</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="comment"># 密码</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">2020Fate!</span></span><br></pre></td></tr></table></figure>
<p>启动类 加上注解<code>@EnableDiscoveryClient</code>开启nacos支持;</p>
<h2 id="服务发现与负载均衡调用"><a href="#服务发现与负载均衡调用" class="headerlink" title="服务发现与负载均衡调用"></a>服务发现与负载均衡调用</h2><h3 id="LoadBalancerClient调用"><a href="#LoadBalancerClient调用" class="headerlink" title="LoadBalancerClient调用"></a>LoadBalancerClient调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//消费者配置</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">	<span class="keyword">private</span> LoadBalancerClient loadBalancerClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/echo/&#123;app&#125;&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">echoAppName</span><span class="params">(<span class="meta">@PathVariable(&quot;app&quot;)</span> String app)</span></span>&#123;</span><br><span class="line">		<span class="comment">//使用 LoadBalanceClient 和 RestTemplate 结合的方式来访问,loadBalancerClient实现了负载均衡所以RestTemplate不需要再配置负载均衡</span></span><br><span class="line">		ServiceInstance serviceInstance = loadBalancerClient.choose(<span class="string">&quot;spring-cloud-alibaba-nacos-provider&quot;</span>);</span><br><span class="line">		<span class="comment">//http://192.168.0.104:18082/echo/&#123;app&#125;</span></span><br><span class="line">		String url = String.format(<span class="string">&quot;http://%s:%s/echo/%s&quot;</span>, serviceInstance.getHost(), serviceInstance.getPort(), app);</span><br><span class="line">		System.out.println(<span class="string">&quot;request url:&quot;</span>+url);</span><br><span class="line">		<span class="keyword">return</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//生产者配置</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/echo/&#123;string&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(<span class="meta">@PathVariable</span> String string)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;provider /echo/&#123;string&#125;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;loadBalancerClient 方式调用成功!&quot;</span> + string;</span><br><span class="line">    &#125;</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<h3 id="RestTemplate调用"><a href="#RestTemplate调用" class="headerlink" title="RestTemplate调用"></a>RestTemplate调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplateConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@LoadBalanced</span><span class="comment">//开启负载均衡</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">｝</span><br><span class="line">    </span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">	<span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/echo-rest/&#123;str&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">rest</span><span class="params">(<span class="meta">@PathVariable</span> String str)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//restTemplate + @LoadBalanced 实现远程调用</span></span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">&quot;http://spring-cloud-alibaba-nacos-provider/echo/&quot;</span> + str, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="OpenFeign调用"><a href="#OpenFeign调用" class="headerlink" title="OpenFeign调用"></a>OpenFeign调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">	<span class="keyword">private</span> EchoFeignService echoFeignService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/divide-feign&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">divide</span><span class="params">(<span class="meta">@RequestParam</span> Integer a,<span class="meta">@RequestParam</span> Integer b)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> echoFeignService.divide(a,b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//feign 调用配置</span></span><br><span class="line"><span class="meta">@FeignClient(name = &quot;spring-cloud-alibaba-nacos-provider&quot;,</span></span><br><span class="line"><span class="meta">        fallback = EchoFeignServiceFallback.class,configuration = EchoFeignConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EchoFeignService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/echo/&#123;str&#125;&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">echo</span><span class="params">(<span class="meta">@PathVariable(&quot;str&quot;)</span>String str)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/divide&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">divide</span><span class="params">(<span class="meta">@RequestParam(&quot;a&quot;)</span>Integer a,<span class="meta">@RequestParam(&quot;b&quot;)</span>Integer b)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * feign声明的接口可以有默认实现，就是可以不需要远程服务提供者实现，自己实现</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> a</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">divide</span><span class="params">(Integer a)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer divide method.... &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> divide(a,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/notFound&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">notFound</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoFeignConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把降级类在容器内创建</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EchoFeignServiceFallback <span class="title">echoFeignServiceFallback</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EchoFeignServiceFallback();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//降级配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoFeignServiceFallback</span> <span class="keyword">implements</span> <span class="title">EchoFeignService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;echo 方法降级了&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">divide</span><span class="params">(Integer a, Integer b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;divide 方法降级了&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">notFound</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;notFound 方法降级了&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DiscoveryClient调用"><a href="#DiscoveryClient调用" class="headerlink" title="DiscoveryClient调用"></a>DiscoveryClient调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">	<span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * DiscoveryClient 调用</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> service</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/clien/&#123;service&#125;&quot;)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">clien</span><span class="params">(<span class="meta">@PathVariable</span> String service)</span></span>&#123;</span><br><span class="line">		<span class="comment">//拿到服务的描述</span></span><br><span class="line">		discoveryClient.description();</span><br><span class="line">		<span class="comment">//拿到服务的实例</span></span><br><span class="line">		List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;spring-cloud-alibaba-nacos-provider&quot;</span>);</span><br><span class="line">		<span class="comment">//拿到服务的顺序</span></span><br><span class="line">		discoveryClient.getOrder();</span><br><span class="line">		<span class="comment">//拿到服务的服务</span></span><br><span class="line">		discoveryClient.getServices();</span><br><span class="line">		<span class="keyword">return</span> discoveryClient.getInstances(service);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Nacos-客户端缓存信息"><a href="#Nacos-客户端缓存信息" class="headerlink" title="Nacos 客户端缓存信息"></a>Nacos 客户端缓存信息</h2><p>如果服务之间发生过调用，Nacos宕机了不会影响服务的调用，如果没有发生调用，Nacos宕机之后是无法正常访问的；</p>
<p>在spring cloud alibab源码(spring-cloud-starter-alibaba-nacos-discovery)中的<code>NacosServer</code>中有一个参数为<code>metadata</code>的map集合，用于保存调用的信息；</p>
<h2 id="指定分组"><a href="#指定分组" class="headerlink" title="指定分组"></a>指定分组</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">      	<span class="comment"># 服务发现地址</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">111.231</span><span class="number">.207</span><span class="number">.228</span><span class="string">:8848</span></span><br><span class="line">        <span class="comment"># 服务发现命名空间</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">da1df238-5000-4f3c-b63a-53f4662d755b</span></span><br><span class="line">        <span class="comment"># 服务分组</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">dev_group</span></span><br></pre></td></tr></table></figure>
<h1 id="Nacos-配置中心"><a href="#Nacos-配置中心" class="headerlink" title="Nacos 配置中心"></a>Nacos 配置中心</h1><p>​    nacos提供用于存储配置和其他元数据的key/value存储，为分布式系统中的外部化配置提供服务端和客户端支持，使用spring cloud alibaba nacos config 就可以在Nacos Server集中管理Spring Cloud 应用的外部属性配置；</p>
<p>​    nacos config是在特殊的bootstrap阶段，配置被加载到spring环境中；</p>
<p>​    nacos config使用DataId和Group 确认一个配置 </p>
<h2 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h2><blockquote>
<p>1.引入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- nacos 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- nacos config 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>2.配置bootstrap.yml</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7070</span></span><br><span class="line"><span class="comment"># 配置服务名称</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-service-nacos-config</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="comment"># nacos账号密码</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">2020Fate!</span></span><br><span class="line">      <span class="comment"># 服务发现地址</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">111.231</span><span class="number">.207</span><span class="number">.228</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">111.231</span><span class="number">.207</span><span class="number">.228</span><span class="string">:8848</span></span><br><span class="line">      <span class="comment"># 如果nacos配置中心的group_id发生改变这里就要改</span></span><br><span class="line"><span class="comment">#      config:</span></span><br><span class="line"><span class="comment">#        group: lll</span></span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>nacos客户端</li>
</ol>
</blockquote>
<p>1.Properties</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210825155512650.png" alt="image-20210825155512650"></p>
<p>2.yaml</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210825162641315.png" alt="image-20210825162641315"></p>
<p>并且需要修改配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="comment"># 指定命名空间</span></span><br><span class="line">    	<span class="attr">config:</span></span><br><span class="line">    		<span class="attr">namespace:</span> <span class="string">90a8f778-69e1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>4.读取nacos配置</p>
</blockquote>
<p>方式1：不推荐</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span><span class="comment">//开启服务注册与发现</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConfigApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext applicationContext = SpringApplication.run(NacosConfigApplication.class, args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//当动态配置刷新时，会更新到Enviroment中，因此此处每个1秒从Enviroment中获取数据</span></span><br><span class="line">        String userName = applicationContext.getEnvironment().getProperty(<span class="string">&quot;user.name&quot;</span>);</span><br><span class="line">        String password = applicationContext.getEnvironment().getProperty(<span class="string">&quot;user.password&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取当前部署的环境</span></span><br><span class="line">        String currentEnv = applicationContext.getEnvironment().getProperty(<span class="string">&quot;current.env&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;user name：&quot;</span>+userName +<span class="string">&quot;—————— user password：&quot;</span>+password+<span class="string">&quot;—————— 当前环境：&quot;</span>+currentEnv);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方式2：通过@Value 读取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;user.name&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;user.password&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String password;</span><br></pre></td></tr></table></figure>
<p>方式3：@ConfigurationProperties读取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>5.nacos频繁打印日志</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.alibaba.nacos.client.config.impl:</span> <span class="string">WARN</span></span><br></pre></td></tr></table></figure>
<h2 id="多环境"><a href="#多环境" class="headerlink" title="多环境"></a>多环境</h2><p>项目配置加上</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="comment"># 激活那个nacos配置</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>
<p>nacos客户端配置</p>
<p>DataId命名<code>项目名称-环境.文件类型</code>，例如我这里的<code>springcloud-service-nacos-config-dev.properties</code></p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210825165132360.png" alt="image-20210825165132360"></p>
<h2 id="服务配置数据模型"><a href="#服务配置数据模型" class="headerlink" title="服务配置数据模型"></a>服务配置数据模型</h2><blockquote>
<ol>
<li>命名空间</li>
</ol>
</blockquote>
<p>​    用于配置隔离，不同命名空间下，可以存在相同的Group或者Data ID配置，Namespace的常用场景之一是不同环境的配置进行分区隔离，例如开发环境、测试环境和生产环境的资源（如配置、服务）隔离等；</p>
<blockquote>
<ol>
<li>Group</li>
</ol>
</blockquote>
<p>​    Nacos中的一组配置集合，是组织配置的维度之一，通过一个有意义的字符串（如Buy或Trade）对一组配置集合进行分组，从而区分Data ID相同的配置集合，当在Nacos上创建一个配置时，如果未填写配置分组的名称，则配置分组的名称默认采用DEFAULT_GROUP，配置分组的常用场景：不同的应用或组件使用了相同的配置类型，如database_url配置和MQ_topic配置；</p>
<blockquote>
<p>3.Data ID</p>
</blockquote>
<p>​    Nacos中的某个配置集合的ID，配置集合ID是组织划分配置的维度之一，Data iD通常用于组织划分系统的配置集合，一个系统或者应用可以包含多个配置集合，每个配置集都可以被一个有意义的名称表示；</p>
<blockquote>
<p>Nacos data model</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210827142805034.png" alt="image-20210827142805034"></p>
<p>第一种方案：</p>
<p>​    默认命名空间（public）+默认Group分组（Default_GROUP）+自定义Data ID（没有默认值）</p>
<p>第二种方案：</p>
<p>​    默认命名空间+自定义Group分组+自定义Data Id（没有默认值）</p>
<p>​    </p>
<h2 id="Nacos持久化"><a href="#Nacos持久化" class="headerlink" title="Nacos持久化"></a>Nacos持久化</h2><p>​    nacos默认情况下是采用apache derby内嵌数据库进行数据存储，在单机模式时可以使用nacos嵌入式数据库实现数据存储，但是derby数据库不方便观察数据存储的基本情况，从nacos0.7版本开始添加了支持mysql数据源能力；</p>
<blockquote>
<p>第一步</p>
</blockquote>
<p>​    安装mysql5.7+；初始化mysql数据库，数据库初始化文件：<code>nacos-mysql.sql</code>，该未见在Nacos程序包conf目录下；</p>
<blockquote>
<p>第二步</p>
</blockquote>
<p>​    修改conf/application.properties文件，增加支持MySQL数据源配置，添加（目前只支持mysql）数据源的url、用户名和密码；然后启动nacos（单机启动），此时发现nacos所有写嵌入式数据库的数据都写到MySQL去了；</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210830151707248.png" alt="image-20210830151707248"></p>
<p>启动nacos <code>./startup.sh -m standalone</code></p>
<h2 id="Nacos集群"><a href="#Nacos集群" class="headerlink" title="Nacos集群"></a>Nacos集群</h2><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210830152648812.png" alt="image-20210830152648812"></p>
<p>具体步骤：</p>
<blockquote>
<p>第一步</p>
</blockquote>
<p>准备3台nacos</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">ip</th>
<th style="text-align:center">名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">192.168.1.211</td>
<td style="text-align:center">nacos-01</td>
</tr>
<tr>
<td style="text-align:center">192.168.1.212</td>
<td style="text-align:center">nacos-02</td>
</tr>
<tr>
<td style="text-align:center">192.168.1.213</td>
<td style="text-align:center">nacos-03</td>
</tr>
<tr>
<td style="text-align:center">192.168.1.111</td>
<td style="text-align:center">nginx</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>第二步 配置nacos集群</p>
</blockquote>
<p>​    在Nacos的conf目录下有一个<code>cluster.conf.example</code>，可以直接把example扩展名去掉来使用，也可以单独创建一个cluster.conf文件。然在该文件中每行配置一个ip:prot，3个节点都要配置如图：</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210830161401079.png" alt="image-20210830161401079"></p>
<blockquote>
<p>第三步 安装nginx</p>
</blockquote>
<ol>
<li>安装nginx</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">下载nginx并且安装</span></span><br><span class="line">yum install -y nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">启动</span></span><br><span class="line">systemctl start nginx</span><br><span class="line"><span class="meta">#</span><span class="bash">开机启动</span></span><br><span class="line">systemctl enable nginx</span><br></pre></td></tr></table></figure>
<ol>
<li>配置nginx前需要检查selinux是否关闭</li>
</ol>
<p>输入<code>getenforce</code>命令可以查看<strong>selinux</strong>是否关闭，如果显示<code>disabled</code>或者<code>permissive</code>表示已经关闭，如果显示<code>enforcing</code>则表示没有关闭，需要手动打开</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getenforce</span><br></pre></td></tr></table></figure>
<p>临时关闭seliunx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0    ##设置SELinux 成为permissive模式</span><br><span class="line">setenforce 1    ##设置SELinux 成为enforcing模式</span><br></pre></td></tr></table></figure>
<p>永久关闭seliunx，修改/etc/selinux/config，将<code>SELINUX=enforcing</code>改为<code>SELINUX=disabled</code></p>
<blockquote>
<p>第四步 配置方向代理</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">upstream nacos-server&#123;</span><br><span class="line">	server 192.168.1.211:8848;</span><br><span class="line">	server 192.168.1.212:8848;</span><br><span class="line">	server 192.168.1.213:8848;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  192.168.1.111;</span><br><span class="line"></span><br><span class="line">    #access_log  /var/log/nginx/host.access.log  main;</span><br><span class="line">    location /nacos &#123;</span><br><span class="line">        proxy_pass http://nacos-server/nacos;</span><br><span class="line">    &#125;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第五步 测试</p>
</blockquote>
<p>通过访问<code>http://192.168.1.111/nacos</code>测试</p>
<h2 id="Nacos服务权重"><a href="#Nacos服务权重" class="headerlink" title="Nacos服务权重"></a>Nacos服务权重</h2><p> <img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210902132800021.png" alt="image-20210902132800021"></p>
<p>分为0和1两个等级，0表示少，使用NacosRule的策略；</p>
<h2 id="Nacos集群负载均衡"><a href="#Nacos集群负载均衡" class="headerlink" title="Nacos集群负载均衡"></a>Nacos集群负载均衡</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定集群的名称</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">cluster-name:</span> <span class="string">集群名称</span></span><br></pre></td></tr></table></figure>
<p>如果配置了这指定集群，那它就会调用这边的集群，如果这个集群挂掉了，它才会去掉其他地方的集群；</p>
<h2 id="命名空间负载均衡"><a href="#命名空间负载均衡" class="headerlink" title="命名空间负载均衡"></a>命名空间负载均衡</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">命名空间id</span></span><br></pre></td></tr></table></figure>
<p>在提供者和消费者当中添加如上配置，如果消费者没有配置，是无法进行ribbon调用的；</p>
<h2 id="Ribbon懒加载"><a href="#Ribbon懒加载" class="headerlink" title="Ribbon懒加载"></a>Ribbon懒加载</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认是懒加载，服务启动一次调用很慢，因为它会去注册中心获取</span></span><br><span class="line"><span class="string">rabbion.eager-load.enabled=true</span></span><br><span class="line"><span class="comment">#为那些服务开启饥饿加载，多个用逗号隔开，非必填</span></span><br><span class="line"><span class="string">rabbion.eager-load.clients=服务名称</span></span><br></pre></td></tr></table></figure>
<h1 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h1><p>​    在分布式系统里，许多服务之间通过远程调用实现信息交互，调用时不可避免会出现调用失败，比如超时、异常等原因导致调用失败，Sentinel能够保证在一个服务出现问题的情况下，不会导致整体服务失败，避免级联故障（服务雪崩），以提高分布式系统的弹性；</p>
<blockquote>
<p>常用的容错方案</p>
</blockquote>
<ol>
<li>超时，设置比较短的超时时间，调用不成功，很短时间就释放线程，避免大量线程堵塞等待，导致服务cpu、内存等资源飙高；</li>
<li>限流，超过设置的阈值就拒绝，比如评估系统的QPS是3000，那么就可以设置线路阈值是2800；</li>
<li>仓壁保护，就是一艘船不是一个船舱，而是把一个船舱划分为多个船舱，某个船舱进水了，其他船舱都不受影响；</li>
<li>断路器，熔断器也叫断路器。“熔断器”本身是一种开关装置，用于在电路上保护线路过载，当线路中又电器发生短路时，能够及时切断故障电路，防止发生过载、发热甚至起火等严重后果；</li>
</ol>
<h2 id="什么是Sentinel"><a href="#什么是Sentinel" class="headerlink" title="什么是Sentinel"></a>什么是Sentinel</h2><p>1.当服务访问量达到一定程度，流量扛不住的时候，该如何处理？</p>
<p>2.服务之间相互依赖，当服务A出现响应时间过长，影响到服务B的响应，进而产生连锁反应，直至影响整个依赖链上的所有服务，该如何处理？</p>
<p>Sentinel以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性，<code>官方定义：Sentinel是一个轻量级的流量控制、熔断降级Java组件，是分布式系统的流量防卫兵</code>；</p>
<h2 id="Sentinel组成"><a href="#Sentinel组成" class="headerlink" title="Sentinel组成"></a>Sentinel组成</h2><blockquote>
<p>1.核心库（Java客户端）</p>
</blockquote>
<p>​    Sentinel是核心库不依赖任何第三方框架/库，能够运行于所有Java环境；</p>
<blockquote>
<p>2.控制台</p>
</blockquote>
<p>​    基于springboot开发，打包后可以直接运行，不需要额外的Tomcat等应用容器；</p>
<h2 id="集成Sentienl"><a href="#集成Sentienl" class="headerlink" title="集成Sentienl"></a>集成Sentienl</h2><blockquote>
<p>核心库</p>
</blockquote>
<p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- spring cloud alibaba sentinel 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="comment"># 指定sentinel控制台</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>控制台</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/releases">sentientl dashboard</a>下载，然后启动，默认账号密码：sentinel</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar sentinel-dashboard-1.8.2.jar</span><br></pre></td></tr></table></figure>
<p>然后调用任意接口，就能看到服务被注册到了sentinel</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210902174839114.png" alt="image-20210902174839114"></p>
<h2 id="Sentinel限流"><a href="#Sentinel限流" class="headerlink" title="Sentinel限流"></a>Sentinel限流</h2><h3 id="流控模式"><a href="#流控模式" class="headerlink" title="流控模式"></a>流控模式</h3><p>1、<code>直接模式</code>：就是直接对该资源进行控制；</p>
<p>2、<code>关联模式</code>：关联某一个资源，被关联的资源达到阈值，则限制当前资源访问；</p>
<p>3、<code>链路模式</code>：记录指定链路上的流量；</p>
<h3 id="流控效果"><a href="#流控效果" class="headerlink" title="流控效果"></a>流控效果</h3><p>1、<code>快速失败</code>：直接限制；</p>
<p>2、<code>预热模式</code>：根据codeFactor（默认为3）的值，从阈值/codeFactor，经过预热的时长，才达到设置的QPS阈值，比如设置QPS阈值为100，那么100/3=33，那么33作为最初的阈值，然后在10秒（预热时长）到达100后在开始限流；</p>
<p>3、<code>排队等待</code>：在QPS阈值到达后，新的请求就会等待，直到超时（这里配置超时时间），可以适用于突发流量的请求；</p>
<h3 id="QPS限流-直接"><a href="#QPS限流-直接" class="headerlink" title="QPS限流(直接)"></a>QPS限流(直接)</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210907111034315.png" alt="image-20210907111034315"></p>
<p>对某一个路径进行<code>流控</code></p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210907111144062.png" alt="image-20210907111144062"></p>
<p>然后对该路径进行测试</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210907162551280.png" alt="image-20210907162551280"></p>
<p>然后一秒钟我访问了&gt;2次 ，然后就被拒绝访问了；</p>
<h3 id="自定义返回结果"><a href="#自定义返回结果" class="headerlink" title="自定义返回结果"></a>自定义返回结果</h3><p>实现<code>BlockExceptionHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBadBlockExceptionHandler</span> <span class="keyword">implements</span> <span class="title">BlockExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, BlockException e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;进入自定义限流提示.............&quot;</span>);</span><br><span class="line"></span><br><span class="line">        RestObject restObject = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//不同得异常返回不同得提示</span></span><br><span class="line">        <span class="keyword">if</span>(e <span class="keyword">instanceof</span> FlowException)&#123;</span><br><span class="line">            restObject = RestObject.builder().statusCode(<span class="number">100</span>).statusMessage(<span class="string">&quot;接口限流了&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> DegradeException)&#123;</span><br><span class="line">            restObject = RestObject.builder().statusCode(<span class="number">101</span>).statusMessage(<span class="string">&quot;服务降级了&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> ParamFlowException)&#123;</span><br><span class="line">            restObject = RestObject.builder().statusCode(<span class="number">102</span>).statusMessage(<span class="string">&quot;热点参数限流了&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> SystemBlockException)&#123;</span><br><span class="line">            restObject = RestObject.builder().statusCode(<span class="number">103</span>).statusMessage(<span class="string">&quot;触发系统保护规则&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> AuthorityException)&#123;</span><br><span class="line">            restObject = RestObject.builder().statusCode(<span class="number">104</span>).statusMessage(<span class="string">&quot;授权规则不通过&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        response.setStatus(<span class="number">500</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        response.setContentType(MediaType.APPLICATION_JSON_VALUE);</span><br><span class="line">        <span class="keyword">new</span> ObjectMapper().writeValue(response.getWriter(),restObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210907162825817.png" alt="image-20210907162825817"></p>
<h3 id="自定义跳转页面"><a href="#自定义跳转页面" class="headerlink" title="自定义跳转页面"></a>自定义跳转页面</h3><p>引入<code>tomcat-embed-jasper</code>依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 前端页面使用jsp--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 引入springboot内勤得tomcat对jsp的解析包--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>实现<code>BlockExceptionHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBadBlockExceptionHandler</span> <span class="keyword">implements</span> <span class="title">BlockExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, BlockException e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;进入自定义限流提示.............&quot;</span>);</span><br><span class="line"></span><br><span class="line">        RestObject restObject = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//不同得异常返回不同得提示</span></span><br><span class="line">        <span class="keyword">if</span>(e <span class="keyword">instanceof</span> FlowException)&#123;</span><br><span class="line">            restObject = RestObject.builder().statusCode(<span class="number">100</span>).statusMessage(<span class="string">&quot;接口限流了&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> DegradeException)&#123;</span><br><span class="line">            restObject = RestObject.builder().statusCode(<span class="number">101</span>).statusMessage(<span class="string">&quot;服务降级了&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> ParamFlowException)&#123;</span><br><span class="line">            restObject = RestObject.builder().statusCode(<span class="number">102</span>).statusMessage(<span class="string">&quot;热点参数限流了&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> SystemBlockException)&#123;</span><br><span class="line">            restObject = RestObject.builder().statusCode(<span class="number">103</span>).statusMessage(<span class="string">&quot;触发系统保护规则&quot;</span>).build();</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> AuthorityException)&#123;</span><br><span class="line">            restObject = RestObject.builder().statusCode(<span class="number">104</span>).statusMessage(<span class="string">&quot;授权规则不通过&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//跳转页面</span></span><br><span class="line">        request.getRequestDispatcher(<span class="string">&quot;/index.jsp&quot;</span>).forward(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>resources</code>目录下创建<code>META-INF.resources</code>目录，创建index.jsp文件</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;信息提示&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">   Sorry，限流了.......</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>然后就可以跳转啦！</p>
<h3 id="线程组限流-直接"><a href="#线程组限流-直接" class="headerlink" title="线程组限流(直接)"></a>线程组限流(直接)</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210907163350297.png" alt="image-20210907163350297"></p>
<p>如果超过10个线程数就会被限流，然后我们用<code>jmeter</code>进行测试</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210907164850331.png" alt="image-20210907164850331"></p>
<h3 id="关联模式"><a href="#关联模式" class="headerlink" title="关联模式"></a>关联模式</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210907165655042.png" alt="image-20210907165655042">x</p>
<p>这里选择流控模式选择的是<code>关联</code>，就需要关联另外一个资源，如果那个资源（/notFound-feign）被限流了，当前的资源（/test）也不被限流；</p>
<p>写个方法无限调用<code>/notFound-feign</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">16</span>);</span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                 executorService.submit(() -&gt; &#123;</span><br><span class="line">                      restTemplate.getForObject(<span class="string">&quot;http://127.0.0.1:18083/notFound-feign&quot;</span>, String.class);</span><br><span class="line">                 &#125;);</span><br><span class="line">                 Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：<code>因为关联资源(/notFound-feign)被限流了，所有我去访问(/test)资源也会被限流</code></p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210907170506451.png" alt="image-20210907170506451"></p>
<h3 id="链路模式"><a href="#链路模式" class="headerlink" title="链路模式"></a>链路模式</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210907171043992.png" alt="image-20210907171043992"></p>
<p>这个<code>入口资源</code>就是</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210907171138619.png" alt="image-20210907171138619"></p>
<p><code>如果sentinel_spring_web_context的入口阈值达到了我们设定的阈值，那么资源名对应的资源就会被限流</code>；</p>
<h2 id="Sentinel熔断"><a href="#Sentinel熔断" class="headerlink" title="Sentinel熔断"></a>Sentinel熔断</h2><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210907173135202.png" alt="image-20210907173135202"></p>
<h3 id="降级策略"><a href="#降级策略" class="headerlink" title="降级策略"></a>降级策略</h3><blockquote>
<p>1、慢调用比例（<code>SLOW_REQUEST_RATIO</code>）</p>
</blockquote>
<p>​    选择以慢调用比例作为阈值，需要设置允许的慢调用RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用，当单位统计时长（<code>statIntervalMs</code>）内请求的数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内会自动被熔断，经过熔断时长后熔断器会进入探测恢复状态（<code>HALF-OPEN</code>），若接下来的一个请求响应时间小于设置的慢调用RT则结束熔断，若大于设置的慢调用RT则会被再次熔断；</p>
<blockquote>
<p>2、异常比例（<code>ERROR_RATIO</code>）</p>
</blockquote>
<p>​    当单位统计时长（<code>statIntervalMs</code>）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断，经过熔断时长后熔断器会进入探测恢复模式（<code>HALF-OPEN</code>），若接下来的一个请求完成（没有错误）则结束熔断，否则会被再次熔断，异常比例的阈值范围是<code>[0.0,1.0]</code>，代表0%-100%；</p>
<blockquote>
<p>3、异常数（<code>ERROR_COUNT</code>）</p>
</blockquote>
<p>​    当单位统计时长内的异常数目超过阈值之后会被自动进行熔断，，经过熔断时长后熔断器会进入探测恢复模式（<code>HALF-OPEN</code>），若接下来的一个请求完成（没有错误）则结束熔断，否则会被再次熔断；</p>
<p>​    </p>
<h3 id="慢调用比例"><a href="#慢调用比例" class="headerlink" title="慢调用比例"></a>慢调用比例</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210908140154618.png" alt="image-20210908140154618"></p>
<p>如图慢调用RT=2ms，比例阈值为0.2（20%），熔断时间长30s，最小请求数20，统计时间10s；</p>
<p>在统计时间10s内，触发熔断的条件为，只要有请求RT&gt;2ms的次数超过4（最小请求数20*0.2）就触发这个熔断，熔断时长为30s，经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN状态），若接下来的一个请求响应时长小于设置的慢调用RT则结束熔断，若大于设置的慢调用RT则会再次被熔断；</p>
<h3 id="异常比"><a href="#异常比" class="headerlink" title="异常比"></a>异常比</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210908144359329.png" alt="image-20210908144359329"></p>
<p>如图：</p>
<p><code>比例阈值</code>：为0.2，也就是百分之20，熔断时间为10s，如果统计时长（1秒内），出现了&gt;5的请求，并且异常率达到20%，就会进入熔断；</p>
<h3 id="异常数"><a href="#异常数" class="headerlink" title="异常数"></a>异常数</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210908144710443.png" alt="image-20210908144710443"></p>
<p>如图：</p>
<p><code>异常数量</code>：1，熔断时间为10s，如果统计时长（1秒内），出现了&gt;2的请求，并且异常&gt;=1，就会进入熔断；</p>
<h2 id="热点规则"><a href="#热点规则" class="headerlink" title="热点规则"></a>热点规则</h2><p>访问频率最高的Top K 数据，并对其访问进行限制，例如：</p>
<p>​    商品ID为参数，统计一段时间内最常购买的商品ID并进行限制；</p>
<p>​    用户ID为参数，针对一段时间内频繁访问的用户ID进行限制；</p>
<p>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源进行限流，热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效；</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><blockquote>
<p>controller</p>
</blockquote>
<p>方法上添加<code>@SentinelResource()</code>注解否则不生效</p>
<p>触发限制调用的方法<code>fallback = &quot;fallback&quot;</code>，方法对应的类<code>fallbackClass = MyFallbackClass.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/app&quot;)</span> <span class="comment">// 埋点：加入sentinel的监控</span></span><br><span class="line">	<span class="meta">@SentinelResource(value = &quot;app&quot;, fallback = &quot;fallback&quot;, fallbackClass = MyFallbackClass.class)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">app</span><span class="params">(<span class="meta">@RequestParam(value = &quot;a&quot;, required = false)</span> String a)</span> </span>&#123;</span><br><span class="line"> 		<span class="keyword">return</span> <span class="string">&quot;成功&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>MyFallbackClass</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFallbackClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 该方法一定要是static方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> a</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> b</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">fallback</span><span class="params">(String a, String b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我被限制访问了&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>热点规则配置</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210908165715233.png" alt="image-20210908165715233.png"></p>
<h2 id="系统规则"><a href="#系统规则" class="headerlink" title="系统规则"></a>系统规则</h2><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210908172509672.png" alt="image-20210908172509672"></p>
<h3 id="阈值类型"><a href="#阈值类型" class="headerlink" title="阈值类型"></a>阈值类型</h3><blockquote>
<p>1、<code>LOAD</code></p>
</blockquote>
<p>​    Load自适应（仅对Linux/Unix-like机器生效）：系统的load1作为启发指标，进行自适应系统保护，当系统load1超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护，系统容量又系统的maxQps <em> minRt 估算得出，设定参考一般是`CPU cores </em> 2.5`;</p>
<blockquote>
<p>2、平均PT</p>
</blockquote>
<p>​    当单台机器上所有入口流量的平均RT达到阈值即触发系统保护，单位是毫秒；</p>
<blockquote>
<p>3、并发线程数</p>
</blockquote>
<p>​    当单台机器上所有入口流量的并非线程数达到阈值即触发系统保护；</p>
<blockquote>
<p>4、入口QPS</p>
</blockquote>
<p>​    当单台机器上所有入口流量的QPS达到阈值即触发系统保护；</p>
<blockquote>
<p>5、CPU usage(1.5.0+ 版本)</p>
</blockquote>
<p>​    当系统CPU使用率超过阈值即触发系统保护（取值访问0.0-1.0），比较灵活；</p>
<h2 id="授权控制"><a href="#授权控制" class="headerlink" title="授权控制"></a>授权控制</h2><blockquote>
<p>配置请求解析器</p>
</blockquote>
<p>解析请求获取其中的参数：<code>origin</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRequestOriginParser</span> <span class="keyword">implements</span> <span class="title">RequestOriginParser</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">parseOrigin</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String origin = request.getHeader(<span class="string">&quot;origin&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(origin))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;origin参数未指定！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> origin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>授权规则配置</p>
</blockquote>
<p>对<code>/test</code>进行授权，流控应用<code>123</code>，配置为白名单</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210908174919089.png" alt="image-20210908174919089"></p>
<blockquote>
<p>测试</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210908175125859.png" alt="image-20210908175125859"></p>
<p><code>因为流控</code>应用为123，所以这里授权规则不通过，如果我们把请求头参数改为123就可以了</p>
<h2 id="服务与Sentinel客户端通讯原理"><a href="#服务与Sentinel客户端通讯原理" class="headerlink" title="服务与Sentinel客户端通讯原理"></a>服务与Sentinel客户端通讯原理</h2><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210908175432872.png" alt="image-20210908175432872"></p>
<p>Sentinel Dashboard通过微服务集成的<code>sentinel-transport-simple-http</code>暴露的端点（http:localhost:8719/api）进行通信，Sentinel Dashboard配置完成后它会发回到对应的微服务去；</p>
<blockquote>
<p>sentinel饥饿加载</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">eager:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="Sentinel三种保护应用"><a href="#Sentinel三种保护应用" class="headerlink" title="Sentinel三种保护应用"></a>Sentinel三种保护应用</h2><blockquote>
<p>1、直接拦截我们所有controller的请求url路径</p>
</blockquote>
<p>​    Sentinel为springboot程序提供了一个starter依赖，由<code>sentinel starter依赖默认情况下就会为所有的HTTP服务提供限流埋点</code>，所以在springboot中的Controller都可以受到Sentinel保护；只需要应用添加<code>spring-cloud-starter-alibaba-sentinel</code>依赖，所有的HTTP接口都能获得Sentinel保护，当然，我们需要为Sentinel配置保护规则，底层通过一个拦截器对请求得url进行拦截（<code>com.alibaba.csp.sentinel.adapter.spring.webmvc.SentinelWebInterceptor</code>）,当然我们也可以通过配置文件来关闭保护<code>spring.cloud.sentinel.filter.enabled=false</code></p>
<blockquote>
<p>2、通过手写代码来保护</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping(&quot;/test/test&quot;)</span> <span class="comment">// 埋点：加入sentinel的监控</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//一个参数是资源名称，第二次参数是来源</span></span><br><span class="line">		ContextUtil.enter(<span class="string">&quot;test&quot;</span>,<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">		Entry entry = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//对test进行限流保护</span></span><br><span class="line">			entry = SphU.entry(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">			<span class="comment">//下面就是受保护得代码</span></span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;成功&quot;</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (BlockException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			<span class="comment">//这里判断是什么异常，比如</span></span><br><span class="line">			<span class="keyword">if</span>(e <span class="keyword">instanceof</span> FlowException)&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="string">&quot;接口限流了&quot;</span>;</span><br><span class="line">			&#125;<span class="keyword">else</span> <span class="keyword">if</span>(e <span class="keyword">instanceof</span> DegradeException)&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="string">&quot;服务熔断了&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//....................</span></span><br><span class="line">		&#125;<span class="keyword">catch</span> (ArithmeticException e)&#123;</span><br><span class="line">			Tracer.trace(e);</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;返回错误&quot;</span>;</span><br><span class="line">		&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span>(entry != <span class="keyword">null</span>)&#123;</span><br><span class="line">				entry.exit();</span><br><span class="line">			&#125;</span><br><span class="line">			ContextUtil.exit();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;失败了&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3、@SentinelResource来保护</p>
</blockquote>
<p>方法上添加<code>@SentinelResource()</code>注解否则不生效</p>
<p>触发限制调用的方法<code>fallback = &quot;fallback&quot;</code>，方法对应的类<code>fallbackClass = MyFallbackClass.class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/app&quot;)</span> <span class="comment">// 埋点：加入sentinel的监控</span></span><br><span class="line">	<span class="meta">@SentinelResource(value = &quot;app&quot;, fallback = &quot;fallback&quot;, fallbackClass = MyFallbackClass.class)</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">app</span><span class="params">(<span class="meta">@RequestParam(value = &quot;a&quot;, required = false)</span> String a)</span> </span>&#123;</span><br><span class="line"> 		<span class="keyword">return</span> <span class="string">&quot;成功&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@SentinelResource()对应的属性</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">属性</th>
<th style="text-align:left">作用</th>
<th style="text-align:center">是否必须</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">value</td>
<td style="text-align:left">资源名称</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">entryType</td>
<td style="text-align:left">entry类型，标记流量的方向，取值in/out,默认是out</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">blockHandler</td>
<td style="text-align:left">处理BlockException的函数名称，函数要求：<br/>1.必须是public<br/>2.返回类型与原方法一致<br/>3.参数类型需要和原方法相匹配，并在最后加BlockException类型参数<br/>4.默认要和原方法在同一个类中，若希望使用其他类的函数，可配置blockHandlerClass，并指定blockHandlerClass</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">blockHandlerClass</td>
<td style="text-align:left">存放blockhandler的类，对应的处理函数必须是static修饰，否则无法解析，其他要求同：blockHandler</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">fallback</td>
<td style="text-align:left">用于在抛出异常的时候提供fallback处理逻辑，fallback函数可以针对所有类型的异常（除了exceptionsToIgnore里面排除掉的异常类型）<br/>1.返回类型和原方法一致<br/>2.参数类型需要和原方法相匹配，Sentinel1.6开始，也可在方法最后加Throwable类型的参数<br/>3.默认要和原方法在同一个类中，若希望使用其他类型的函数，可配置fallbackClass，并指定fallbackClass里面的方法；</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">fallbackClass</td>
<td style="text-align:left">存放fallbakck的类，对应的处理函数必须是static修饰，否则无法解析，其他要求同：fallback</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">defaultFallback</td>
<td style="text-align:left">用于通用的fallback逻辑，默认fallback函数可以对所有类型的异常（除了exceptionsToIgnore里面排除掉的异常类型）进行处理，若同时配置了fallback和defalultFallback，以fallback为准，函数要求：<br/>1.返回类型和原方法一致<br/>2.方法参数列表为空，或者有一个Throwable类的参数<br/>3.默认要和原方法在同一个类中，若希望使用其他函数，可配置fallbakc，并指定fallbackClass里面的方法；</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">exceptionsToIgnore</td>
<td style="text-align:left">指定排除掉那些异常，排除的异常不会计入异常统计，也不会进入fallback逻辑，而是原样抛出；</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">exceptionsToTrace</td>
<td style="text-align:left">需要trace的异常</td>
<td style="text-align:center">Throwable</td>
</tr>
</tbody>
</table>
</div>
<h2 id="RestTemplate整合Sentinel"><a href="#RestTemplate整合Sentinel" class="headerlink" title="RestTemplate整合Sentinel"></a>RestTemplate整合Sentinel</h2><blockquote>
<p>1、开启sentinel对restTemplate的支持，默认关闭</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">resttemplate.sentinel.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>2、配置RestTemplate</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRibbonConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//负载均衡</span></span><br><span class="line">    <span class="meta">@SentinelRestTemplate(</span></span><br><span class="line"><span class="meta">            //blockHandler=&quot;blockA&quot;, blockHandlerClass=MyBlockHandlerClass.class 限流规则</span></span><br><span class="line"><span class="meta">            fallback = &quot;fallbackA&quot;,fallbackClass = MyBlockHandlerClass.class )</span><span class="comment">//降级规则</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3、自定义返回</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBlockHandlerClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 熔断限流后处理的方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> body</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> execution</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SentinelClientHttpResponse <span class="title">fallbackA</span><span class="params">(HttpRequest request,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                       <span class="keyword">byte</span>[] body, ClientHttpRequestExecution execution, BlockException ex)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;fallback: &quot;</span> + ex.getClass().getCanonicalName());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SentinelClientHttpResponse(<span class="string">&quot;custom fallback info&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>4、测试结果</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210909165412283.png" alt="image-20210909165412283"></p>
<h2 id="Feign整合Sentinel"><a href="#Feign整合Sentinel" class="headerlink" title="Feign整合Sentinel"></a>Feign整合Sentinel</h2><blockquote>
<p>1、开启sentinel对Feign的支持，默认关闭</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">feign.sentinel.enabled</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>2、Feign配置</p>
</blockquote>
<p>这里可以使用<code>fallback</code>或者<code>fallbackFactory</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(name = &quot;spring-cloud-alibaba-nacos-provider&quot;,</span></span><br><span class="line"><span class="meta">        fallback = EchoFeignServiceFallback.class,</span></span><br><span class="line"><span class="meta">//        fallbackFactory = EchoServiceFallbackFactory.class,</span></span><br><span class="line"><span class="meta">        configuration = EchoFeignConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EchoFeignService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/echo/&#123;str&#125;&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">echo</span><span class="params">(<span class="meta">@PathVariable(&quot;str&quot;)</span>String str)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/divide&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">divide</span><span class="params">(<span class="meta">@RequestParam(&quot;a&quot;)</span>Integer a,<span class="meta">@RequestParam(&quot;b&quot;)</span>Integer b)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * feign声明的接口可以有默认实现，就是可以不需要远程服务提供者实现，自己实现</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> a</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">divide</span><span class="params">(Integer a)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;consumer divide method.... &quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> divide(a,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/notFound&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">notFound</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>3、EchoFeignServiceFallback 配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoFeignServiceFallback</span> <span class="keyword">implements</span> <span class="title">EchoFeignService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;echo 方法降级了&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">divide</span><span class="params">(Integer a, Integer b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;divide 方法降级了&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">notFound</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;notFound 方法降级了&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>4、EchoServiceFallbackFactory配置</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServiceFallbackFactory</span> <span class="keyword">implements</span> <span class="title">FallbackFactory</span>&lt;<span class="title">EchoFeignService</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EchoFeignService <span class="title">create</span><span class="params">(Throwable throwable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EchoFeignService() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;echo fall back&quot;</span>+throwable.getMessage();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">divide</span><span class="params">(Integer a, Integer b)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;divide fall back&quot;</span>+throwable.getMessage();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">notFound</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;notFound fall back&quot;</span>+throwable.getMessage();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>5、测试</p>
</blockquote>
<p>添加限流规则后进行测试</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210909173921060.png" alt="image-20210909173921060"></p>
<h2 id="Sentinel持久化"><a href="#Sentinel持久化" class="headerlink" title="Sentinel持久化"></a>Sentinel持久化</h2><blockquote>
<p> 规则管理及推送</p>
</blockquote>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">推送方式</th>
<th>说明</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">原始模式</td>
<td>api将规则推送至客户端并直接更新到内<br/>存中，扩展写数据源(<code>WritableDataSource</code>)</td>
<td>简单，无需任何依赖</td>
<td>不保证一致性；规则保存在内存中，重启即消失，严重不建议用于生产环境</td>
</tr>
<tr>
<td style="text-align:center">pull模式</td>
<td>扩展写数据源(<code>WritableDateSource</code>)，<br/>客户端主动向某个规则管理中心定期轮询拉取规则，这个规则中心可以是RDBMS、文件等</td>
<td>简单，无任何依赖，规则持久化</td>
<td>不保证一致性；实时性不好找，拉取过于频繁也可能会有性能问题</td>
</tr>
<tr>
<td style="text-align:center">push模式</td>
<td>扩展读取数据源(<code>ReadableSource</code>)，规则中心统一推送，<br/>客户端通过往注册监听器的方式时刻监听变化，比如使用Nacos、zookeeper等配置中心，这种方式有更好的实时性和一致性保证，<code>生产环境下一般采用push模式</code></td>
<td>规则持久化，一致性，快速</td>
<td>引入第三方依赖</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>原理图</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210910135955645.png" alt="image-20210910135955645"></p>
<p>FileRefreshableDataSource定时从指定文件中读取规则json文件（本地文件），如果发现文件发送变化，就更新规则缓存；</p>
<p>FileWritableDataSource接收控制台规则推送，并根据配置，修改规则json文件（本地文件）；</p>
<h3 id="pull模式"><a href="#pull模式" class="headerlink" title="pull模式"></a>pull模式</h3><p><code>持久化到本地</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- sentinel-datasource-extension 数据源扩展--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-extension<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置代码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.july.springcloud.learn.sentinel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.command.handler.ModifyParamFlowRulesCommandHandler;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.datasource.*;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.init.InitFunc;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.authority.AuthorityRule;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.authority.AuthorityRuleManager;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.degrade.DegradeRule;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.degrade.DegradeRuleManager;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.FlowRule;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.FlowRuleManager;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRule;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.flow.param.ParamFlowRuleManager;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.system.SystemRule;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.system.SystemRuleManager;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.transport.util.WritableDataSourceRegistry;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.TypeReference;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * sentinel本地持久化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 规则持久化</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileDataSourceInit</span> <span class="keyword">implements</span> <span class="title">InitFunc</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//可以根据需要指定规则文件的位置</span></span><br><span class="line">        String ruleDir = System.getProperty(<span class="string">&quot;user.home&quot;</span>) + <span class="string">&quot;/sentinel/rules&quot;</span>;</span><br><span class="line">        <span class="comment">//流量规则</span></span><br><span class="line">        String flowRulePath = ruleDir + <span class="string">&quot;/flow-rule.json&quot;</span>;</span><br><span class="line">        <span class="comment">//降级规则</span></span><br><span class="line">        String degradeRulePath = ruleDir + <span class="string">&quot;/degrade-rule.json&quot;</span>;</span><br><span class="line">        <span class="comment">//参数规则</span></span><br><span class="line">        String paramFlowRulePath = ruleDir + <span class="string">&quot;/param-flow-rule.json&quot;</span>;</span><br><span class="line">        <span class="comment">//系统规则</span></span><br><span class="line">        String systemRulePath = ruleDir + <span class="string">&quot;/system-rule.json&quot;</span>;</span><br><span class="line">        <span class="comment">//授权规则</span></span><br><span class="line">        String authorityRulePath = ruleDir + <span class="string">&quot;/authority-rule.json&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.mkdirIfNotExits(ruleDir);</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">this</span>.createFileIfNotExits(flowRulePath);</span><br><span class="line">        <span class="keyword">this</span>.createFileIfNotExits(degradeRulePath);</span><br><span class="line">        <span class="keyword">this</span>.createFileIfNotExits(paramFlowRulePath);</span><br><span class="line">        <span class="keyword">this</span>.createFileIfNotExits(systemRulePath);</span><br><span class="line">        <span class="keyword">this</span>.createFileIfNotExits(authorityRulePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 流控规则：可读数据源</span></span><br><span class="line">        ReadableDataSource&lt;String, List&lt;FlowRule&gt;&gt; flowRuleRDS = <span class="keyword">new</span> FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                flowRulePath,</span><br><span class="line">                flowRuleListParser</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// 将可读数据源注册至FlowRuleManager</span></span><br><span class="line">        <span class="comment">// 这样当规则文件发生变化时，就会更新规则到内存</span></span><br><span class="line">        FlowRuleManager.register2Property(flowRuleRDS.getProperty());</span><br><span class="line">        <span class="comment">// 流控规则：可写数据源</span></span><br><span class="line">        WritableDataSource&lt;List&lt;FlowRule&gt;&gt; flowRuleWDS = <span class="keyword">new</span> FileWritableDataSource&lt;&gt;(</span><br><span class="line">                flowRulePath,</span><br><span class="line">                <span class="keyword">this</span>::encodeJson</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// 将可写数据源注册至transport模块的WritableDataSourceRegistry中</span></span><br><span class="line">        <span class="comment">// 这样收到控制台推送的规则时，Sentinel会先更新到内存，然后将规则写入到文件中</span></span><br><span class="line">        WritableDataSourceRegistry.registerFlowDataSource(flowRuleWDS);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 降级规则：可读数据源</span></span><br><span class="line">        ReadableDataSource&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleRDS = <span class="keyword">new</span> FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                degradeRulePath,</span><br><span class="line">                degradeRuleListParser</span><br><span class="line">        );</span><br><span class="line">        DegradeRuleManager.register2Property(degradeRuleRDS.getProperty());</span><br><span class="line">        <span class="comment">// 降级规则：可写数据源</span></span><br><span class="line">        WritableDataSource&lt;List&lt;DegradeRule&gt;&gt; degradeRuleWDS = <span class="keyword">new</span> FileWritableDataSource&lt;&gt;(</span><br><span class="line">                degradeRulePath,</span><br><span class="line">                <span class="keyword">this</span>::encodeJson</span><br><span class="line">        );</span><br><span class="line">        WritableDataSourceRegistry.registerDegradeDataSource(degradeRuleWDS);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 热点参数规则：可读数据源</span></span><br><span class="line">        ReadableDataSource&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleRDS = <span class="keyword">new</span> FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                paramFlowRulePath,</span><br><span class="line">                paramFlowRuleListParser</span><br><span class="line">        );</span><br><span class="line">        ParamFlowRuleManager.register2Property(paramFlowRuleRDS.getProperty());</span><br><span class="line">        <span class="comment">// 热点参数规则：可写数据源</span></span><br><span class="line">        WritableDataSource&lt;List&lt;ParamFlowRule&gt;&gt; paramFlowRuleWDS = <span class="keyword">new</span> FileWritableDataSource&lt;&gt;(</span><br><span class="line">                paramFlowRulePath,</span><br><span class="line">                <span class="keyword">this</span>::encodeJson</span><br><span class="line">        );</span><br><span class="line">        ModifyParamFlowRulesCommandHandler.setWritableDataSource(paramFlowRuleWDS);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 系统规则：可读数据源</span></span><br><span class="line">        ReadableDataSource&lt;String, List&lt;SystemRule&gt;&gt; systemRuleRDS = <span class="keyword">new</span> FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                systemRulePath,</span><br><span class="line">                systemRuleListParser</span><br><span class="line">        );</span><br><span class="line">        SystemRuleManager.register2Property(systemRuleRDS.getProperty());</span><br><span class="line">        <span class="comment">// 系统规则：可写数据源</span></span><br><span class="line">        WritableDataSource&lt;List&lt;SystemRule&gt;&gt; systemRuleWDS = <span class="keyword">new</span> FileWritableDataSource&lt;&gt;(</span><br><span class="line">                systemRulePath,</span><br><span class="line">                <span class="keyword">this</span>::encodeJson</span><br><span class="line">        );</span><br><span class="line">        WritableDataSourceRegistry.registerSystemDataSource(systemRuleWDS);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 授权规则：可读数据源</span></span><br><span class="line">        ReadableDataSource&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleRDS = <span class="keyword">new</span> FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">                authorityRulePath,</span><br><span class="line">                authorityRuleListParser</span><br><span class="line">        );</span><br><span class="line">        AuthorityRuleManager.register2Property(authorityRuleRDS.getProperty());</span><br><span class="line">        <span class="comment">// 授权规则：可写数据源</span></span><br><span class="line">        WritableDataSource&lt;List&lt;AuthorityRule&gt;&gt; authorityRuleWDS = <span class="keyword">new</span> FileWritableDataSource&lt;&gt;(</span><br><span class="line">                authorityRulePath,</span><br><span class="line">                <span class="keyword">this</span>::encodeJson</span><br><span class="line">        );</span><br><span class="line">        WritableDataSourceRegistry.registerAuthorityDataSource(authorityRuleWDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Converter&lt;String, List&lt;FlowRule&gt;&gt; flowRuleListParser = source -&gt; JSON.parseObject(</span><br><span class="line">            source,</span><br><span class="line">            <span class="keyword">new</span> TypeReference&lt;List&lt;FlowRule&gt;&gt;() &#123;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Converter&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleListParser = source -&gt; JSON.parseObject(</span><br><span class="line">            source,</span><br><span class="line">            <span class="keyword">new</span> TypeReference&lt;List&lt;DegradeRule&gt;&gt;() &#123;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Converter&lt;String, List&lt;SystemRule&gt;&gt; systemRuleListParser = source -&gt; JSON.parseObject(</span><br><span class="line">            source,</span><br><span class="line">            <span class="keyword">new</span> TypeReference&lt;List&lt;SystemRule&gt;&gt;() &#123;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Converter&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleListParser = source -&gt; JSON.parseObject(</span><br><span class="line">            source,</span><br><span class="line">            <span class="keyword">new</span> TypeReference&lt;List&lt;AuthorityRule&gt;&gt;() &#123;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Converter&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleListParser = source -&gt; JSON.parseObject(</span><br><span class="line">            source,</span><br><span class="line">            <span class="keyword">new</span> TypeReference&lt;List&lt;ParamFlowRule&gt;&gt;() &#123;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mkdirIfNotExits</span><span class="params">(String filePath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(filePath);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createFileIfNotExits</span><span class="params">(String filePath)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(filePath);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.createNewFile();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function">String <span class="title">encodeJson</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JSON.toJSONString(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在resources下创建</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210910174848747.png" alt="image-20210910174848747"></p>
<blockquote>
<p>测试</p>
</blockquote>
<p>在sentinel配置限流规则后，会在你规定的目录生成文件（本地）；</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210910175003106.png" alt="image-20210910175003106"></p>
<h3 id="push模式"><a href="#push模式" class="headerlink" title="push模式"></a>push模式</h3><blockquote>
<p>1、添加sentinel-datasource-nacos依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>2、 配置持久化数据源</p>
</blockquote>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="comment"># 基于nacos配置中心进行规则持久化</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">flow:</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">          	<span class="comment"># nacos 地址</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="number">111.231</span><span class="number">.207</span><span class="number">.228</span><span class="string">:8848</span></span><br><span class="line">            <span class="comment"># 配置文件名称（id）</span></span><br><span class="line">            <span class="attr">data-id:</span> <span class="string">$&#123;spring.application.name&#125;.json</span></span><br><span class="line">            <span class="comment"># 分组</span></span><br><span class="line">            <span class="attr">group-id:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">            <span class="comment"># 数据类型</span></span><br><span class="line">            <span class="attr">data-type:</span> <span class="string">json</span></span><br><span class="line">            <span class="comment"># 规则</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>3、在nacos添加配置</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210915163240921.png" alt="image-20210915163240921"></p>
<blockquote>
<p>4、发布</p>
</blockquote>
<p>发布之后sentinel对应的流控规则就会显示</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210915163322952.png" alt="image-20210915163322952"></p>
<p><code>目前在nacos里面改了配置文件是可以同步到缓存的，而在sentinel里改了是不能够同步到nacos的配置文件的;</code></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">七月</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.isfate.xyz/article/6dd28e9b.html">https://www.isfate.xyz/article/6dd28e9b.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.isfate.xyz" target="_blank">七之月</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></div><div class="post_share"><div class="social-share" data-image="http://api.mtyqx.cn/api/random.php?34" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.zhimg.com/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.zhimg.com/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/article/f3b61b38.html"><img class="prev-cover" src="http://api.mtyqx.cn/api/random.php?35" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring Cloud Alibaba学习-二</div></div></a></div><div class="next-post pull-right"><a href="/article/84b12bae.html"><img class="next-cover" src="http://api.mtyqx.cn/api/random.php?37" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring Cloud Netflix学习-二</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/article/1db87a14.html" title="Spring Cloud Netflix学习-一"><img class="cover" src="http://api.mtyqx.cn/api/random.php?36" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-08</div><div class="title">Spring Cloud Netflix学习-一</div></div></a></div><div><a href="/article/84b12bae.html" title="Spring Cloud Netflix学习-二"><img class="cover" src="http://api.mtyqx.cn/api/random.php?37" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Spring Cloud Netflix学习-二</div></div></a></div><div><a href="/article/f3b61b38.html" title="Spring Cloud Alibaba学习-二"><img class="cover" src="http://api.mtyqx.cn/api/random.php?35" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-04</div><div class="title">Spring Cloud Alibaba学习-二</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/my-zhb/CDN/blog/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">七月</div><div class="author-info__description">起心动念皆是因,当下所受皆是果</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:myiszhb@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=410808509" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS订阅"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">大家好我是七月，请多多关照！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nacos%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">1.</span> <span class="toc-text">Nacos注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E4%BE%9B%E8%80%85-%E6%B6%88%E8%B4%B9%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">提供者&#x2F;消费端配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">服务发现与负载均衡调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LoadBalancerClient%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">LoadBalancerClient调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RestTemplate%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.2.</span> <span class="toc-text">RestTemplate调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenFeign%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.3.</span> <span class="toc-text">OpenFeign调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DiscoveryClient%E8%B0%83%E7%94%A8"><span class="toc-number">1.2.4.</span> <span class="toc-text">DiscoveryClient调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos-%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%BC%93%E5%AD%98%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.</span> <span class="toc-text">Nacos 客户端缓存信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E5%88%86%E7%BB%84"><span class="toc-number">1.4.</span> <span class="toc-text">指定分组</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nacos-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">2.</span> <span class="toc-text">Nacos 配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83"><span class="toc-number">2.1.</span> <span class="toc-text">配置环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%8E%AF%E5%A2%83"><span class="toc-number">2.2.</span> <span class="toc-text">多环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.3.</span> <span class="toc-text">服务配置数据模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">2.4.</span> <span class="toc-text">Nacos持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E9%9B%86%E7%BE%A4"><span class="toc-number">2.5.</span> <span class="toc-text">Nacos集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%87%8D"><span class="toc-number">2.6.</span> <span class="toc-text">Nacos服务权重</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos%E9%9B%86%E7%BE%A4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">2.7.</span> <span class="toc-text">Nacos集群负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">2.8.</span> <span class="toc-text">命名空间负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ribbon%E6%87%92%E5%8A%A0%E8%BD%BD"><span class="toc-number">2.9.</span> <span class="toc-text">Ribbon懒加载</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sentinel"><span class="toc-number">3.</span> <span class="toc-text">Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFSentinel"><span class="toc-number">3.1.</span> <span class="toc-text">什么是Sentinel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel%E7%BB%84%E6%88%90"><span class="toc-number">3.2.</span> <span class="toc-text">Sentinel组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90Sentienl"><span class="toc-number">3.3.</span> <span class="toc-text">集成Sentienl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel%E9%99%90%E6%B5%81"><span class="toc-number">3.4.</span> <span class="toc-text">Sentinel限流</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.4.1.</span> <span class="toc-text">流控模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="toc-number">3.4.2.</span> <span class="toc-text">流控效果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QPS%E9%99%90%E6%B5%81-%E7%9B%B4%E6%8E%A5"><span class="toc-number">3.4.3.</span> <span class="toc-text">QPS限流(直接)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C"><span class="toc-number">3.4.4.</span> <span class="toc-text">自定义返回结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B7%B3%E8%BD%AC%E9%A1%B5%E9%9D%A2"><span class="toc-number">3.4.5.</span> <span class="toc-text">自定义跳转页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%BB%84%E9%99%90%E6%B5%81-%E7%9B%B4%E6%8E%A5"><span class="toc-number">3.4.6.</span> <span class="toc-text">线程组限流(直接)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.4.7.</span> <span class="toc-text">关联模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.4.8.</span> <span class="toc-text">链路模式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel%E7%86%94%E6%96%AD"><span class="toc-number">3.5.</span> <span class="toc-text">Sentinel熔断</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%8D%E7%BA%A7%E7%AD%96%E7%95%A5"><span class="toc-number">3.5.1.</span> <span class="toc-text">降级策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B"><span class="toc-number">3.5.2.</span> <span class="toc-text">慢调用比例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%AF%94"><span class="toc-number">3.5.3.</span> <span class="toc-text">异常比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="toc-number">3.5.4.</span> <span class="toc-text">异常数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="toc-number">3.6.</span> <span class="toc-text">热点规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">3.6.1.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99"><span class="toc-number">3.7.</span> <span class="toc-text">系统规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%88%E5%80%BC%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.7.1.</span> <span class="toc-text">阈值类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E6%8E%A7%E5%88%B6"><span class="toc-number">3.8.</span> <span class="toc-text">授权控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E4%B8%8ESentinel%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E8%AE%AF%E5%8E%9F%E7%90%86"><span class="toc-number">3.9.</span> <span class="toc-text">服务与Sentinel客户端通讯原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel%E4%B8%89%E7%A7%8D%E4%BF%9D%E6%8A%A4%E5%BA%94%E7%94%A8"><span class="toc-number">3.10.</span> <span class="toc-text">Sentinel三种保护应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RestTemplate%E6%95%B4%E5%90%88Sentinel"><span class="toc-number">3.11.</span> <span class="toc-text">RestTemplate整合Sentinel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign%E6%95%B4%E5%90%88Sentinel"><span class="toc-number">3.12.</span> <span class="toc-text">Feign整合Sentinel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">3.13.</span> <span class="toc-text">Sentinel持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pull%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.13.1.</span> <span class="toc-text">pull模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#push%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.13.2.</span> <span class="toc-text">push模式</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/article/a464cc4f.html" title="ubuntu开启root登录"><img src="https://cdn.jsdelivr.net/gh/wayne0926/myphoto/img/dbd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ubuntu开启root登录"/></a><div class="content"><a class="title" href="/article/a464cc4f.html" title="ubuntu开启root登录">ubuntu开启root登录</a><time datetime="2022-03-03T12:07:43.000Z" title="发表于 2022-03-03 20:07:43">2022-03-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/5cf35c25.html" title="Java中文汉字转拼音工具类"><img src="http://api.mtyqx.cn/api/random.php?28" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java中文汉字转拼音工具类"/></a><div class="content"><a class="title" href="/article/5cf35c25.html" title="Java中文汉字转拼音工具类">Java中文汉字转拼音工具类</a><time datetime="2021-12-09T05:34:00.000Z" title="发表于 2021-12-09 13:34:00">2021-12-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/5cf352a9.html" title="mybatis中sql语句调用Java代码"><img src="http://api.mtyqx.cn/api/random.php?27" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mybatis中sql语句调用Java代码"/></a><div class="content"><a class="title" href="/article/5cf352a9.html" title="mybatis中sql语句调用Java代码">mybatis中sql语句调用Java代码</a><time datetime="2021-12-07T03:21:00.000Z" title="发表于 2021-12-07 11:21:00">2021-12-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/2db9fece.html" title="rabbitmq学习(三)"><img src="http://api.mtyqx.cn/api/random.php?31" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rabbitmq学习(三)"/></a><div class="content"><a class="title" href="/article/2db9fece.html" title="rabbitmq学习(三)">rabbitmq学习(三)</a><time datetime="2021-08-06T11:20:27.000Z" title="发表于 2021-08-06 19:20:27">2021-08-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/534adee5.html" title="rabbitmq学习(二)"><img src="http://api.mtyqx.cn/api/random.php?30" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rabbitmq学习(二)"/></a><div class="content"><a class="title" href="/article/534adee5.html" title="rabbitmq学习(二)">rabbitmq学习(二)</a><time datetime="2021-08-06T11:03:10.000Z" title="发表于 2021-08-06 19:03:10">2021-08-06</time></div></div></div></div></div></div></main><footer id="footer" style="background: rgba(255,255,255,0)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 七月</div><div class="footer_custom_text"><p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://demo.jerryc.me/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://metroui.org.ua/index.html "><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a>&nbsp;<a target="_blank" href="https://beian.miit.gov.cn"><img src="https://img.shields.io/badge/%E8%9C%80ICP%E5%A4%87-2021030114%E5%8F%B7-e1d492?style=flat&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAdCAYAAAC9pNwMAAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+nhxg7wAACNlJREFUSInF1mmMVeUdx/Hv2e+5+519mJWBYQZkGxZZxLKJqBXGoLS1iXWrmihotFXaJiTWWlsbl6q1aetWd5u0VkKjNG4YEJSlOCibDLMwM8x679z9nnPP1jcVJUxf+7z6J8+LT37/Z4VvaQhfFS8+sBXbctCDGrVTKlBUH4mxAbI9Hfj0IJLsp6paJ5/tmn20N/D0wKDRMq9F/c3M2U1/V0vDfWMFh+tv/Ig1zYPMabDImPJ52OaXO87W580KggCiiOsJOJ6I3wcNFaaeNKxrt72f2fLGu4FpJ/sDQABRzD22fH7/Yze069vGc6mrDLNIJCDik10sxz2by3VdPM87xzkP9jwPTZFRVI1YUJKH+oy7n3tbvv/P2wW/UQxRWe6w4ZJRptYLHDoCuz8v5cP92XbI762O+h6UVWHnUFbPpU0fEb2A60mMJ7MUi9b/b7UgKhiZMaIxm8YLplLMDPz8hl/EH+rs8TNlUpFf32uyZJGLPDwCiTGUyTWodTN49eUCdz2YwXb9NNcObp1X98WDoufynzMVCEKGn27ayPTWBi5ad8P5iQUkJEnFLjqM9Z+hrVX0vfDe6K2dPRWsW2bwyp9EUifSJB84gdxrkR0eRgv1o/3I4fbbprJ6scqamzVO9pffec1S5ZWY2Nfz5qEy/FqOC2Y3s3j53HMSi18VRjFPwSwg+1RfVbl115vvJrsfej7UGIsYPPGgQ7JXoO+Xx5B3dHEomyJ9x1qiQozkr95h5937aFnVyouPlgJK+Ss7Fxz64OTSxSX+LHYxT2IsRW5kbGI4oHcR0jqoqTjV9se3I7/f8rS/ClS23GxSXhph6L5d9Akm7qqZhHWBQGUJ+CWGFzcg7e7m6D3/ZuW1Ea5YKdA3EojuONi813TqNi+YPYOKUhXDtCeGL26/hakLLiEcdsaHRkRAoLRc4fJrmhnekyF0apgZowWSwwkaa+rw3f8WA1GZZsPP5JEChX8dhZTN6iU6kAcs5s+dHd183SJ0VVKL57pfw6YdRQw23aeWTns47DPTALWlRTR7kMLew6hGgYqUhWXYFFUdPZ6lUBahLA8hVcOftckfi7No7VRAAQqsX1dybfvG1qwriM9mM5mJ4e4jO5Cc01dPqixbr8tWGBQUL4vjGigEEShi+xUmZ2RiR/sJ1pbS8NkgZrKAGw0TsgQsQyFaF/nfYTGprAlMFysbA1pI3mhkR6snhGsaymYGvPyFEb9IdbUE2AzFFTwpRqCtBY0wmdER+hZW4j63gcJj38V+/ErSUZXsYBfjIZHIRW0c2Z8BskCAqN+CbBJBFnyyKjR+Ez57nBxLqpfMUeSISElMBFz6x2Q6OxzWrYjyxWVzEewioU3LCS5vQY6nMUrLwNaxXvoQ59IloFSx54PPAZtQLExVZZDxsVE8J4dn6v4JYatgbSjk0owPw7RGH2ADMo88Z7L20ip8f7gC7fAo0q4+0rt7kEQDvaghVZbiPHUHcyeXcfLjT3jmpR7AYsnSScya3UR8bARVMck7Y/cB75/X6rDf3Fg2dw2jKZm5dXGm1LuAzO5DCo9v6aT0ibco5kzOvLOP+NGTFJtDpPYeZKijk/Rn3QxsfZV7txwhX7ABiZUXBsGvIvguQApNQQva9RMmTvZ2dpVUls+tX/UD7GN/Y8Ws05w6rQF+9vyzg1vZjbvMRJhXiRSU8DpTFFe0QE8S6SfPkOkZoktrB2oAhZWrwljxOPmchiSMYOWNoxNuruFU5vWeXdsojiUon345113dBBQBmTYlTimgdB8nfPo4WjaNFgN9OMEkJ02dnadVt5ki54Esqy+bzKJltVhSPbI3iN2zCyMTeXNCuG7Omm2Zok7PR2+R7jvD8ouruHhmCrB5jVZeYxLdrTP4sr4Vtd9g4MA4qc4c+6cu5NPamfw4P59t2WrA4YdXKkASf7SFivo6PDdEPmf1fRM++zp1bH/0r4I1dD1ODtOWaW4IsvPjL7nqXhloQiSPwjjgMYkMASyGEBkjhISCQwkwzve/18AbT+pk8pVY4UacQi9y+gyZ0eRAw4qHa89LXEx1LXMSPfhDJYRb59BtlLKg2WPT2l6qYl1svtGkrLYckyA1S+t5+2ATm37WCui0LSynsckDNH5zTxAchbQtkx08hDHYiW6NgC0enHBzEZ102UDH8QORdEckjEzZrNWkRydzyx17uGnDXqbUnGZ6dRPjSY91q2TqwjFuvTxLo5Zn5Qo/pumRSFcTLQtybEhGE0fQrDhhJ0VvH2lTnnHPhGtsmWan469apERjI2MH3qN7+7MEfH6ql29CbV7PvsMG32k6yU2XDhEKyZw66eJaRdrXR7CzCcqUNC3zwgymPJRCH4KRRLINimpL14A5Y4GDeOqbsPRVcfuN7Xj44pav/hFfrNT2kr2rsqf2Ibp5pEA14ZIImUyW3t5REkkTXRGQ/DGGhtLginhqCWknQDE5hKf5UFSF9Lj020Q2ul5V1AR2hr+8vuP8Vlc2zMPRxoSjnx7XBC14sDoydahSGq7KdO/HFyrBchxCVfX4fDKp4T7SCQejYODZLrYgIqgKFsNIgQqEYob8mW6yiUyb7Z64LVK/+B85xznnJ3AWzqTzuIX46mr5wLs+UUTyIriBCjRNxguHMJIFDLEEvXEOVRWnSJ0+jCd4CJoGjoedM1CLcXQziW3nMV2TSMBeOx7vWZvPt1r+cMPzE8KunaUkFn0vNrvtqXj34c1W6gzxlEQ6naIoBahtnkMwoFMwIVzSRNguMt53Aj2s4nkSlgPoGqLkICsRNF0gl8rYWuP8+11/w/OOJDEhHPKLCIpOXmi+M9AgP+maiesLifF2T1Rn5ZNj5Lo/Qc/GcPMmhdoqlEgIGzCK4PiCmJKK68p4KfF3qYGuF0qCRUkJTzleUbvQyWRTuE5xYthxQbBs7EISAbkzUFG3VfXXbK2YFi3X/eryfKKnqVBItNjJxDzH8erddC4SqWwcN5WyTtlyO1RP/Lh3eHD76MB40swmiDVJyDLYRhpc5+ub6tse/wWKbvSQEAw1awAAAABJRU5ErkJggg==" title="本站已在工信部备案，备案号蜀ICP备2021030114号"></a>&nbsp;</p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})
setTimeout(function(){preloader.endLoading();}, 3000);</script></div><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-tan.vercel.app',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'https://twikoo-tan.vercel.app',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://unpkg.zhimg.com/twikoo@1.4.15/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script data-pjax defer src="/js/custom/fixed_card_widget.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '700ms');
    arr[i].setAttribute('data-wow-delay', '700ms');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://unpkg.zhimg.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://unpkg.zhimg.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --></body></html>