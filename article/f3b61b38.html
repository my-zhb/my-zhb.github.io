<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spring Cloud Alibaba学习-二 | 七月のBlog</title><meta name="keywords" content="微服务"><meta name="author" content="七月"><meta name="copyright" content="七月"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="微服务">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud Alibaba学习-二">
<meta property="og:url" content="https://www.isfate.xyz/article/f3b61b38.html">
<meta property="og:site_name" content="七月のBlog">
<meta property="og:description" content="微服务">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://api.mtyqx.cn/api/random.php?35">
<meta property="article:published_time" content="2021-07-04T02:30:36.000Z">
<meta property="article:modified_time" content="2022-02-07T12:05:26.922Z">
<meta property="article:author" content="七月">
<meta property="article:tag" content="微服务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://api.mtyqx.cn/api/random.php?35"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://www.isfate.xyz/article/f3b61b38"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.zhimg.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?666c7691895360baeecc42f2ba8ba136";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();

const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://unpkg.zhimg.com/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://unpkg.zhimg.com/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://unpkg.zhimg.com/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://unpkg.zhimg.com/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://unpkg.zhimg.com/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Spring Cloud Alibaba学习-二',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-07 20:05:26'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/myiszhb/myiszhb.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="七月のBlog" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/my-zhb/CDN/blog/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('http://api.mtyqx.cn/api/random.php?35')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">七月のBlog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Spring Cloud Alibaba学习-二</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-07-04T02:30:36.000Z" title="发表于 2021-07-04 10:30:36">2021-07-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-07T12:05:26.922Z" title="更新于 2022-02-07 20:05:26">2022-02-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/">java</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">16.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>72分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Spring Cloud Alibaba学习-二"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h1><p>(非alibaba)spring cloud gateway提供一种简单而有效的方法来路由到API，并为他们提供跨领域的关注，例如：安全性、监控/度量和弹性；能够匹配任何请求属性上的路由、谓词和过滤器特定于路由、Hystrix断路器集成、spring cloud DiscoveryClient（服务发现）集成、请求速率限制、路径改写等等；</p>
<h2 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h2><blockquote>
<p>1、加入依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- spring boot actuator 监控依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- nacos 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- spring cloud alibaba sentinel 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- spring-cloud-starter-gateway 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>2、配置</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># spring boot actuator 可以通过端点查看spring boot运行情况</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">jmx:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">health:</span></span><br><span class="line">      <span class="attr">show-details:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">health:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务名称</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-service-gateway</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 网关配置</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="comment"># 启动discoveryClient 网关集成,可以实现服务的发现</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 配置网关路由转发规则</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">          <span class="comment"># id唯一</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="comment"># lb:// 固定写法，表示负载均衡</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="comment"># 谓词：判断是否匹配</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/test,</span> <span class="string">/index</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 服务注册发现nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">111.231</span><span class="number">.207</span><span class="number">.228</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">2020Fate!</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># sentinel 管理后台</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">eager:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>3、测试</p>
</blockquote>
<p>访问<code>127.0.0.1/test?number=1</code>，就能访问到了</p>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p>1、<code>路由</code>：网关的基本构件组成，它由<code>ID</code>、<code>目标url</code>、<code>谓词集合</code>和<code>过滤集合</code>组成，如果聚合谓词为true，则匹配路由；</p>
<p>2、<code>谓词</code>：这是Java8函数谓词，输入类型是Spring Framework ServerWebExchange，这个使用你可以匹配的HTTP请求中所有内容，例如标头或参数；</p>
<p>3、<code>过滤器</code>：这些是使用特定工厂构造的Spring Framework ServerWebExchange实例，这里你可以在发送下游请求之前或之后修改请求的响应；</p>
<h2 id="GateWay如何工作"><a href="#GateWay如何工作" class="headerlink" title="GateWay如何工作"></a>GateWay如何工作</h2><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210915173458996.png" alt="image-20210915173458996"></p>
<p>客户端向Spring Cloud GateWay发出请求，如果网关处理程序映射确定请求于路由匹配，则将其发送到网关web处理程序，该处理程序通过特定于请求的过滤器运行请求，筛选器又虚线分隔的原因是，筛选器可以在发送代理请求之前和之后运行逻辑，所有<code>前置</code>过过滤器逻辑均被执行，然后发出代理请求，发出代理请求后，将运行后过滤器逻辑，在没有端口的路由中定义url、http和https url的默认端口值分别为80和443；</p>
<h2 id="谓词工厂"><a href="#谓词工厂" class="headerlink" title="谓词工厂"></a>谓词工厂</h2><p>总共有11个路由谓词工厂</p>
<h3 id="After"><a href="#After" class="headerlink" title="After"></a>After</h3><p>After route谓词工厂采用一个参数，即datetime（这是一个Java ZonedDateTime）</p>
<p>该谓词匹配在指定日期时间之后发生的请求；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">After=2021-09-15T17:55:55.789+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>
<p>这个路由表示2021年9月15日17:55:55之后可以访问；</p>
<p>这个时间可以通过<code>System.out.println(ZonedDateTime.now())</code>获取</p>
<h3 id="Before"><a href="#Before" class="headerlink" title="Before"></a>Before</h3><p>Before 路由谓词工厂采用一个参数，即datetime（这是一个Java ZonedDateTime）</p>
<p>该谓词匹配在指定日期时间之前发生的请求</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Before=2021-09-15T17:55:55.789+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>
<p>这个表示2021年9月15日17:55:55之前可以访问；</p>
<h3 id="Between"><a href="#Between" class="headerlink" title="Between"></a>Between</h3><p>Between  路由谓词工厂采用二个参数，即datetime（这是一个Java ZonedDateTime）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Between=2021-09-15T17:55:55.789+08:00[Asia/Shanghai]，2021-09-16T17:55:55.789+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>
<p>这个路由表示在2021年9月15日17:55:55之后到2021-09-16T17:55:55之前可以访问；（区间）</p>
<h3 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h3><p>cookie路由谓词工厂采用两个参数，即cookie名称和一个regexp（这是Java正则表达式），该谓词匹配具有给定名称且其值与正则表达式匹配的cookie;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Cookie=tokent，123456</span></span><br></pre></td></tr></table></figure>
<p>测试访问<code>curl 127.0.0.1/test --cookie token=123456</code></p>
<p>如果请求地址后面不带<code>--cookie token=123456</code>是无法访问的；</p>
<h3 id="header"><a href="#header" class="headerlink" title="header"></a>header</h3><p>header 路由谓词工厂使用两个参数，header名称和一个regexp（这是Java正则表达式），该谓词匹配具有给定名称且其值与正则表达式匹配的header ;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Header=X-Request-d，\d+</span></span><br></pre></td></tr></table></figure>
<p>如果请求具有名为X-Request-d的标头，且其值与\d+正则表达式匹配（其值为一个或者多个数字），则匹配路由；</p>
<p>测试访问 <code>curl 127.0.0.1/test --header ”X-Request-d:12345“</code></p>
<h3 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h3><p>host路由谓词工厂使用一个参数：主机名模式列表。该模式是带有Ant样式的模式，作为分隔符，该谓词与匹配模式的host标头匹配；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Host=**.myiszhb.org</span></span><br></pre></td></tr></table></figure>
<p>还支持url模板表里（例如{sub}.myiszhb.org）,如果请求的主机标头的值为**.myiszhb.org，则此路由匹配；</p>
<h3 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h3><p>方法路由谓词工厂使用一个参数或多个参数，要匹配的http方法；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET,POST</span></span><br></pre></td></tr></table></figure>
<p>如果请求的方法是get或post，则匹配此路由；</p>
<h3 id="Path"><a href="#Path" class="headerlink" title="Path"></a>Path</h3><p>路径路由谓词工厂使用两个参数：Spring PathMatcher模式列表和一个成为matchOptionalTrailingSeparator的可选表示；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/test/&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果请求路由为：<code>/test/1</code>或者<code>/test/2</code>等，都可以匹配此路由；</p>
<h3 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h3><p>查询路由谓词工厂采用两个参数：必需的参数和可选的regexp（这是Java正则表达式）；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Query=token</span></span><br></pre></td></tr></table></figure>
<p>请求参数带上token就可以访问了，例如<code>http://127.0.0.1:18083/test?token</code></p>
<h3 id="RemoteAddr"><a href="#RemoteAddr" class="headerlink" title="RemoteAddr"></a>RemoteAddr</h3><p>RemoteAddr 路由谓词工厂使用源列表（最小大小为1），这些源CIDR标记（ipv4或ipv6）字符串，例如192.168.0.1/16（其中192.168.0.1是ip地址，而16是子网掩码）;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">RemoteAddr=192.168.1.1/24</span></span><br></pre></td></tr></table></figure>
<p>如果请求的远程地址例如：192.168.1.10，则是匹配该路由的；</p>
<h3 id="Weight"><a href="#Weight" class="headerlink" title="Weight"></a>Weight</h3><p>weight 权重路由谓词工厂采用两个参数：group和weight（一个int），权重是按组计算的；</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">https://springcloud-service-nacos-consumer1</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group1，8</span></span><br><span class="line">		        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">uri:</span> <span class="string">https://springcloud-service-nacos-consumer2</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Weight=group1，2</span></span><br></pre></td></tr></table></figure>
<p>这条路由会将约80%的流量转到consumer1，并将约20%的流量转到consumer2；</p>
<h2 id="过滤工厂"><a href="#过滤工厂" class="headerlink" title="过滤工厂"></a>过滤工厂</h2><p>总共31一个过滤器工厂，详情查看<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-addrequestheader-gatewayfilter-factory">官方文档</a></p>
<h2 id="自定义谓词"><a href="#自定义谓词" class="headerlink" title="自定义谓词"></a>自定义谓词</h2><p>Spring Cloud GateWay内置了一些列的路由谓词工厂，但是如果这些内置的路由谓词工厂不能满足业务需求的话，可以自定义路由谓词工厂来实现特定的需求；</p>
<p>例如：</p>
<p>1、要求请求必须携带一个token，并且token值等于指定的值，才能访问；</p>
<p>2、要求某个服务的用户只允许在23:00-6:00这个时间段内才可以访问；</p>
<p>具体步骤：</p>
<p>1、首先定义一个配置类，用于承载配置参数；</p>
<p>2、定义一个路由谓词工厂；</p>
<p>3、在配置文件中启动该路由谓词工厂；</p>
<h3 id="案例1：实践"><a href="#案例1：实践" class="headerlink" title="案例1：实践"></a>案例1：实践</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>自定义谓词工厂TokenRoutePredicateFactory</code></p>
<p>注意：Token+RoutePredicateFactory，此处<code>TokenRoutePredicateFactory</code>是固定写法，前面的写的<code>Token</code>，后面在配置文件也要写Token；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义谓词工厂</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenRoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title">AbstractRoutePredicateFactory</span>&lt;<span class="title">TokenConfig</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TokenRoutePredicateFactory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(TokenConfig.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(TokenConfig config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exchange -&gt; &#123;</span><br><span class="line">            <span class="comment">//获取查询参数</span></span><br><span class="line">            MultiValueMap&lt;String, String&gt; valueMap = exchange.getRequest().getQueryParams();</span><br><span class="line">            <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">            List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="comment">//获取所有的值</span></span><br><span class="line">            valueMap.forEach((k,v)-&gt;&#123;</span><br><span class="line">                list.addAll(v);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">for</span> (String value : list) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;Token - &gt; &#123;&#125;&quot;</span>,value);</span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="keyword">if</span>(StringUtils.equalsAnyIgnoreCase(value,config.getToken()))&#123;</span><br><span class="line">                    flag = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> flag;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取配置文件中的token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">shortcutFieldOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singletonList(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>配置</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 网关配置</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">          <span class="comment"># id唯一</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="comment"># lb:// 固定写法，表示负载均衡</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="comment"># 谓词：判断是否匹配</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">          	<span class="comment"># Token 就是上面文件名称的前半部分</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Token=123456</span></span><br></pre></td></tr></table></figure>
<p>测试，带了token=123456的就可以访问，其他一概返回404</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210916170742477.png" alt="image-20210916170742477"></p>
<h3 id="案例2：实践"><a href="#案例2：实践" class="headerlink" title="案例2：实践"></a>案例2：实践</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessTimeConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LocalTime start;</span><br><span class="line">    <span class="keyword">private</span> LocalTime end;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>自定义谓词工厂</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessTimeRoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title">AbstractRoutePredicateFactory</span>&lt;<span class="title">AccessTimeConfig</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccessTimeRoutePredicateFactory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(AccessTimeConfig.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(AccessTimeConfig config)</span> </span>&#123;</span><br><span class="line">        LocalTime start = config.getStart();</span><br><span class="line">        LocalTime end = config.getEnd();</span><br><span class="line">        <span class="keyword">return</span> (serverWebExchange) -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">&quot;AccessTime -&gt; &quot;</span> + LocalTime.now().toString());</span><br><span class="line">            LocalTime now = LocalTime.now();</span><br><span class="line">            <span class="comment">//判断当前时间是在配置的开始时间和结束时间之间</span></span><br><span class="line">            <span class="keyword">return</span> now.isAfter(start) &amp;&amp; now.isBefore(end);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">shortcutFieldOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">&quot;start&quot;</span>,<span class="string">&quot;end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>配置</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">          <span class="comment"># id唯一</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">route1</span></span><br><span class="line">          <span class="comment"># lb:// 固定写法，表示负载均衡</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://springcloud-service-nacos-consumer</span></span><br><span class="line">          <span class="comment"># 谓词：判断是否匹配</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">AccessTime=上午9:00,下午5:15</span></span><br></pre></td></tr></table></figure>
<p>测试结果：只要在这个时间段的请求都可以访问；</p>
<h3 id="谓词不匹配自定义返回"><a href="#谓词不匹配自定义返回" class="headerlink" title="谓词不匹配自定义返回"></a>谓词不匹配自定义返回</h3><p>不知道有返回他会返回404页面</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924143857050.png" alt="image-20210924143857050"></p>
<p>返回这个404的页面，是在<code>DefaultErrorWebExceptionHandler</code>里面，我们需要覆盖他的方法</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924144617313.png" alt="image-20210924144617313"></p>
<p>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyErrorWebExceptionHandler</span> <span class="keyword">extends</span> <span class="title">DefaultErrorWebExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyErrorWebExceptionHandler</span><span class="params">(ErrorAttributes errorAttributes, ResourceProperties resourceProperties, ErrorProperties errorProperties, ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(errorAttributes, resourceProperties, errorProperties, applicationContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定响应处理方法为json处理的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> errorAttributes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> RouterFunction&lt;ServerResponse&gt; <span class="title">getRoutingFunction</span><span class="params">(ErrorAttributes errorAttributes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RouterFunctions.route(RequestPredicates.all(), <span class="keyword">this</span>::renderErrorResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据code获取对应的httpstatus</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> errorAttributes</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getHttpStatus</span><span class="params">(Map&lt;String, Object&gt; errorAttributes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getHttpStatus(errorAttributes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建异常信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">buildMessage</span><span class="params">(ServerRequest request,Throwable ex)</span></span>&#123;</span><br><span class="line">        StringBuilder message = <span class="keyword">new</span> StringBuilder(<span class="string">&quot;Failed to handler request [&quot;</span>);</span><br><span class="line">        message.append(request.methodName());</span><br><span class="line">        message.append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        message.append(request.uri());</span><br><span class="line">        message.append(<span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>( ex != <span class="keyword">null</span>)&#123;</span><br><span class="line">            message.append(<span class="string">&quot;: &quot;</span>);</span><br><span class="line">            message.append(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> message.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构建返回的json数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status 状态码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> errorMsg 信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String,Object&gt; <span class="title">response</span><span class="params">(<span class="keyword">int</span> status,String errorMsg)</span></span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;code&quot;</span>,status);</span><br><span class="line">        map.put(<span class="string">&quot;msg&quot;</span>,errorMsg);</span><br><span class="line">        map.put(<span class="string">&quot;data&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义配置类，使<code>MyErrorWebExceptionHandler</code>生效</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerProperties serverProperties;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourceProperties resourceProperties;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ViewResolver&gt; viewResolvers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerCodecConfigurer serverCodecConfigurer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GatewayConfiguration</span><span class="params">(ServerProperties serverProperties,</span></span></span><br><span class="line"><span class="params"><span class="function">                                ApplicationContext applicationContext,</span></span></span><br><span class="line"><span class="params"><span class="function">                                ResourceProperties resourceProperties,</span></span></span><br><span class="line"><span class="params"><span class="function">                                ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; listObjectProvider,</span></span></span><br><span class="line"><span class="params"><span class="function">                                ServerCodecConfigurer serverCodecConfigurer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serverProperties = serverProperties;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">        <span class="keyword">this</span>.resourceProperties = resourceProperties;</span><br><span class="line">        <span class="keyword">this</span>.viewResolvers = listObjectProvider.getIfAvailable(Collections::emptyList);</span><br><span class="line">        <span class="keyword">this</span>.serverCodecConfigurer = serverCodecConfigurer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&quot;myeErrorWebExceptionHandler&quot;)</span></span><br><span class="line">    <span class="meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span><span class="comment">//bean的顺序</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ErrorWebExceptionHandler <span class="title">myeErrorWebExceptionHandler</span><span class="params">(ErrorAttributes errorAttributes)</span></span>&#123;</span><br><span class="line">        MyErrorWebExceptionHandler myErrorWebExceptionHandler =  <span class="keyword">new</span> MyErrorWebExceptionHandler(</span><br><span class="line">                errorAttributes,</span><br><span class="line">                <span class="keyword">this</span>.resourceProperties,</span><br><span class="line">                <span class="keyword">this</span>.serverProperties.getError(),</span><br><span class="line">                <span class="keyword">this</span>.applicationContext</span><br><span class="line">        );</span><br><span class="line">        myErrorWebExceptionHandler.setViewResolvers(<span class="keyword">this</span>.viewResolvers);</span><br><span class="line">        myErrorWebExceptionHandler.setMessageWriters(<span class="keyword">this</span>.serverCodecConfigurer.getWriters());</span><br><span class="line">        myErrorWebExceptionHandler.setMessageReaders(<span class="keyword">this</span>.serverCodecConfigurer.getReaders());</span><br><span class="line">        <span class="keyword">return</span> myErrorWebExceptionHandler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="自定义网关过滤器"><a href="#自定义网关过滤器" class="headerlink" title="自定义网关过滤器"></a>自定义网关过滤器</h2><h3 id="单个网关过滤器"><a href="#单个网关过滤器" class="headerlink" title="单个网关过滤器"></a>单个网关过滤器</h3><p>顶层接口<code>GatewayFilterFactory</code>，通常情况下可以继承<code>AbstractGatewayFilterFactory</code>实现自定义网关过滤器；或者继承<code>AbstractNameValueGatewayFilterFactory</code>，该方式配置方法更简单；</p>
<p>其中<code>RequestLog+GatewayFilterFactory</code>，后半部分是固定的；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestLogGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractNameValueGatewayFilterFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(NameValueConfig config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (ServerWebExchange exchang, GatewayFilterChain chain)-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">&quot;请求网关-&#123;&#125;-&#123;&#125;&quot;</span>,config.getName(),config.getValue());</span><br><span class="line">            MultiValueMap&lt;String, String&gt; valueMap = exchang.getRequest().getQueryParams();</span><br><span class="line">            valueMap.forEach((k,v)-&gt;&#123;</span><br><span class="line">                log.info(<span class="string">&quot;请求参数-&#123;&#125;&quot;</span>,k);</span><br><span class="line">                v.forEach(s-&gt;&#123;</span><br><span class="line">                    log.info(<span class="string">&quot;请求参数值=&#123;&#125;&quot;</span>,s);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchang).then();</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924151833874.png" alt="image-20210924151833874"></p>
<h3 id="全局网关过滤器"><a href="#全局网关过滤器" class="headerlink" title="全局网关过滤器"></a>全局网关过滤器</h3><p>自带的全局过滤器，只要满足规则就会进入这些实现类中的<code>filter</code>方法，而且全局过滤器有执行顺序的问题，这些实现类中有个<code>getOrder</code>方法，数值越小越先执行；</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924152602387.png" alt="image-20210924152602387"></p>
<p>自定义全局filter，不需要再在配置文件里面写了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义全局过滤器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomGlobalFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//处理过滤逻辑</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;进去了全局Filter请求...........&quot;</span>);</span><br><span class="line">        MultiValueMap&lt;String, String&gt; valueMap = exchange.getRequest().getQueryParams();</span><br><span class="line">        valueMap.forEach((k,v)-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">&quot;全局filter拦截参数：&#123;&#125;&quot;</span>,k);</span><br><span class="line">            v.forEach(s-&gt;&#123;</span><br><span class="line">                log.info(<span class="string">&quot;全局filter拦截参数值：&#123;&#125;&quot;</span>,v);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置优先级</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924153449114.png" alt="image-20210924153449114"></p>
<h2 id="集成ribbon负载均衡"><a href="#集成ribbon负载均衡" class="headerlink" title="集成ribbon负载均衡"></a>集成ribbon负载均衡</h2><p>gateway内部帮我们已经集成了负载均衡，在全局Filter里面，有一个实现类叫<code>LoadBalancerClientFilter</code>，在里面进行的拦截</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924152602387.png" alt="image-20210924152602387"></p>
<p>其中他引入<code>LoadBalancerClient</code>这个接口</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924155113085.png" alt="image-20210924155113085"></p>
<p>他就是用ribbon 实现的</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924155301012.png" alt="image-20210924155301012"></p>
<h2 id="网关集成sentienl"><a href="#网关集成sentienl" class="headerlink" title="网关集成sentienl"></a>网关集成sentienl</h2><h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><blockquote>
<p>1.依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- gateway 整合sentienl适配器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-spring-cloud-gateway-adapter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>2.配置连接到sentienl dashborad</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line"> 	<span class="comment"># sentinel 管理后台</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">eager:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8080</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>3.把<code>SentinelGatewayFilter</code>加入到容器</p>
</blockquote>
<p>默认情况下他是不会进入<code>SentinelGatewayFilter</code>的，需要我们自己去手动加入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Order(-1)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">sentinelGatewayFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SentinelGatewayFilter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问接口 查看结果</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924161525483.png" alt="image-20210924161525483"></p>
<p>我们就能拿到这个路由id，然后进行限流操作；</p>
<h3 id="自定义错误页面"><a href="#自定义错误页面" class="headerlink" title="自定义错误页面"></a>自定义错误页面</h3><p>默认情况下，会在浏览器返回如下结果</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924161907068.png" alt="image-20210924161907068"></p>
<p>这个返回错误的来源是<code>sentinel-spring-cloud-gateway-adapter</code>这个适配器下面的<code>BlockRequestHandler</code>的实现类<code>DefaultBlockRequestHandler</code></p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924162311145.png" alt="image-20210924162311145"></p>
<p>自定义<code>myBlockRequestHandler</code>返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * gateway配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SentinelGatewayBlockExceptionHandler <span class="title">sentinelGatewayBlockExceptionHandler</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义错误返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;myBlockRequestHandler&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BlockRequestHandler <span class="title">myBlockRequestHandler</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BlockRequestHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">handleRequest</span><span class="params">(ServerWebExchange serverWebExchange, Throwable throwable)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> ServerResponse.status(HttpStatus.BAD_GATEWAY)<span class="comment">//设置状态码</span></span><br><span class="line">                        .contentType(MediaType.APPLICATION_JSON)<span class="comment">//设置返回类型</span></span><br><span class="line">                        .body(BodyInserters.fromValue(<span class="string">&quot;自定义的返回 哈哈！！&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>因为在GatewayCallbackManager中 blockHandle是写死的，所以我们要调用他提供的setBlockHandler去修改他</code></p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924174805496.png" alt="image-20210924174805496"></p>
<p>修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * gateway配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SentinelGatewayBlockExceptionHandler <span class="title">sentinelGatewayBlockExceptionHandler</span><span class="params">(BlockRequestHandler blockRequestHandler)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//把默认的返回 替换成 我们自己写的，这里spring回去获取</span></span><br><span class="line">        GatewayCallbackManager.setBlockHandler(blockRequestHandler);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SentinelGatewayBlockExceptionHandler(viewResolvers,serverCodecConfigurer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SentinelGatewayBlockExceptionHandler</code>调用了<code>handleBlockedRequest</code>去设置</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924175136827.png" alt="image-20210924175136827"></p>
<p>测试结果：</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210924180108503.png" alt="image-20210924180108503"></p>
<h3 id="持久化本地文件"><a href="#持久化本地文件" class="headerlink" title="持久化本地文件"></a>持久化本地文件</h3><p><code>同上方3.13.1 pull模式一样</code></p>
<h3 id="持久化到Nacos"><a href="#持久化到Nacos" class="headerlink" title="持久化到Nacos"></a>持久化到Nacos</h3><p><code>同上方3.13.2 push模式</code>一样</p>
<h2 id="CORS跨域问题"><a href="#CORS跨域问题" class="headerlink" title="CORS跨域问题"></a>CORS跨域问题</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsWebFilter <span class="title">corsWebFilter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        CorsConfiguration corsConfiguration = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">        <span class="comment">//所有方法如post、get、put等</span></span><br><span class="line">        corsConfiguration.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//来自那个域名的请求</span></span><br><span class="line">        corsConfiguration.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="comment">//是什么请求头</span></span><br><span class="line">        corsConfiguration.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>,corsConfiguration);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CorsWebFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="内部执行流程"><a href="#内部执行流程" class="headerlink" title="内部执行流程"></a>内部执行流程</h2><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210926171025666.png" alt="image-20210926171025666"></p>
<p>1、在<code>spring-cloud-gateway-core：spring.factories</code>里面有一些自动装载类；</p>
<p>其中<code>GatewayClassPathWarningAutoConfiguration</code>检查前端控制器，进行检查，并报出警告；</p>
<p>2、<code>GatewayAutoConfiguration</code>是主要的网关自动配置，在这个类中就有路径的处理<code>routePredicateHandlerMapping</code>方法，</p>
<p>3、在容器中创建了<code>RoutePredicateHandlerMapping</code>这个对象，并且通过<code>RoutePredicateHandlerMapping.getHandlerInternal(..)</code>获取<code>Route对象</code>，在把</p>
<p><code>url</code>和<code>gatewayFilter</code>进行绑定；</p>
<p>4、 然后把<code>Route</code>放入<code>ServerWebExchange</code>的属性中，最后走到<code>FilteringWebHandler</code>;</p>
<h1 id="SkyWalking"><a href="#SkyWalking" class="headerlink" title="SkyWalking"></a>SkyWalking</h1><h2 id="什么是SkyWalking"><a href="#什么是SkyWalking" class="headerlink" title="什么是SkyWalking"></a>什么是SkyWalking</h2><p>(aapache旗下)分布式链路是分布式系统的应用程序性能监视工具，为微服务、云原生j架构和基于容器（docker、k8s）架构而设计；skywalking提供了分布式追踪、服务网格遥测分析、度量聚合和可视化一体化解决方案；</p>
<h2 id="主要功能特性"><a href="#主要功能特性" class="headerlink" title="主要功能特性"></a>主要功能特性</h2><p>1、多种监控手段，可以通过语言探针和service mesh获得监控的数据；</p>
<p>2、多种语言自动探针，包含Java、.net Core和Node.js;</p>
<p>3、轻量高效，占用服务器资源；</p>
<p>4、模块化，UI、存储、集群管理都有很多种机制选择；</p>
<p>5、支持告警；</p>
<p>5、有可视化解决方案；</p>
<h2 id="整体构成"><a href="#整体构成" class="headerlink" title="整体构成"></a>整体构成</h2><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210926174713637.png" alt="image-20210926174713637"></p>
<p>主要分为四大部分：</p>
<p>1、<code>Tracing</code>和<code>Metrics</code>为Agent：负责从应用中，收集链路信息，发生给SkyWalking Observability Analysis Platform服务器；</p>
<p>2、<code>SkyWalking Observability Analysis Platform</code>：负责接收Agent发送的<code>Tracing</code>数据信息，然后进行分析（Analysis Core），存储到外部存储器（Storage），最终提供查询（Query）功能；</p>
<p>3、<code>Storage Implementors</code>：<code>Tracing</code>数据存储，目前支持ES、MYSQL、Sharding Sphere、TiDB、H2多种存储器，默认情况下存储H2，建议存储到ES中；</p>
<p>4、<code>Skywalking UI</code>：负责提供控台，查看链路等等；</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>1、 <a target="_blank" rel="noopener" href="https://skywalking.apache.org/downloads/">apache-skywalking-apm-8.7.0.tar.gz</a></p>
<p>2、组成目录</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210927152100070.png" alt="image-20210927152100070"></p>
<p><code>agent</code>：SkyWalking Agent</p>
<p><code>bin</code>：执行脚本</p>
<p><code>config</code>：SkyWalking OAP Server 配置文件</p>
<p><code>oap-libs</code>：SkyWalking OAP Server </p>
<p><code>webapp</code>：SkyWalking UI</p>
<p>3、进入bin目录启动即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./startup.sh</span><br></pre></td></tr></table></figure>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210927152905092.png" alt="image-20210927152905092"></p>
<h2 id="链路追踪"><a href="#链路追踪" class="headerlink" title="链路追踪"></a>链路追踪</h2><p>1、将写好的spring boot项目打包；</p>
<p>2、由于上传数据是异步的，需要等待几秒才能看到跟踪数据；</p>
<h3 id="idea本地调试"><a href="#idea本地调试" class="headerlink" title="idea本地调试"></a>idea本地调试</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210927170053093.png" alt="image-20210927170053093"></p>
<p>参数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">参数1：skywalking-agent.jar架包的路径</span></span><br><span class="line">-javaagent:E:\Learn\apache-skywalking-apm-bin\agent\skywalking-agent.jar</span><br><span class="line"><span class="meta">#</span><span class="bash">参数：127.0.0.1:11800为collector服务，SW_AGENT_NAME 自定义名称</span></span><br><span class="line">SW_AGENT_COLLECTOR_BACKEND_SERVICES=127.0.0.1:11800;SW_AGENT_NAME=spring-cloud-alibaba-nacos-provider</span><br></pre></td></tr></table></figure>
<h3 id="jar包启动"><a href="#jar包启动" class="headerlink" title="jar包启动"></a>jar包启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> SkyWalking Agent配置</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">Agent名称，一般使用`spring.application.name`</span></span><br><span class="line">export SW_AGENT_NAME=ruoyi-admin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置collector地址，我这里是在同一台服务器上测试的</span></span><br><span class="line">export SW_AGENT_COLLECTOR_BACKEND_SERVICES=127.0.0.1:11800</span><br><span class="line"><span class="meta">#</span><span class="bash"> skywalking-agent.jar的路径</span></span><br><span class="line">export JAVA_AGENT=-javaagent:/learn/spring-cloud-alibaba/skywalking/apache-skywalking-apm-bin/agent/skywalking-agent.jar</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动jar</span></span><br><span class="line">java -jar $JAVA_AGENT ruoyi-admin.jar </span><br></pre></td></tr></table></figure>
<p>访问了一下登录接口</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210927162559750.png" alt="image-20210927162559750"></p>
<h3 id="war包启动"><a href="#war包启动" class="headerlink" title="war包启动"></a>war包启动</h3><p>如果在tomcat中进行部署，需要修改tomcat的bin目录下的catalina.sh，在顶部第一行加上：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> skywalking-agent.jar的路径</span></span><br><span class="line">CATALINA_OPTS=&quot;$CATALINA_OPTS&quot; -javaagent:/learn/spring-cloud-alibaba/skywalking/apache-skywalking-apm-bin/agent/skywalking-agent.jar;</span><br><span class="line">export CATALINA_OPTS;</span><br></pre></td></tr></table></figure>
<h3 id="SkyWalking三个概念"><a href="#SkyWalking三个概念" class="headerlink" title="SkyWalking三个概念"></a>SkyWalking三个概念</h3><blockquote>
<p>服务（service）</p>
</blockquote>
<p>表示对请求提供相同行为的一些列或一组工作负载，在使用Agent或SDK的时候，你可以定义服务的名称，就是我们上面脚本中的<code>SW_AGENT_NAME</code>;</p>
<blockquote>
<p>服务实例（service Instance）</p>
</blockquote>
<p>上述的一组工作负载中的每一个工作负载成为一个实例，服务实例未必就是操作系统上的一个进程，但当你在使用Agent的时候，一个服务实例实际就是操作系统上的一个真实进程；</p>
<blockquote>
<p>端点（Endpoint）</p>
</blockquote>
<p>对于特定服务所接收的请求路径，如http的url路径和gRPC服务的类名+方法签名；</p>
<h2 id="SkyWalking告警"><a href="#SkyWalking告警" class="headerlink" title="SkyWalking告警"></a>SkyWalking告警</h2><p>告警的核心是由一组规则驱动，这些规则定义在config/alarm-settings.yml中。</p>
<p>告警规定义分为三部分：</p>
<p>1、<code>告警规则</code>：它们定义了应该如何触发度量警报，应该考虑什么条件；</p>
<p>2、<code>网络钩子(#webhook)</code>：当警告触发时，那些服务终端需要被告知；</p>
<p>3、<code>gRPC钩子</code>：远程gRPC方法的主机和端口，告警触发后调用；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Licensed to the Apache Software Foundation (ASF) under one</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or more contributor license agreements.  See the NOTICE file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed with this work <span class="keyword">for</span> additional information</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> regarding copyright ownership.  The ASF licenses this file</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to you under the Apache License, Version 2.0 (the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">&quot;License&quot;</span>); you may not use this file except <span class="keyword">in</span> compliance</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> with the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed under the License is distributed on an <span class="string">&quot;AS IS&quot;</span> BASIS,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> limitations under the License.</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Sample alarm rules.</span></span><br><span class="line">rules:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Rule unique name, must be ended with `_rule`.</span></span><br><span class="line">  service_resp_time_rule:</span><br><span class="line">    metrics-name: service_resp_time</span><br><span class="line">    op: &quot;&gt;&quot;</span><br><span class="line">    threshold: 1000</span><br><span class="line">    period: 10</span><br><span class="line">    count: 3</span><br><span class="line">    silence-period: 5</span><br><span class="line">    message: Response time of service &#123;name&#125; is more than 1000ms in 3 minutes of last 10 minutes.</span><br><span class="line">  service_sla_rule:</span><br><span class="line">    # Metrics value need to be long, double or int</span><br><span class="line">    metrics-name: service_sla</span><br><span class="line">    op: &quot;&lt;&quot;</span><br><span class="line">    threshold: 8000</span><br><span class="line">    # The length of time to evaluate the metrics</span><br><span class="line">    period: 10</span><br><span class="line">    # How many times after the metrics match the condition, will trigger alarm</span><br><span class="line">    count: 2</span><br><span class="line">    # How many times of checks, the alarm keeps silence after alarm triggered, default as same as period.</span><br><span class="line">    silence-period: 3</span><br><span class="line">    message: Successful rate of service &#123;name&#125; is lower than 80% in 2 minutes of last 10 minutes</span><br><span class="line">  service_resp_time_percentile_rule:</span><br><span class="line">    # Metrics value need to be long, double or int</span><br><span class="line">    metrics-name: service_percentile</span><br><span class="line">    op: &quot;&gt;&quot;</span><br><span class="line">    threshold: 1000,1000,1000,1000,1000</span><br><span class="line">    period: 10</span><br><span class="line">    count: 3</span><br><span class="line">    silence-period: 5</span><br><span class="line">    message: Percentile response time of service &#123;name&#125; alarm in 3 minutes of last 10 minutes, due to more than one condition of p50 &gt; 1000, p75 &gt; 1000, p90 &gt; 1000, p95 &gt; 1000, p99 &gt; 1000</span><br><span class="line">  service_instance_resp_time_rule:</span><br><span class="line">    metrics-name: service_instance_resp_time</span><br><span class="line">    op: &quot;&gt;&quot;</span><br><span class="line">    threshold: 1000</span><br><span class="line">    period: 10</span><br><span class="line">    count: 2</span><br><span class="line">    silence-period: 5</span><br><span class="line">    message: Response time of service instance &#123;name&#125; is more than 1000ms in 2 minutes of last 10 minutes</span><br><span class="line">  database_access_resp_time_rule:</span><br><span class="line">    metrics-name: database_access_resp_time</span><br><span class="line">    threshold: 1000</span><br><span class="line">    op: &quot;&gt;&quot;</span><br><span class="line">    period: 10</span><br><span class="line">    count: 2</span><br><span class="line">    message: Response time of database access &#123;name&#125; is more than 1000ms in 2 minutes of last 10 minutes</span><br><span class="line">  endpoint_relation_resp_time_rule:</span><br><span class="line">    metrics-name: endpoint_relation_resp_time</span><br><span class="line">    threshold: 1000</span><br><span class="line">    op: &quot;&gt;&quot;</span><br><span class="line">    period: 10</span><br><span class="line">    count: 2</span><br><span class="line">    message: Response time of endpoint relation &#123;name&#125; is more than 1000ms in 2 minutes of last 10 minutes</span><br><span class="line"><span class="meta">#</span><span class="bash">  Active endpoint related metrics alarm will cost more memory than service and service instance metrics alarm.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  Because the number of endpoint is much more than service and instance.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"><span class="comment">#  endpoint_avg_rule:</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    metrics-name: endpoint_avg</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    op: <span class="string">&quot;&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    threshold: 1000</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    period: 10</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    count: 2</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    silence-period: 5</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    message: Response time of endpoint &#123;name&#125; is more than 1000ms <span class="keyword">in</span> 2 minutes of last 10 minutes</span></span><br><span class="line"></span><br><span class="line">webhooks:</span><br><span class="line"><span class="meta">	#</span><span class="bash"> 回调地址</span></span><br><span class="line">  - http://jl9z6wv.nat.ipyingshe.com/notify/</span><br><span class="line"><span class="meta">#</span><span class="bash">  - http://127.0.0.1/go-wechat/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如下图：如果触发了上面的规则 他就会回调我们配置的接口；</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210927174450408.png" alt="image-20210927174450408"></p>
<blockquote>
<p>Webhook回调通知</p>
</blockquote>
<p>SkyWalking告警Webhook回调要求接收方是一个web容器，告警的消息会通过http请求进行发送，请求访问为POST，Content-Type为application/json，json基于<code>List&lt;org.apache.skywalking.oap.server.core.alarm.AlarmMessage&gt;</code>的集合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AlarmMessage</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AlarmMessage NONE = <span class="keyword">new</span> NoAlarm();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> scopeId;</span><br><span class="line">    <span class="keyword">private</span> String scope;</span><br><span class="line">    <span class="comment">//目标scope的实体名称</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//scope实体id</span></span><br><span class="line">    <span class="keyword">private</span> String id0;</span><br><span class="line">    <span class="keyword">private</span> String id1;</span><br><span class="line">    <span class="comment">//你alarm-settings.yml中配置的规则名</span></span><br><span class="line">    <span class="keyword">private</span> String ruleName;</span><br><span class="line">    <span class="comment">//告警内容</span></span><br><span class="line">    <span class="keyword">private</span> String alarmMessage;</span><br><span class="line">    <span class="comment">//告警时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> startTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><h3 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h3><p>修改<code>config</code>目录下的<code>application.yml</code></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改120行的数据源为mysql</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_STORAGE:mysql&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改大概192行MySQL配置源</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">jdbcUrl:</span> <span class="string">$&#123;SW_JDBC_URL:&quot;jdbc:mysql://localhost:3306/skywalking?useSSL=false&quot;&#125;</span></span><br><span class="line">      <span class="comment">#账号</span></span><br><span class="line">      <span class="attr">dataSource.user:</span> <span class="string">$&#123;SW_DATA_SOURCE_USER:root&#125;</span></span><br><span class="line">      <span class="comment">#密码</span></span><br><span class="line">      <span class="attr">dataSource.password:</span> <span class="string">$&#123;SW_DATA_SOURCE_PASSWORD:123456&#125;</span></span><br><span class="line">      <span class="attr">dataSource.cachePrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_CACHE_PREP_STMTS:true&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSize:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_SIZE:250&#125;</span></span><br><span class="line">      <span class="attr">dataSource.prepStmtCacheSqlLimit:</span> <span class="string">$&#123;SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048&#125;</span></span><br><span class="line">      <span class="attr">dataSource.useServerPrepStmts:</span> <span class="string">$&#123;SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true&#125;</span></span><br><span class="line">    <span class="attr">metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_MYSQL_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line">    <span class="attr">maxSizeOfArrayColumn:</span> <span class="string">$&#123;SW_STORAGE_MAX_SIZE_OF_ARRAY_COLUMN:20&#125;</span></span><br><span class="line">    <span class="attr">numOfSearchableValuesPerTag:</span> <span class="string">$&#123;SW_STORAGE_NUM_OF_SEARCHABLE_VALUES_PER_TAG:2&#125;</span></span><br></pre></td></tr></table></figure>
<p>修改完成后，还需要在他的<code>oap-libs</code>目录下加入mysql依赖，因为他没有，不然启动会报错，如下：<img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928144539392.png" alt="image-20210928144539392"></p>
<h3 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h3><p><a target="_blank" rel="noopener" href="https://skywalking.apache.org/downloads/">apache-skywalking-apm-es7-8.6.0.tar.gz</a>，这里需要下载es版本，apm版本的会启动出错</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改112行的数据源为elasticsearch7</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_STORAGE:elasticsearch7&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改大概139行elasticsearch7配置源</span></span><br><span class="line">  <span class="attr">elasticsearch7:</span></span><br><span class="line">    <span class="attr">nameSpace:</span> <span class="string">$&#123;SW_NAMESPACE:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">clusterNodes:</span> <span class="string">$&#123;SW_STORAGE_ES_CLUSTER_NODES:localhost:9200&#125;</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">$&#123;SW_STORAGE_ES_HTTP_PROTOCOL:&quot;http&quot;&#125;</span></span><br><span class="line">    <span class="attr">trustStorePath:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PATH:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">trustStorePass:</span> <span class="string">$&#123;SW_STORAGE_ES_SSL_JKS_PASS:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">dayStep:</span> <span class="string">$&#123;SW_STORAGE_DAY_STEP:1&#125;</span> <span class="comment"># Represent the number of days in the one minute/hour/day index.</span></span><br><span class="line">    <span class="attr">indexShardsNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_SHARDS_NUMBER:1&#125;</span> <span class="comment"># Shard number of new indexes</span></span><br><span class="line">    <span class="attr">indexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_INDEX_REPLICAS_NUMBER:1&#125;</span> <span class="comment"># Replicas number of new indexes</span></span><br><span class="line">    <span class="comment"># Super data set has been defined in the codes, such as trace segments.The following 3 config would be improve es performance when storage super size data in es.</span></span><br><span class="line">    <span class="attr">superDatasetDayStep:</span> <span class="string">$&#123;SW_SUPERDATASET_STORAGE_DAY_STEP:-1&#125;</span> <span class="comment"># Represent the number of days in the super size dataset record index, the default value is the same as dayStep when the value is less than 0</span></span><br><span class="line">    <span class="attr">superDatasetIndexShardsFactor:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_SHARDS_FACTOR:5&#125;</span> <span class="comment">#  This factor provides more shards for the super data set, shards number = indexShardsNumber * superDatasetIndexShardsFactor. Also, this factor effects Zipkin and Jaeger traces.</span></span><br><span class="line">    <span class="attr">superDatasetIndexReplicasNumber:</span> <span class="string">$&#123;SW_STORAGE_ES_SUPER_DATASET_INDEX_REPLICAS_NUMBER:0&#125;</span> <span class="comment"># Represent the replicas number in the super size dataset record index, the default value is 0.</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">$&#123;SW_ES_USER:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;SW_ES_PASSWORD:&quot;&quot;&#125;</span></span><br><span class="line">    <span class="attr">secretsManagementFile:</span> <span class="string">$&#123;SW_ES_SECRETS_MANAGEMENT_FILE:&quot;&quot;&#125;</span> <span class="comment"># Secrets management file in the properties format includes the username, password, which are managed by 3rd party tool.</span></span><br><span class="line">    <span class="attr">bulkActions:</span> <span class="string">$&#123;SW_STORAGE_ES_BULK_ACTIONS:1000&#125;</span> <span class="comment"># Execute the async bulk record data every $&#123;SW_STORAGE_ES_BULK_ACTIONS&#125; requests</span></span><br><span class="line">    <span class="attr">flushInterval:</span> <span class="string">$&#123;SW_STORAGE_ES_FLUSH_INTERVAL:10&#125;</span> <span class="comment"># flush the bulk every 10 seconds whatever the number of requests</span></span><br><span class="line">    <span class="attr">concurrentRequests:</span> <span class="string">$&#123;SW_STORAGE_ES_CONCURRENT_REQUESTS:2&#125;</span> <span class="comment"># the number of concurrent requests</span></span><br><span class="line">    <span class="attr">resultWindowMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_WINDOW_SIZE:10000&#125;</span></span><br><span class="line">    <span class="attr">metadataQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_MAX_SIZE:5000&#125;</span></span><br><span class="line">    <span class="attr">segmentQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_SEGMENT_SIZE:200&#125;</span></span><br><span class="line">    <span class="attr">profileTaskQueryMaxSize:</span> <span class="string">$&#123;SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE:200&#125;</span></span><br><span class="line">    <span class="attr">oapAnalyzer:</span> <span class="string">$&#123;SW_STORAGE_ES_OAP_ANALYZER:&quot;&#123;\&quot;analyzer\&quot;:&#123;\&quot;oap_analyzer\&quot;:&#123;\&quot;type\&quot;:\&quot;stop\&quot;&#125;&#125;&#125;&quot;&#125;</span> <span class="comment"># the oap analyzer.</span></span><br><span class="line">    <span class="attr">oapLogAnalyzer:</span> <span class="string">$&#123;SW_STORAGE_ES_OAP_LOG_ANALYZER:&quot;&#123;\&quot;analyzer\&quot;:&#123;\&quot;oap_log_analyzer\&quot;:&#123;\&quot;type\&quot;:\&quot;standard\&quot;&#125;&#125;&#125;&quot;&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="自定义链路"><a href="#自定义链路" class="headerlink" title="自定义链路"></a>自定义链路</h2><h3 id="获取TraceId"><a href="#获取TraceId" class="headerlink" title="获取TraceId"></a>获取<code>TraceId</code></h3><blockquote>
<p>依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- skywalking 链路工具--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.skywalking<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apm-toolkit-trace<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>代码</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取skywalking链路的traceId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/traceId&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">traceId</span><span class="params">()</span></span>&#123;</span><br><span class="line">	TraceContext.putCorrelation(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">	Optional&lt;String&gt; key = TraceContext.getCorrelation(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">	log.info(<span class="string">&quot;获取到的value:&#123;&#125;&quot;</span>,key.get());</span><br><span class="line">    <span class="comment">//获取出链路的traceId，记录下来，后面排除错误方便使用；</span></span><br><span class="line">	String traceId = TraceContext.traceId();</span><br><span class="line">	log.info(<span class="string">&quot;traceId:&#123;&#125;&quot;</span>,traceId);</span><br><span class="line">	<span class="keyword">return</span> echoFeignService.divide(Integer.valueOf(<span class="number">1</span>),Integer.valueOf(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Trace注解"><a href="#Trace注解" class="headerlink" title="@Trace注解"></a>@Trace注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取skywalking链路的traceId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/traceId&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">traceId</span><span class="params">()</span></span>&#123;</span><br><span class="line">	TraceContext.putCorrelation(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">	Optional&lt;String&gt; key = TraceContext.getCorrelation(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">	log.info(<span class="string">&quot;获取到的value:&#123;&#125;&quot;</span>,key.get());</span><br><span class="line">    <span class="comment">//获取出链路的traceId，记录下来，后面排除错误方便使用；</span></span><br><span class="line">	String traceId = TraceContext.traceId();</span><br><span class="line">	log.info(<span class="string">&quot;traceId:&#123;&#125;&quot;</span>,traceId);</span><br><span class="line">    <span class="comment">//调用自己想在链路中展示的方法@Trace(operationName = &quot;test&quot;)</span></span><br><span class="line">	myTest();</span><br><span class="line">	<span class="keyword">return</span> echoFeignService.divide(Integer.valueOf(<span class="number">1</span>),Integer.valueOf(<span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//test为 在链路中展示的名称</span></span><br><span class="line"><span class="meta">@Trace(operationName = &quot;test&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">myTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">	log.info(<span class="string">&quot;我就测试一下&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如图：</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928163435586.png" alt="image-20210928163435586"></p>
<h2 id="SkyWalking集成日志"><a href="#SkyWalking集成日志" class="headerlink" title="SkyWalking集成日志"></a>SkyWalking集成日志</h2><blockquote>
<p>依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- skywalking 链路工具--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.skywalking<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apm-toolkit-logback-1.x<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>在resources目录下创建logback-spring.xml</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 引入 Spring Boot 默认的 logback XML 配置文件  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">&quot;org/springframework/boot/logging/logback/defaults.xml&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 控制台 Appender --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;CONSOLE_LOG_PATTERN&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%clr(%d&#123;$&#123;LOG_DATEFORMAT_PATTERN:-yyyy-MM-dd HH:mm:ss.SSS&#125;&#125;)&#123;faint&#125; %clr($&#123;LOG_LEVEL_PATTERN:-%5p&#125;) %clr($&#123;PID:- &#125;)&#123;magenta&#125; %tid %clr(---)&#123;faint&#125; %clr([%15.15t])&#123;faint&#125; %clr(%-40.40logger&#123;39&#125;)&#123;cyan&#125; %clr(:)&#123;faint&#125; %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;console&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志的格式化 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.encoder.LayoutWrappingEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.skywalking.apm.toolkit.log.logback.v1.x.TraceIdPatternLogbackLayout&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>$&#123;CONSOLE_LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 从 Spring Boot 配置文件中，读取 spring.application.name 应用名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">springProperty</span> <span class="attr">name</span>=<span class="string">&quot;applicationName&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;context&quot;</span> <span class="attr">source</span>=<span class="string">&quot;spring.application.name&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;FILE_LOG_PATTERN&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%d&#123;$&#123;LOG_DATEFORMAT_PATTERN:-yyyy-MM-dd HH:mm:ss.SSS&#125;&#125; $&#123;LOG_LEVEL_PATTERN:-%5p&#125; $&#123;PID:- &#125; %tid --- [%t] %-40.40logger&#123;39&#125; : %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125;&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 日志文件的路径 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_FILE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/logs/$&#123;applicationName&#125;.log&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 日志文件 Appender --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;LOG_FILE&#125;<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--滚动策略，基于时间 + 大小的分包策略 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;LOG_FILE&#125;.%d&#123;yyyy-MM-dd&#125;.%i.gz<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>7<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 日志的格式化 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.encoder.LayoutWrappingEncoder&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;org.apache.skywalking.apm.toolkit.log.logback.v1.x.TraceIdPatternLogbackLayout&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>$&#123;FILE_LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 设置 Appender --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;file&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>结果</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928164600421.png" alt="image-20210928164600421"></p>
<h2 id="SkyWalking-UI"><a href="#SkyWalking-UI" class="headerlink" title="SkyWalking UI"></a>SkyWalking UI</h2><blockquote>
<p>第一部分</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928172741024.png" alt="image-20210928172741024"></p>
<p><code>仪表盘</code>：查看被监控服务的运行状态；</p>
<p><code>拓扑图</code>：以拓扑图的方式展现服务之间的关系，并以此为入口查看相关信息；</p>
<p><code>追踪</code>：以接口列表的方式展现，追踪接口内部调用过程；</p>
<p><code>性能剖析</code>：对端点进行采样分析，并可查看堆栈信息；</p>
<p><code>告警</code>：触发告警的告警列表，包括服务失败率，请求超时等；</p>
<p><code>调试</code>：进行服务进行调试</p>
<p><code>自动刷新</code>：刷新当前页面数据内容；</p>
<h3 id="仪表盘"><a href="#仪表盘" class="headerlink" title="仪表盘"></a>仪表盘</h3><blockquote>
<p>1、控制栏</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928173021301.png" alt="image-20210928173021301"></p>
<p>第一栏：不同内容主题的监控面板，应用性能管理/数据库/容器等；</p>
<p>第二栏：操作，包括 编辑/导出当前数据/倒入展示数据/不同服务端点筛选展示；</p>
<p>第三栏：不同纬度展示，全局/服务/实例/端点</p>
<blockquote>
<p>2、展示栏</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928173132952.png" alt="image-20210928173132952"></p>
<blockquote>
<p>3、Global全局维度</p>
</blockquote>
<p>第一栏：Global、Service、Instance、Endpoint不同展示面板；</p>
<p>Services load：服务每分钟请求数；</p>
<p>Slow Services：慢响应服务，单位ms；</p>
<p>Un-Health services(Apdex): Apdex性能指标，1为满分；</p>
<p>Slow Endpoint：慢响应端点，单位ms；</p>
<p>Global Response Latency：百分比响应延时，不同百分比的延时时间，单位ms；</p>
<p>Global Heatmap：服务响应时间热力分布图，根据时间段内不同响应时间的数量显示颜色深度；</p>
<p>底部栏：展示数据的时间区间，点击可以调整；</p>
<blockquote>
<p>4、Service服务维度</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928173339154.png" alt="image-20210928173339154"></p>
<p>Service Apdex（数字）:当前服务的评分； </p>
<p>Service Apdex（折线图）：不同时间的Apdex评分；</p>
<p>Service Avg Response Times：平均响应延时，单位ms；</p>
<p>Global Response Time Percentile：百分比响应延时；</p>
<p>Successful Rate（数字）：请求成功率；</p>
<p>Successful Rate（折线图）：不同时间的请求成功率；</p>
<p>Servce Load（数字）：每分钟请求数；</p>
<p>Servce Load（折线图）：不同时间的每分钟请求数；</p>
<p>Servce Instances Load：每个服务实例的每分钟请求数；</p>
<p>Show Service Instance：每个服务实例的最大延时；</p>
<p>Service Instance Successful Rate：每个服务实例的请求成功率；</p>
<blockquote>
<p>5、Instance实例维度</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928173517597.png" alt="image-20210928173517597"></p>
<p>Service Instance Load：当前实例的每分钟请求数；</p>
<p>Service Instance Successful Rate：当前实例的请求成功率；</p>
<p>Service Instance Latency：当前实例的响应延时；</p>
<p>JVM CPU：jvm占用CPU的百分比；</p>
<p>JVM Memory：JVM内存占用大小，单位m；</p>
<p>JVM GC Time：JVM垃圾回收时间，包含YGC和OGC；</p>
<p>JVM GC Count：JVM垃圾回收次数，包含YGC和OGC；</p>
<p>JVM Thread Count：JVM线程数；</p>
<p>还有几个是.NET的；</p>
<blockquote>
<p>6、Endpoint端点（API）维度</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928173611321.png" alt="image-20210928173611321"></p>
<p>Endpoint Load in Current Service：每个端点的每分钟请求数；</p>
<p>Slow Endpoints in Current Service：每个端点的最慢请求时间，单位ms；</p>
<p>Successful Rate in Current Service：每个端点的请求成功率；</p>
<p>Endpoint Load：当前端点每个时间段的请求数据；</p>
<p>Endpoint Avg Response Time：当前端点每个时间段的请求行响应时间；</p>
<p>Endpoint Response Time Percentile：当前端点每个时间段的响应时间占比；</p>
<p>Endpoint Successful Rate：当前端点每个时间段的请求成功率</p>
<h3 id="拓扑图"><a href="#拓扑图" class="headerlink" title="拓扑图"></a>拓扑图</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928173702301.png" alt="image-20210928173702301"></p>
<p>1：选择不同的服务关联拓扑；</p>
<p>2：查看单个服务相关内容；</p>
<p>3：服务间连接情况；</p>
<p>4：分组展示服务拓扑</p>
<h3 id="追踪"><a href="#追踪" class="headerlink" title="追踪"></a>追踪</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928173732966.png" alt="image-20210928173732966"></p>
<p>左侧：api接口列表，红色-异常请求，蓝色-正常请求；</p>
<p>右侧：api追踪列表，api请求连接各端点的先后顺序和时间；</p>
<h3 id="性能剖析"><a href="#性能剖析" class="headerlink" title="性能剖析"></a>性能剖析</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928173850529.png" alt="image-20210928173850529"></p>
<p>性能剖析 需要自己创建任务；</p>
<h3 id="告警"><a href="#告警" class="headerlink" title="告警"></a>告警</h3><p>如果满足了他内置的告警条件，会显示出来</p>
<h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210928174137741.png" alt="image-20210928174137741"></p>
<p>记录服务的开启 等事件；</p>
<h2 id="SkyWalking集群"><a href="#SkyWalking集群" class="headerlink" title="SkyWalking集群"></a>SkyWalking集群</h2><p>生产中不搭集群也是可以的，因为这个只是调用链路跟踪，skywalking oap跟踪服务如果宕机了，完全不会影响正常业务；Skywalking集群是将skywalking oap作为一个服务注册到nacos上，只要skywalking oap服务没有全部宕机，保证有一个skywalking oap在运行，就能进行跟踪；</p>
<p>搭建一个skywalking oap集群需要：</p>
<p>（1）至少一个Nacos（也可以把nacos集群）</p>
<p>（2）至少一个ElasticSearch（也可以把es集群）</p>
<p>（3）至少2个skywalking oap服务；</p>
<p>（4）至少1个UI（UI也可以集群多个，用Nginx代理统一入口）</p>
<blockquote>
<p>1、修改<code>/config/application.yml</code>配置</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一步</span></span><br><span class="line"><span class="attr">cluster:</span></span><br><span class="line">  <span class="comment"># 将集群选成nacos</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="string">$&#123;SW_CLUSTER:nacos&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##第一步 修改nacos的地址</span></span><br><span class="line"><span class="attr">nacos:</span> </span><br><span class="line">	<span class="attr">serviceName:</span> <span class="string">$&#123;SW_SERVICE_NAME:&quot;SkyWalking_OAP_Cluster&quot;&#125;</span> </span><br><span class="line">	<span class="attr">hostPort:</span> <span class="string">$&#123;SW_CLUSTER_NACOS_HOST_PORT:localhost:8848&#125;</span></span><br></pre></td></tr></table></figure>
<p>因为这里时单台做的集群，所以需要该一下端口</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一台</span></span><br><span class="line"><span class="attr">restPort:</span> <span class="string">$&#123;SW_CORE_REST_PORT:12801&#125;</span></span><br><span class="line"><span class="attr">gRPCPort:</span> <span class="string">$&#123;SW_CORE_GRPC_PORT:11801&#125;</span></span><br><span class="line"><span class="comment">#第二台</span></span><br><span class="line"><span class="attr">restPort:</span> <span class="string">$&#123;SW_CORE_REST_PORT:12802&#125;</span></span><br><span class="line"><span class="attr">gRPCPort:</span> <span class="string">$&#123;SW_CORE_GRPC_PORT:11802&#125;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>2、修改ui服务</p>
</blockquote>
<p>配置ui服务webapp.yml文件，写两个地址</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">oap-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://oap-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/graphql/**</span></span><br><span class="line">    <span class="attr">discovery:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">simple:</span></span><br><span class="line">          <span class="attr">instances:</span></span><br><span class="line">            <span class="attr">oap-service:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">uri:</span> <span class="string">http://127.0.0.1:12801,http://127.0.0.1:12802</span></span><br><span class="line">            <span class="comment"># - uri: http://&lt;oap-host-1&gt;:&lt;oap-port1&gt;</span></span><br><span class="line">            <span class="comment"># - uri: http://&lt;oap-host-2&gt;:&lt;oap-port2&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">throw-exception-if-no-handler-found:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">add-mappings:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">base-path:</span> <span class="string">/manage</span></span><br></pre></td></tr></table></figure>
<h1 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h1><h2 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h2><p>事务时数据库的概念，数据库事务（<code>ACID：原子性、一致性、隔离性、持久性</code>）；分布式事务的产生，是由于数据库的拆分和分布式架构带来的，在常规情况下，我们在一个进程中操作一个数据库，这属于本地事务，如果在一个进程中操作多个数据库，或者在多个进程中操作一个或多个数据，就会产生分布式事务；</p>
<p>1、数据库分库分表就会产生分布式事务</p>
<p>2、项目拆分服务化也产生了分布式事务</p>
<h2 id="什么是Seata"><a href="#什么是Seata" class="headerlink" title="什么是Seata"></a>什么是Seata</h2><p>Seata是alibab开源的分布式事务解决方案，用于微服务架构下分布式事务服务，Seata为用户提供了<code>AT、TCC、SAGA和XA事务模式</code>，目前使用流行情况：AT&gt;TCC&gt;SAGA;</p>
<p><a target="_blank" rel="noopener" href="https://seata.io/zh-cn/">官网地址</a></p>
<blockquote>
<p>Seata架构中有三个角色</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210929113404780.png" alt="image-20210929113404780"></p>
<p>1、<code>TC(Transaction Coordinator)-事务协调者</code>：维护全局和分支事务的状态，驱动全局事务提交或者回滚；</p>
<p>2、<code>TM(Transaction Manager)-事务管理器</code>：定义全局事务的范围，开始全局事务、提交或回滚全局事务；</p>
<p>3、<code>RM(Resource Manager)-资源管理器</code>：管理分支事务处理的资源，与TC交互以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚；其中TC为单独部署的Server服务端，TM和RM为嵌入到应用中的Client客户端；</p>
<blockquote>
<p>在Seate中，一个分布式事务的生命周期</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210929114220523.png" alt="image-20210929114220523"></p>
<p>1、TM请求TC开启一个全局事务，TC会生成一个XID作为全局事务的编号，XID会在微服务的调用链路中传播，保证将多个微服务的子事务关联在一起；</p>
<p>2、TM请求TC将本地事务注册为全局的事务的分支事务，通过全局事务的XID进行关联；</p>
<p>3、TM请求TC告诉XID对应的全局事务时进行提交还是回滚；</p>
<p>4、TC驱动RM将XID对应自己的本地事务进行提交还是回滚；</p>
<h2 id="TC-Server部署"><a href="#TC-Server部署" class="headerlink" title="TC Server部署"></a>TC Server部署</h2><p>因为TC需要进行全局事务和分支事务的记录，所以需要对应的存储，目前TC有三种存储模式（store.mode）</p>
<p>1、file模式：适合单机模式，全局事务会话信息在内存中读写，并持久化本地文件root.data，性能较高；</p>
<p>2、db模式：适合集群模式，全局事务会话信息通过db共享，相对性能差点；</p>
<p>3、redis模式：解决db存储的性能问题；</p>
<blockquote>
<p>单机安装</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/seata/seata/releases">github下载</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 解压</span></span><br><span class="line">tar -zxvf seata-server-1.4.2.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入bin目录启动即可</span></span><br><span class="line">./seata-server.sh</span><br></pre></td></tr></table></figure>
<p>默认配置下，Seate TC Server启动在8091端口以及默认请求seate使用的时file模式进行数据持久化的，所以可以看到用于持久化的本地文件root.data，这里文件就在<code>seate/bin/sessionStore/</code>下面;</p>
<h2 id="AT模式"><a href="#AT模式" class="headerlink" title="AT模式"></a>AT模式</h2><h3 id="案例代码"><a href="#案例代码" class="headerlink" title="案例代码"></a>案例代码</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210929141436927.png" alt="image-20210929141436927"></p>
<p>在springboot单体项目中，如果使用了多数据源，就需要考虑多个数据源的数据一致性，即产生了分布式事务的问题，用seate来解决分布式事务问题；</p>
<blockquote>
<p>案例：以电商购物下的那为例</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210929141656091.png" alt="image-20210929141656091"></p>
<blockquote>
<p>代码</p>
</blockquote>
<p>1、依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud-alibaba.version</span>&gt;</span>2.2.1.RELEASE <span class="tag">&lt;/<span class="name">spring-cloud-alibaba.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- mysql-connector-java --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--mybatis-plus依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 集成 seata--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- dynamic-datasource-spring-boot-starter动态数据源 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 继承 spring cloud Alibaba依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 继承 spring boot依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>问题：</p>
<p>问题描述：<code>Type id handling not implemented for type java.lang.Object....</code></p>
<p>解决方法：</p>
<p>1、<a target="_blank" rel="noopener" href="https://github.com/seata/seata/pull/3228/files">https://github.com/seata/seata/pull/3228/files</a> 或者看这个pr的做法,通过spi,自定义你的jackson序列化器<br>2、查看你代码的实体类时间属性对应的数据库字段类型如果是datetime改成timestamp<br>3、修改seata的换序列化方式 配置中心中配置client.undo.logSerialization=kryo,client端再引入kryo的依赖包（ruoyi-cloud项目放到ruoyi-common-core/pom.xml下即可）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.esotericsoftware.kryo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kryo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.24.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.esotericsoftware<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kryo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>de.javakaffee<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kryo-serializers<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.44<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2、配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端口</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8088</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="comment"># 应用名称</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springboot-server-seata-monomer</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">dynamic:</span></span><br><span class="line">      <span class="comment"># 设置默认数据源</span></span><br><span class="line">      <span class="attr">primary:</span> <span class="string">order-ds</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="comment"># 订单数据源</span></span><br><span class="line">        <span class="attr">order-ds:</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/orderdb?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">        <span class="comment"># 商品数据源</span></span><br><span class="line">        <span class="attr">product-ds:</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/productdb?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">        <span class="comment"># 账户数据源</span></span><br><span class="line">        <span class="attr">account-ds:</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/accountdb?useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">          <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">          <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="comment">#开启对seate的集成，默认是false</span></span><br><span class="line">      <span class="attr">seata:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------[Seata server 单机配置]--------------------------------------------</span></span><br><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="comment"># seate应用编号，默认为$&#123;spring.application.name&#125;</span></span><br><span class="line">  <span class="attr">application-id:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">  <span class="comment">#seate事务组编号，用于TC集群名称</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">$&#123;spring.application.name&#125;-group</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="comment"># 虚拟组和分组的映射</span></span><br><span class="line">    <span class="attr">vgroup-mapping.springboot-server-seata-monomer-group:</span> <span class="string">default</span></span><br><span class="line">    <span class="comment"># 分组和seata服务的映射</span></span><br><span class="line">    <span class="attr">grouplist.default:</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span><span class="string">:8091</span></span><br><span class="line">  <span class="comment"># 配置类型 默认file</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">  <span class="comment"># 报错在哪里，默认就是file</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 指定全局的配置文件</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="comment"># 配置mapper的扫描，找到所有的mapper.xml映射文件</span></span><br><span class="line">  <span class="attr">mapperLocations:</span> <span class="string">classpath*:mapper/*Mapper.xml</span></span><br><span class="line">  <span class="attr">config-location:</span> <span class="string">classpath:mybatis-config.xml</span></span><br></pre></td></tr></table></figure>
<p>3、controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span> <span class="comment">//lombok</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/order&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">createOrder</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> Integer userId,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="meta">@RequestParam(&quot;productId&quot;)</span> Integer productId)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;请求下单, 用户:&#123;&#125;, 商品:&#123;&#125;&quot;</span>, userId, productId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderService.createOrder(userId, productId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4、OrderServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> OrdersMapper ordersMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@DS(value = &quot;order-ds&quot;)</span></span><br><span class="line">    <span class="meta">@GlobalTransactional</span> <span class="comment">//seata全局事务注解</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">createOrder</span><span class="params">(Integer userId, Integer productId)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Integer amount = <span class="number">1</span>; <span class="comment">// 购买数量暂时设置为 1</span></span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;当前 XID: &#123;&#125;&quot;</span>, RootContext.getXID());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 减库存</span></span><br><span class="line">        Product product = productService.reduceStock(productId, amount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 减余额</span></span><br><span class="line">        accountService.reduceBalance(userId, product.getPrice());</span><br><span class="line">        <span class="comment">//这里抛出异常进行测试</span></span><br><span class="line">        <span class="keyword">int</span> number=<span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 下订单</span></span><br><span class="line">        Orders order = <span class="keyword">new</span> Orders();</span><br><span class="line">        order.setUserId(userId);</span><br><span class="line">        order.setProductId(productId);</span><br><span class="line">        order.setPayAmount(product.getPrice().multiply(<span class="keyword">new</span> BigDecimal(amount)));</span><br><span class="line"></span><br><span class="line">        ordersMapper.insertSelective(order);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;下订单: &#123;&#125;&quot;</span>, order.getId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回订单编号</span></span><br><span class="line">        <span class="keyword">return</span> order.getId();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5、AccountServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">AccountMapper</span>,<span class="title">Account</span>&gt; <span class="keyword">implements</span> <span class="title">AccountService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@DS(value = &quot;account-ds&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceBalance</span><span class="params">(Integer userId, BigDecimal money)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;当前 XID: &#123;&#125;&quot;</span>, RootContext.getXID());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查余额</span></span><br><span class="line">        Account account = accountMapper.selectAccountByUserId(userId);</span><br><span class="line">        <span class="keyword">if</span> (account.getBalance().doubleValue() &lt; money.doubleValue()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;余额不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 扣除余额</span></span><br><span class="line">        <span class="keyword">int</span> updateCount = accountMapper.reduceBalance(userId, money);</span><br><span class="line">        <span class="comment">// 扣除成功</span></span><br><span class="line">        <span class="keyword">if</span> (updateCount == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;余额不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;扣除用户 &#123;&#125; 余额成功&quot;</span>, userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6、ProductServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">ProductMapper</span>, <span class="title">Product</span>&gt; <span class="keyword">implements</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    ProductMapper productMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@DS(value = &quot;product-ds&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">reduceStock</span><span class="params">(Integer productId, Integer amount)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;当前 XID: &#123;&#125;&quot;</span>, RootContext.getXID());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查库存</span></span><br><span class="line">        Product product = productMapper.selectByPrimaryKey(productId);</span><br><span class="line">        <span class="keyword">if</span> (product.getStock() &lt; amount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 扣减库存</span></span><br><span class="line">        <span class="keyword">int</span> updateCount = productMapper.reduceStock(productId, amount);</span><br><span class="line">        <span class="comment">// 扣除成功</span></span><br><span class="line">        <span class="keyword">if</span> (updateCount == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 扣除成功</span></span><br><span class="line">        log.info(<span class="string">&quot;扣除 &#123;&#125; 库存成功&quot;</span>, productId);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>7、进行测试</p>
<p>访问接口报错后，seata把数据进行回滚了；</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20210930143110646.png" alt="image-20210930143110646"></p>
<blockquote>
<p>整体机制</p>
</blockquote>
<p>整体机制就是两个阶段提交协议的演变；</p>
<p>1、第一阶段</p>
<p>​    <code>业务数据</code>和<code>回滚日志记录</code>在同一个本地事务中提交，释放本地锁和连接资源；</p>
<p>2、第二阶段</p>
<p>​    提交异步化，非常快速的完成</p>
<p>​    回滚通过第一阶段的回滚日志进行反向补偿；</p>
<blockquote>
<p>官方案例</p>
</blockquote>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Field    Type          Key</span><br><span class="line">id       bigint(20)    PRI</span><br><span class="line">name	 varchar(100)</span><br><span class="line">since    varchar(100)</span><br></pre></td></tr></table></figure>
<p>AT分支事务的业务逻辑：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update product <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;GTS&#x27;</span> <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;TXC&#x27;</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第一阶段过程：</p>
</blockquote>
<p>​    1、解析sql：得到sql的类型（update），表（product），条件（where name = ‘TXC’）等相关信息；</p>
<p>​    2、查询前置镜像：根据解析得到的条件信息，生成查询语句，定位数据；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name,since <span class="keyword">from</span> product <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;TXC&#x27;</span>; </span><br></pre></td></tr></table></figure>
<p>​    得到前镜像</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id    name   since</span><br><span class="line">1      TXC    2014</span><br></pre></td></tr></table></figure>
<p>​    3、执行业务sql：更新这条记录的name为<code>GTS</code>;</p>
<p>​    4、查询后镜像：根据前镜像的结果，通过 主键 定位数据；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,name,since <span class="keyword">from</span> product <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>​    得到后镜像</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id    name   since</span><br><span class="line">1      GTS    2014</span><br></pre></td></tr></table></figure>
<p>​    5、插入回滚日志：把前后镜像数据及业务sql相关的信息组成一条回滚日志记录，插入到UNDO_LOG表中；</p>
<p>​    6、提交前，向TC注册分支：申请product表中，主键值等于1的记录的全局锁；</p>
<p>​    7、本地事务提交：业务数据的更新和前面步骤中生成的UNDO_LGO一并提交；</p>
<p>​    8、将本地事务提交的结果上报给TC；</p>
<blockquote>
<p>第二阶段-回滚</p>
</blockquote>
<p>​    1、收到<code>TC</code>的分支回滚请求，开启一个本地事务，执行以下操作；</p>
<p>​    2、通过<code>XID</code>和<code>Branch ID</code>查找到相应的UNDO_LOG记录；</p>
<p>​    3、数据校验：拿UNDO_LOG中的后镜像与当前数据进行比较，如果有不同，说明数据被当前全局事务之外的动作做了修改，这种情况，需要人工来处理；</p>
<p>​    4、根据UNDO_LOG中的前镜像和业务sql的相关信息生成并执行回滚的语句；</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update product <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;TXC&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>​    5、提交本地事务，并把本地事务的执行结果（即分支事务回滚的结果）上报TC；</p>
<blockquote>
<p>第二阶段-提交</p>
</blockquote>
<p>​    1、收到TC的分支提交请求，把请求放入一个一部任务的队列中，马上返回提交成功的结果给TC；</p>
<p>​    2、异步任务阶段的分支提交请求将异步和批量地删除相对应UNDO_LOG记录；</p>
<h3 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h3><blockquote>
<p>AT模式的前提</p>
</blockquote>
<p>​    1、基于支持本地ACID事务的关系型数据库；</p>
<p>​    2、Java应用，通过JDBC访问数据库；</p>
<blockquote>
<p>整体机制是两个阶段提交协议的演变：</p>
</blockquote>
<p>第一阶段：</p>
<p>​    业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源（本地事务，就已经在数据库持久化了）；</p>
<p>第二阶段：</p>
<p>​    1、如果没有异常提交异步化，非常快速的完成（正常情况，那就是提交了，同步一下TC Server的状态，删除回滚日志）；</p>
<p>​    2、如果有异常回滚通过一阶段的回滚日志进行反向补偿；</p>
<h3 id="写隔离"><a href="#写隔离" class="headerlink" title="写隔离"></a>写隔离</h3><p>第一阶段本地事务提交前，需要确保先拿到<code>全局锁</code>， 拿不到<code>全局锁</code>就不能提交本地事务；</p>
<p>拿<code>全局锁</code>的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁；</p>
<p><code>避免了写数据的冲突</code></p>
<blockquote>
<p>案例1</p>
</blockquote>
<p>案例：两个或多个全局事务tx1和tx2，分别并发对a表的m字段进行更新操作，m的初始值1000。</p>
<p>将设tx1先开始，开启本地事务，拿到本地锁，更新操作m=1000-100=900，本地事务提交前，先拿到该记录的<code>全局锁</code>，本地提交释放本地锁。</p>
<p>tx2后开始，开启本地事务，拿到本地锁，更新操作m=900-100=800，本地事务提交前，尝试拿该记录的<code>全局锁</code>，tx1全局提交前，该记录的全局锁一直会被tx1持有，tx2需要尝试等待<code>全局锁</code>；</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211007004518248.png" alt="image-20211007004518248"></p>
<p>tx1 二阶段全局提交，释放<code>全局锁</code>，tx2拿到<code>全局锁</code>提交本地事务；</p>
<blockquote>
<p>案例2</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211007182522888.png" alt="image-20211007182522888"></p>
<p>1、如果tx1的二阶段全局回滚，则tx1需要重写获取该数据的本地所，进行反向补偿的更新操作，实现分支的回滚；</p>
<p>2、此时，如果tx2仍在等待该数据的<code>全局锁</code>，同时持有本地锁，则tx1的分支回滚会失败，分支的回滚会一直充实，直到tx2的<code>全局锁</code>超时，放弃<code>全局锁</code>并回滚本地事务释放本地锁，tx1的分支回滚最终成功；</p>
<p>3、因为整个过程<code>全局锁</code>在tx1结束前一直是被tx1持有的。所以不会发生<code>胀读</code>问题；</p>
<h3 id="读隔离"><a href="#读隔离" class="headerlink" title="读隔离"></a>读隔离</h3><p>在数据库本地事务隔离级别 读已提交（Read Committed）或以上的基础上，Seata（AT模式）的默认全局隔离级别是 读未提交（Read Uncommitted）;</p>
<blockquote>
<p>案例</p>
</blockquote>
<p>如果应用在特定场景下，必须要求全局的<code>读已提交</code>，目前Seata的方式是通过在sql语句中加SELECT FOR UODATE 实现的；</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211007184352115.png" alt="image-20211007184352115"></p>
<p><code>SELECT FOR UPDATE</code>语句的执行会申请<code>全局锁</code>，如果<code>全局锁</code>被其他事务持有，则释放本地锁（回滚SELECT FOR UPDATE 语句的本地执行）并重试，这个过程中，查询是block住的，直到<code>全局锁</code>拿到，即读取的相关数据是已提交的，才返回；</p>
<p>出于总体性能上的考虑，Seata目前的方案并没有对所有SELECT语句都进行代理，仅针对SELECT FOR UDPATE 的SELECT语句；</p>
<h2 id="TC-Server集群"><a href="#TC-Server集群" class="headerlink" title="TC Server集群"></a>TC Server集群</h2><p>生产环境下，需要部署集群Seata TC Server，实现高可用，在集群时，多个Seata TC Server通过db数据库或者redis实现全局事务会话信息的共享；每个Seata TC Server注册自己到注册中心上，应用从注册中心获得Seata TC Server实例，这就是Seata TC Server的集群；</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211007191725902.png" alt="image-20211007191725902"></p>
<p>Seata TC Server 对主流的注册中心都提供了集成，这里采用Nacos作为注册中心；</p>
<blockquote>
<p>第一步</p>
</blockquote>
<p> 解压两个seata-server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 解压</span></span><br><span class="line">tar -zxvf seata-server-1.3.0.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 复制2份</span></span><br><span class="line">\cp -rf server-1.3.0 seata-01</span><br><span class="line">\cp -rf server-1.3.0 seata-02</span><br></pre></td></tr></table></figure>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211007192256334.png" alt="image-20211007192256334"></p>
<blockquote>
<p>第二步</p>
</blockquote>
<p>初始化Seata TC Server的db数据库，在mysql中，创建seata数据库，并在该库下面执行如下的sql脚本</p>
<p>这里的sql脚本 在seata源码的<code>seata-1.4.2\script\server\db</code>的目录下面</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211007192917049.png" alt="image-20211007192917049"></p>
<blockquote>
<p>第三步</p>
</blockquote>
<p>修改<code>conf/file.conf</code>配置文件，修改使用db数据库，实现Seata TC Server的全局事务会话信息的共享;</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># transaction log store, only used in seata-server</span></span></span><br><span class="line">store &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># store mode: file、db、redis</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 修改file为db</span></span><br><span class="line">  mode = &quot;db&quot;</span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># rsa decryption public key</span></span></span><br><span class="line">  publicKey = &quot;&quot;</span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># file store property</span></span></span><br><span class="line">  file &#123;</span><br><span class="line">    ## store location dir</span><br><span class="line">    dir = &quot;sessionStore&quot;</span><br><span class="line">    # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions</span><br><span class="line">    maxBranchSessionSize = 16384</span><br><span class="line">    # globe session size , if exceeded throws exceptions</span><br><span class="line">    maxGlobalSessionSize = 512</span><br><span class="line">    # file buffer size , if exceeded allocate new buffer</span><br><span class="line">    fileWriteBufferCacheSize = 16384</span><br><span class="line">    # when recover batch read size</span><br><span class="line">    sessionReloadReadSize = 100</span><br><span class="line">    # async, sync</span><br><span class="line">    flushDiskMode = async</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># database store property</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># 修改数据库连接信息</span></span></span><br><span class="line">  db &#123;</span><br><span class="line">    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp)/HikariDataSource(hikari) etc.</span><br><span class="line">    datasource = &quot;druid&quot;</span><br><span class="line">    ## mysql/oracle/postgresql/h2/oceanbase etc.</span><br><span class="line">    dbType = &quot;mysql&quot;</span><br><span class="line">    driverClassName = &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">    ## if using mysql to store the data, recommend add rewriteBatchedStatements=true in jdbc connection param</span><br><span class="line">    url = &quot;jdbc:mysql://127.0.0.1:3306/seata?rewriteBatchedStatements=true&quot;</span><br><span class="line">    user = &quot;mysql&quot;</span><br><span class="line">    password = &quot;mysql&quot;</span><br><span class="line">    minConn = 5</span><br><span class="line">    maxConn = 100</span><br><span class="line">    globalTable = &quot;global_table&quot;</span><br><span class="line">    branchTable = &quot;branch_table&quot;</span><br><span class="line">    lockTable = &quot;lock_table&quot;</span><br><span class="line">    queryLimit = 100</span><br><span class="line">    maxWait = 5000</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># redis store property</span></span></span><br><span class="line">  redis &#123;</span><br><span class="line">    ## redis mode: single、sentinel</span><br><span class="line">    mode = &quot;single&quot;</span><br><span class="line">    ## single mode property</span><br><span class="line">    single &#123;</span><br><span class="line">      host = &quot;127.0.0.1&quot;</span><br><span class="line">      port = &quot;6379&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    ## sentinel mode property</span><br><span class="line">    sentinel &#123;</span><br><span class="line">      masterName = &quot;&quot;</span><br><span class="line">      ## such as &quot;10.28.235.65:26379,10.28.235.65:26380,10.28.235.65:26381&quot;</span><br><span class="line">      sentinelHosts = &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    password = &quot;&quot;</span><br><span class="line">    database = &quot;0&quot;</span><br><span class="line">    minConn = 1</span><br><span class="line">    maxConn = 10</span><br><span class="line">    maxTotal = 100</span><br><span class="line">    queryLimit = 100</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>第四步</p>
</blockquote>
<p>设置使用Nacos注册中心，修改<code>conf/registry.conf</code>配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> 设置为nacos</span></span><br><span class="line">  type = &quot;nacos&quot;</span><br><span class="line">	</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 设置nacosip端口</span></span><br><span class="line">  nacos &#123;</span><br><span class="line">    application = &quot;seata-server&quot;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:8848&quot;</span><br><span class="line">    group = &quot;SEATA_GROUP&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    username = &quot;&quot;</span><br><span class="line">    password = &quot;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  eureka &#123;</span><br><span class="line">    serviceUrl = &quot;http://localhost:8761/eureka&quot;</span><br><span class="line">    application = &quot;default&quot;</span><br><span class="line">    weight = &quot;1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  redis &#123;</span><br><span class="line">    serverAddr = &quot;localhost:6379&quot;</span><br><span class="line">    db = 0</span><br><span class="line">    password = &quot;&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    timeout = 0</span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br><span class="line">    sessionTimeout = 6000</span><br><span class="line">    connectTimeout = 2000</span><br><span class="line">    username = &quot;&quot;</span><br><span class="line">    password = &quot;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:8500&quot;</span><br><span class="line">    aclToken = &quot;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    serverAddr = &quot;http://localhost:2379&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  sofa &#123;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:9603&quot;</span><br><span class="line">    application = &quot;default&quot;</span><br><span class="line">    region = &quot;DEFAULT_ZONE&quot;</span><br><span class="line">    datacenter = &quot;DefaultDataCenter&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">    group = &quot;SEATA_GROUP&quot;</span><br><span class="line">    addressWaitTime = &quot;3000&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name = &quot;file.conf&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> file、nacos 、apollo、zk、consul、etcd3</span></span><br><span class="line">  type = &quot;file&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:8848&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">    group = &quot;SEATA_GROUP&quot;</span><br><span class="line">    username = &quot;&quot;</span><br><span class="line">    password = &quot;&quot;</span><br><span class="line">    dataId = &quot;seataServer.properties&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:8500&quot;</span><br><span class="line">    aclToken = &quot;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  apollo &#123;</span><br><span class="line">    appId = &quot;seata-server&quot;</span><br><span class="line">    ## apolloConfigService will cover apolloMeta</span><br><span class="line">    apolloMeta = &quot;http://192.168.1.204:8801&quot;</span><br><span class="line">    apolloConfigService = &quot;http://192.168.1.204:8080&quot;</span><br><span class="line">    namespace = &quot;application&quot;</span><br><span class="line">    apolloAccesskeySecret = &quot;&quot;</span><br><span class="line">    cluster = &quot;seata&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    serverAddr = &quot;127.0.0.1:2181&quot;</span><br><span class="line">    sessionTimeout = 6000</span><br><span class="line">    connectTimeout = 2000</span><br><span class="line">    username = &quot;&quot;</span><br><span class="line">    password = &quot;&quot;</span><br><span class="line">    nodePath = &quot;/seata/seata.properties&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    serverAddr = &quot;http://localhost:2379&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name = &quot;file.conf&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>第五步</p>
</blockquote>
<p>启动两个TC Server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 第一个</span></span><br><span class="line">./seata-server.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 第二个 因为端口冲突 所以换个端口</span></span><br><span class="line">./seata-server.sh -p 18091 -n 1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -p: Seata TC Server监听的端口</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -n：Server node，在多个TC Server时，需区分各自节点，用于生产不同区间的transactionId事务编号，以免冲突；</span></span><br></pre></td></tr></table></figure>
<p>启动完成，查看nacos，如下：</p>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211007200135377.png" alt="image-20211007200135377"></p>
<blockquote>
<p>第六步</p>
</blockquote>
<p>进行测试</p>
<blockquote>
<p>集群配置</p>
</blockquote>
<p>其他代码查看<code>5.4.1</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#--------------------------[Seata server 集群配置]--------------------------------------------</span></span><br><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="comment"># seate应用编号，默认为$&#123;spring.application.name&#125;</span></span><br><span class="line">  <span class="attr">application-id:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">  <span class="comment">#seate事务组编号，用于TC集群名称</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">$&#123;spring.application.name&#125;-group</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="comment"># 虚拟组和分组的映射</span></span><br><span class="line">    <span class="attr">vgroup-mapping.springboot-server-seata-monomer-group:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span></span><br><span class="line">      <span class="attr">cluster:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">111.231</span><span class="number">.207</span><span class="number">.228</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">2020Fate!</span></span><br></pre></td></tr></table></figure>
<h2 id="TCC模式"><a href="#TCC模式" class="headerlink" title="TCC模式"></a>TCC模式</h2><p>AT模式基本上能满足我们使用分布式事务大部分需求，但设计非关系型数据库与中间件的操作、跨公司服务的调用、跨语言的应用调用就需要结合TCC模式；</p>
<h3 id="执行机制"><a href="#执行机制" class="headerlink" title="执行机制"></a>执行机制</h3><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211007210002098.png" alt="image-20211007210002098"></p>
<p>一个分布式的全局事务，整体是两个阶段提交（<code>Try</code>-<code>[Comifrm/Cancel]</code>）的模型，在seata中，AT模式与TCC模式事实上都是基于两阶段提交实现的，它们的区别在与：</p>
<p><code>AT模式基于支持本地ACID事务的关系型数据库</code>：</p>
<p>1、一阶段prepare行为：在本地事务中，一并提交“业务数据更新”和“相应回滚日志记录”；</p>
<p>2、二阶段commit行为：马上成功结束，自动异步批量清理回滚日志；</p>
<p>3、二阶段rollback行为：通过回滚日志，自动生成补偿操作，完成数据库回滚；</p>
<p><code>TCC模式，需要我们认为编写代码实现提交和回滚</code>：</p>
<p>1、一阶段prepare行为：调用自定义的perpare逻辑；</p>
<p>2、二阶段commit行为：调用自定义的commit逻辑；</p>
<p>3、二阶段rollback行为：调用自定义的rollback逻辑；</p>
<p>所以TCC模式，就是把自定义的分支事务的提交和回滚并纳入到全局事务管理中，通俗的说seata中TCC模式就是手工版的AT模式，它允许你自定义两个阶段的处理逻辑而不需要依赖AT模式的undo_log回滚表;</p>
<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>与5.4.1差不多，需要更改的如下</p>
<p><code>ProductService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@LocalTCC</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">Product</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 减库存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> productId 商品 ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount    扣减数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception 扣减失败时抛出异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TwoPhaseBusinessAction(name = &quot;reduceStock&quot;,commitMethod = &quot;commitTcc&quot;,rollbackMethod = &quot;cancelTcc&quot;)</span></span><br><span class="line">    <span class="function">Product <span class="title">reduceStock</span><span class="params">(<span class="meta">@BusinessActionContextParameter(paramName = &quot;productId&quot;)</span> Integer productId,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="meta">@BusinessActionContextParameter(paramName = &quot;amount&quot;)</span> Integer amount)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第二阶段 提交方法</span></span><br><span class="line"><span class="comment">     * 可以另命名，要保证与commitMethod一致</span></span><br><span class="line"><span class="comment">     * context可以传递try方法的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">commitTcc</span><span class="params">(BusinessActionContext context)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第二阶段 回滚方法</span></span><br><span class="line"><span class="comment">     * 可以另命名，要保证与commitMethod一致</span></span><br><span class="line"><span class="comment">     * context可以传递try方法的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancelTcc</span><span class="params">(BusinessActionContext context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ProductServiceImpl</code>实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">ProductMapper</span>, <span class="title">Product</span>&gt; <span class="keyword">implements</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    ProductMapper productMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@DS(value = &quot;product-ds&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">reduceStock</span><span class="params">(Integer productId, Integer amount)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;当前 XID: &#123;&#125;&quot;</span>, RootContext.getXID());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查库存</span></span><br><span class="line">        Product product = productMapper.selectByPrimaryKey(productId);</span><br><span class="line">        <span class="keyword">if</span> (product.getStock() &lt; amount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 扣减库存</span></span><br><span class="line">        <span class="keyword">int</span> updateCount = productMapper.reduceStock(productId, amount);</span><br><span class="line">        <span class="comment">// 扣除成功</span></span><br><span class="line">        <span class="keyword">if</span> (updateCount == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 扣除成功</span></span><br><span class="line">        log.info(<span class="string">&quot;扣除 &#123;&#125; 库存成功&quot;</span>, productId);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第二阶段 提交方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">commitTcc</span><span class="params">(BusinessActionContext context)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;TCC第二阶段提交，ProductServiceImpl，commitTcc--&gt;xid = &#123;&#125;&quot;</span>,context.getXid()+<span class="string">&quot; ,commitTcc 提交成功！！！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第二阶段 回滚方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@DS(value = &quot;product-ds&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancelTcc</span><span class="params">(BusinessActionContext context)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;TCC第二阶段回滚，ProductServiceImpl，cancelTcc--&gt;xid = &#123;&#125;&quot;</span>,context.getXid()+<span class="string">&quot; ,cancelTcc 提交失败！！！&quot;</span>);</span><br><span class="line">        <span class="comment">//TODO 这里可以实现中间件，非关系型数据库的回滚操作</span></span><br><span class="line">        Integer productId = (Integer) context.getActionContext(<span class="string">&quot;productId&quot;</span>);</span><br><span class="line">        Integer amount = (Integer) context.getActionContext(<span class="string">&quot;amount&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;Cancel阶段，AccountServiceImpl，cancelTcc this data:productId = &#123;&#125;,amount = &#123;&#125;&quot;</span>,productId,amount);</span><br><span class="line">        <span class="comment">//进行回滚操作 加库存</span></span><br><span class="line">        productMapper.increaseStock(productId, amount);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AccountService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@LocalTCC</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">Account</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义两阶段提交</span></span><br><span class="line"><span class="comment">     * //<span class="doctag">@TwoPhaseBusinessAction</span>(name=&quot;reduceBalance&quot;,commitMethod = &quot;commitTcc&quot;,rollbackMethod = &quot;cancelTcc&quot;)</span></span><br><span class="line"><span class="comment">     * name=reduceBalance 为一阶段try方法</span></span><br><span class="line"><span class="comment">     * commitMethod=commitTcc 为二阶段提交方法</span></span><br><span class="line"><span class="comment">     * rollbackMethod=cancelTcc 为二阶段回滚方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * //<span class="doctag">@BusinessActionContextParameter</span>   将参数放入上下文，方便后面拿到参数进行回滚操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 减余额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> money  扣减金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception 失败时抛出异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TwoPhaseBusinessAction(name=&quot;reduceBalance&quot;,commitMethod = &quot;commitTcc&quot;,rollbackMethod = &quot;cancelTcc&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reduceBalance</span><span class="params">(<span class="meta">@BusinessActionContextParameter(paramName = &quot;userId&quot;)</span> Integer userId,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="meta">@BusinessActionContextParameter(paramName = &quot;money&quot;)</span>  BigDecimal money)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第二阶段 提交方法</span></span><br><span class="line"><span class="comment">     * 可以另命名，要保证与commitMethod一致</span></span><br><span class="line"><span class="comment">     * context可以传递try方法的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">commitTcc</span><span class="params">(BusinessActionContext context)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第二阶段 回滚方法</span></span><br><span class="line"><span class="comment">     * 可以另命名，要保证与commitMethod一致</span></span><br><span class="line"><span class="comment">     * context可以传递try方法的参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancelTcc</span><span class="params">(BusinessActionContext context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AccountServiceImpl</code>实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">AccountMapper</span>,<span class="title">Account</span>&gt; <span class="keyword">implements</span> <span class="title">AccountService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@DS(value = &quot;account-ds&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceBalance</span><span class="params">(Integer userId, BigDecimal money)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;当前 XID: &#123;&#125;&quot;</span>, RootContext.getXID());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查余额</span></span><br><span class="line">        Account account = accountMapper.selectAccountByUserId(userId);</span><br><span class="line">        <span class="keyword">if</span> (account.getBalance().doubleValue() &lt; money.doubleValue()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;余额不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 扣除余额</span></span><br><span class="line">        <span class="keyword">int</span> updateCount = accountMapper.reduceBalance(userId, money);</span><br><span class="line">        <span class="comment">// 扣除成功</span></span><br><span class="line">        <span class="keyword">if</span> (updateCount == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;余额不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;扣除用户 &#123;&#125; 余额成功&quot;</span>, userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第二阶段 提交方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">commitTcc</span><span class="params">(BusinessActionContext context)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;TCC第二阶段提交，AccountServiceImpl，commitTcc--&gt;xid = &#123;&#125;&quot;</span>,context.getXid()+<span class="string">&quot; ,commitTcc 提交成功！！！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第二阶段 回滚方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context 上下文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> boolean</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@DS(value = &quot;account-ds&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancelTcc</span><span class="params">(BusinessActionContext context)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;TCC第二阶段回滚，AccountServiceImpl，cancelTcc--&gt;xid = &#123;&#125;&quot;</span>,context.getXid()+<span class="string">&quot; ,cancelTcc 提交失败！！！&quot;</span>);</span><br><span class="line">        <span class="comment">//TODO 这里可以实现中间件，非关系型数据库的回滚操作</span></span><br><span class="line">        Integer userId = (Integer) context.getActionContext(<span class="string">&quot;userId&quot;</span>);</span><br><span class="line">        BigDecimal money = (BigDecimal) context.getActionContext(<span class="string">&quot;money&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;Cancel阶段，AccountServiceImpl，cancelTcc this data:userId = &#123;&#125;,money = &#123;&#125;&quot;</span>,userId,money);</span><br><span class="line">        <span class="comment">//进行回滚操作 加余额</span></span><br><span class="line">        accountMapper.increaseBalance(userId, money);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成</p>
<h1 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h1><p>按照官方的定义，Spring Cloud Stream 是一个构建消息驱动微服务的框架；</p>
<p>Spring Cloud Stream解决了开发人员无感知的使用消息中间件的问题，因为Spring Cloud Stream对消息中间件的进一步封装，可以做到代码层面对消息中间件的无感知，甚至于动态的切换中间件(rabbitmq切换为rocketmq或者kafka)，使得微服务开发的高度解耦，服务可以关注更多自己的业务流程；</p>
<h2 id="重要概念"><a href="#重要概念" class="headerlink" title="重要概念"></a>重要概念</h2><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211008203121152.png" alt="image-20211008203121152"></p>
<p><code>spring cloud stream内部有几个概念：Binder、Binding、input、output</code></p>
<p>1、Binder：跟外部消息中间件集成的组件，用来创建Binding，各消息中间件都有自己的Binder实现；</p>
<p>2、Binding：包括Input Binding和Output Binding；Binding在消息中间件与应用程序提供的Provider和Consumer之间提供了一个桥梁，实现了开发者只需要应用程序的Provider和Consumer生成或消费数据即可；</p>
<p>3、Input：应用程序通过input（相当于消费者consumer）与spring cloud stream中的Binder交互，而Binder负责与消息中间件交互，因此，我们只需要关注如何与Binder交互即可；</p>
<p>4、Output：output（相当于生产者producer）与spring cloud stream中的Binder交互；</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>组成部分</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Binder</td>
<td>Binder是应用与消息中间件之间的封装，目前实现了kafka和RabbitMQ的Binder,通过Binder可以很方便的连接中间件，可以动态的改变消息类型(对对应于Kafka和topic，RabbitMQ的exchange)这些都可以通过配置文件来实现；</td>
</tr>
<tr>
<td>@Input</td>
<td>该注解标识通道，通过该输入通道接收消息进入应用程序</td>
</tr>
<tr>
<td>@Output</td>
<td>该注解标识输出通道，发布的消息将通过该通道离开应用程序</td>
</tr>
<tr>
<td>@StreamListener</td>
<td>监听队列，用于消费者的队列的消息接收</td>
</tr>
<tr>
<td>@EnableBinding</td>
<td>将通道channel和exchange绑定在一起</td>
</tr>
</tbody>
</table>
</div>
<h2 id="集成RocketMq"><a href="#集成RocketMq" class="headerlink" title="集成RocketMq"></a>集成RocketMq</h2><blockquote>
<p>1、依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-cloud-alibaba.version</span>&gt;</span>2.2.1.RELEASE <span class="tag">&lt;/<span class="name">spring-cloud-alibaba.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rocketmq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 继承 spring cloud Alibaba依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 继承 spring boot依赖--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>2、配置</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># stream集成rocketmq的客户端接入点</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">rocketmq:</span></span><br><span class="line">        <span class="attr">binder:</span></span><br><span class="line">          <span class="attr">name-server:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9876</span></span><br><span class="line">      <span class="attr">bindings:</span></span><br><span class="line">        <span class="comment">#input 消费者</span></span><br><span class="line">        <span class="attr">input:</span></span><br><span class="line">          <span class="comment"># 发往哪里</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">test-topic</span></span><br><span class="line">          <span class="comment"># 内容格式</span></span><br><span class="line">          <span class="attr">ontent-type:</span> <span class="string">text/plain</span></span><br><span class="line">          <span class="comment"># 分组</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">test-group</span></span><br><span class="line">        <span class="comment"># output 生产者</span></span><br><span class="line">        <span class="attr">output:</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">test-topic</span></span><br><span class="line">          <span class="attr">ontent-type:</span> <span class="string">text/plain</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">test-group</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>3、生产者</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SenderService</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> Source source;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String msg)</span></span>&#123;</span><br><span class="line">        <span class="comment">//source.output() == messageChannel消息通道</span></span><br><span class="line">        <span class="keyword">boolean</span> send = source.output().send(MessageBuilder.withPayload(msg).build());</span><br><span class="line">        System.out.println(<span class="string">&quot;消息发送&quot;</span>+(send?<span class="string">&quot;成功&quot;</span>:<span class="string">&quot;失败&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>4、消费者</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiveService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * spring cloud stream 里面发消息通过sink发送</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    Sink sink;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * springboot里面通过RocketTemplate发送</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sink.input().subscribe((Message&lt;?&gt; message)-&gt;&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;接收消息:&quot;</span>+message.getPayload());</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监听接收消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> receiveMsg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@StreamListener(&quot;input&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveInput1</span><span class="params">(String receiveMsg)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;input 接收到的消息: &quot;</span> + receiveMsg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>注意：需要将Sink和Source交给spring容器管理@EnableBinding(value = &#123;Source.class, Sink.class&#125;)</code></p>
<blockquote>
<p>整体流程</p>
</blockquote>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211010162649312.png" alt="image-20211010162649312"></p>
<h2 id="自定义信道"><a href="#自定义信道" class="headerlink" title="自定义信道"></a>自定义信道</h2><p><code>只需要自定义Sink和Source就可以了</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义发送消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> July</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TestSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String OUTPUT = <span class="string">&quot;testOutput&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Output(TestSource.OUTPUT)</span></span><br><span class="line">    <span class="function">MessageChannel <span class="title">testOutput</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义接收消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> July</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TestSink</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String INPUT = <span class="string">&quot;testInput&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Input(TestSink.INPUT)</span></span><br><span class="line">    <span class="function">SubscribableChannel <span class="title">testInput</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置文件</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  # stream集成rocketmq的客户端接入点</span><br><span class="line">  cloud:</span><br><span class="line">    stream:</span><br><span class="line">      rocketmq:</span><br><span class="line">        binder:</span><br><span class="line">          name-server: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9876</span></span><br><span class="line">      bindings:</span><br><span class="line">        #testInput 跟TestSink里面的值对应 消费者</span><br><span class="line">        testInput:</span><br><span class="line">          # 发往哪里</span><br><span class="line">          destination: test-input-topic</span><br><span class="line">          # 内容格式</span><br><span class="line">          ontent-type: text/plain</span><br><span class="line">          # 分组 如果组一样就是竞争接收，如果不一样就是平等接收</span><br><span class="line">          group: test-group</span><br><span class="line">        # testOutput 跟TestSource里面的值对应 生产者</span><br><span class="line">        testOutput:</span><br><span class="line">          destination: est-input-topic</span><br><span class="line">          ontent-type: text/plain</span><br><span class="line">          group: test-group</span><br></pre></td></tr></table></figure>
<p><code>注意：需要将TestSink和TestSource交给spring容器管理@EnableBinding(value = &#123;TestSource.class, TestSink.class&#125;)</code></p>
<h2 id="事务消息"><a href="#事务消息" class="headerlink" title="事务消息"></a>事务消息</h2><p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211010165434559.png" alt="image-20211010165434559"></p>
<p>图中分为两个流程：正常事务消息的发送及提交、事务消息的补偿流程；</p>
<blockquote>
<p>1.事务消息发送及提交</p>
</blockquote>
<p>1、发送消息（half消息）</p>
<p>2、服务端相应消息写入结果</p>
<p>3、根据发送结果执行本地事务（如果写写入失败，此时half消息对业务不可见，本地逻辑不执行）</p>
<p>4、根据本地事务状态执行Commit和Rollback（commit操作生成消息索引，消息对消费者可见）</p>
<blockquote>
<p>2.补偿流程</p>
</blockquote>
<p>1、对没有Commit/Rollback的事务消息（pending状态的消息），从服务端发起一次“会查”；</p>
<p>2、Producer收到会查消息，检查会查消息对应的本地事务的状态；</p>
<p>3、根据本地事务状态，重写Commit或者Rollbakc；</p>
<p>其中，补偿阶段用于解决消息Commit或Rollbakc发生超时或者失败的情况；</p>
<p>事务消息一共有三种状态：提交状态、回滚状态、中间状态;</p>
<blockquote>
<p>提交状态</p>
</blockquote>
<p>​    TransactionStatus.CommitTransaction：提交事务，代表消费者可以消费此消息；</p>
<blockquote>
<p>回滚状态</p>
</blockquote>
<p>​    TransactionStatus.RollbackTransaction：回滚事务，代表消息将被删除，不能被消费；</p>
<blockquote>
<p>中间状态</p>
</blockquote>
<p>​    TransactionStatus.Unknown：中间状态，代表需要检查消息队列来确定状态；</p>
<blockquote>
<p>案例</p>
<p>1、生产者</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxSend</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    TestSource testSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">sendTransactionalMsg</span><span class="params">(T msg,<span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">        Message&lt;T&gt; send = MessageBuilder.withPayload(msg)</span><br><span class="line">                .setHeader(MessageHeaders.CONTENT_TYPE, MimeTypeUtils.APPLICATION_JSON)</span><br><span class="line">                .setHeader(<span class="string">&quot;test&quot;</span>, String.valueOf(num))</span><br><span class="line">                .build();</span><br><span class="line">        testSource.outputTx().send(send);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>事务实现</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * txProducerGroup 事务分组名称</span></span><br><span class="line"><span class="comment"> * corePoolSize 核心线程数</span></span><br><span class="line"><span class="comment"> * maximumPoolSize 最大线程数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> July</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RocketMQTransactionListener(txProducerGroup = &quot;myTxProducerGroup&quot;,corePoolSize = 5, maximumPoolSize = 10)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionListenerImpl</span> <span class="keyword">implements</span> <span class="title">RocketMQLocalTransactionListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RocketMQLocalTransactionState <span class="title">executeLocalTransaction</span><span class="params">(Message message, Object o)</span> </span>&#123;</span><br><span class="line">        Object test = message.getHeaders().get(<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        <span class="comment">//如果等于1 就让他保持 中间状态等待回调检查</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;1&quot;</span>.equals(test))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;executer: &quot;</span> + <span class="keyword">new</span> String((<span class="keyword">byte</span>[]) message.getPayload()) + <span class="string">&quot; unknown&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> RocketMQLocalTransactionState.UNKNOWN;</span><br><span class="line">        <span class="comment">// 如果等于2 就回滚，消息不可见</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;2&quot;</span>.equals(test)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;executer: &quot;</span> + <span class="keyword">new</span> String((<span class="keyword">byte</span>[]) message.getPayload()) + <span class="string">&quot; rollback&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//其他 消息提交，消费者可见</span></span><br><span class="line">        System.out.println(<span class="string">&quot;executer: &quot;</span> + <span class="keyword">new</span> String((<span class="keyword">byte</span>[]) message.getPayload()) + <span class="string">&quot; commit&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> RocketMQLocalTransactionState.COMMIT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 回调检查</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RocketMQLocalTransactionState <span class="title">checkLocalTransaction</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;check: &quot;</span> + <span class="keyword">new</span> String((<span class="keyword">byte</span>[]) message.getPayload()));</span><br><span class="line">        <span class="keyword">return</span> RocketMQLocalTransactionState.COMMIT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>配置文件</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># stream集成rocketmq的客户端接入点</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">rocketmq:</span></span><br><span class="line">        <span class="attr">binder:</span></span><br><span class="line">          <span class="attr">name-server:</span> <span class="number">111.231</span><span class="number">.207</span><span class="number">.228</span><span class="string">:9876</span></span><br><span class="line">        <span class="attr">bindings:</span></span><br><span class="line">       	  <span class="comment"># 配置 rocketmq 生产者</span></span><br><span class="line">          <span class="attr">outputTX:</span></span><br><span class="line">            <span class="attr">producer:</span></span><br><span class="line">              <span class="comment"># 开启事务 默认是关闭的</span></span><br><span class="line">              <span class="attr">transactional:</span> <span class="literal">true</span></span><br><span class="line">              <span class="comment"># 开始事务分组</span></span><br><span class="line">              <span class="attr">group:</span> <span class="string">myTxProducerGroup</span></span><br><span class="line"><span class="comment">#--------------- 事务消息 ---------------------------</span></span><br><span class="line">        <span class="attr">inputTX:</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">transaction-topic</span></span><br><span class="line">          <span class="attr">ontent-type:</span> <span class="string">text/plain</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">transaction-group</span></span><br><span class="line">        <span class="comment"># output 生产者</span></span><br><span class="line">        <span class="attr">outputTX:</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">transaction-topic</span></span><br><span class="line">          <span class="attr">ontent-type:</span> <span class="string">text/json</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试结果</p>
</blockquote>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">executer: send 1 unknown</span><br><span class="line">executer: send 2 rollback</span><br><span class="line">executer: send 3 commit</span><br><span class="line">接收到事务的消息: send 3</span><br><span class="line">check: send 1</span><br><span class="line">接收到事务的消息: send 1</span><br></pre></td></tr></table></figure>
<h2 id="对象标签消息"><a href="#对象标签消息" class="headerlink" title="对象标签消息"></a>对象标签消息</h2><blockquote>
<p>配置文件</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">springcloud-service-stream-rocketmq</span></span><br><span class="line">  <span class="comment"># stream集成rocketmq的客户端接入点</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">rocketmq:</span></span><br><span class="line">        <span class="attr">binder:</span></span><br><span class="line">          <span class="attr">name-server:</span> <span class="number">111.231</span><span class="number">.207</span><span class="number">.228</span><span class="string">:9876</span></span><br><span class="line">        <span class="attr">bindings:</span></span><br><span class="line">          <span class="comment"># 指定testInput 只接收标签为user1的数据</span></span><br><span class="line">          <span class="attr">testInput:</span></span><br><span class="line">            <span class="attr">consumer:</span></span><br><span class="line">              <span class="attr">tags:</span> <span class="string">user1</span></span><br><span class="line">      <span class="attr">bindings:</span></span><br><span class="line"><span class="comment">#--------------- 自定义消息 ---------------------------</span></span><br><span class="line">        <span class="comment">#input 消费者</span></span><br><span class="line">        <span class="attr">testInput:</span></span><br><span class="line">          <span class="comment"># 发往哪里</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">test-input-topic</span></span><br><span class="line">          <span class="comment"># 内容格式</span></span><br><span class="line">          <span class="attr">ontent-type:</span> <span class="string">text/plain</span></span><br><span class="line">          <span class="comment"># 分组 如果组一样就是竞争接收，如果不一样就是平等接收</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">test-group1</span></span><br><span class="line">        <span class="comment"># output 生产者</span></span><br><span class="line">        <span class="attr">testOutput:</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">test-input-topic</span></span><br><span class="line">          <span class="attr">ontent-type:</span> <span class="string">text/plain</span></span><br><span class="line">          <span class="comment"># 分组 如果组一样就是竞争接收，如果不一样就是平等接收</span></span><br><span class="line">          <span class="attr">group:</span> <span class="string">test-group1</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>生产者</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SenderService</span>  </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    TestSource testSource;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对象标签消息发送</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tag</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">sendObject</span><span class="params">(T msg,String tag)</span></span>&#123;</span><br><span class="line">        Message&lt;T&gt; build = MessageBuilder.withPayload(msg)</span><br><span class="line">            	<span class="comment">//指定内容标签</span></span><br><span class="line">                .setHeader(MessageConst.PROPERTY_TAGS, tag)</span><br><span class="line">                .setHeader(MessageHeaders.CONTENT_TYPE, MimeTypeUtils.APPLICATION_JSON)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">boolean</span> send = testSource.testOutput().send(build);</span><br><span class="line">        System.out.println(<span class="string">&quot;对象标签消息内容:&quot;</span>+msg.toString()+<span class="string">&quot; 发送：&quot;</span>+(send?<span class="string">&quot;成功&quot;</span>:<span class="string">&quot;失败&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> Test&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//发送对象标签消息</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUsername(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">        user.setSex(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        User user1 = <span class="keyword">new</span> User();</span><br><span class="line">        user1.setUsername(<span class="string">&quot;王五&quot;</span>);</span><br><span class="line">        user1.setSex(<span class="string">&quot;女&quot;</span>);</span><br><span class="line">        senderService.sendObject(user,<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        senderService.sendObject(user1,<span class="string">&quot;user1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://myiszhb-blog.oss-cn-beijing.aliyuncs.com/blog/image-20211010190335307.png" alt="image-20211010190335307"></p>
<h2 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h2><blockquote>
<p>RockerMQ Producer Properties</p>
</blockquote>
<p>以 spring.cloud.stream.rocketmq.bindings.<channelName>.producer. 为前缀的RocketMQ Producer 相关的配置</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">作用</th>
<th style="text-align:center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">enable</td>
<td style="text-align:center">是否启用producer</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">group</td>
<td style="text-align:center">producer的分组名称</td>
<td style="text-align:center">空的</td>
</tr>
<tr>
<td style="text-align:center">maxMessageSize</td>
<td style="text-align:center">消息发送最大字节数</td>
<td style="text-align:center">8249344</td>
</tr>
<tr>
<td style="text-align:center">transactional</td>
<td style="text-align:center">是否开启事务</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">sync</td>
<td style="text-align:center">是否使用同步方式发送消息</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">sendMessageTimeout</td>
<td style="text-align:center">发送消息的超时时间（毫秒）</td>
<td style="text-align:center">3000</td>
</tr>
<tr>
<td style="text-align:center">compressMessageBodyThreshold</td>
<td style="text-align:center">消息体压缩阈值（当消息体超过4k是会被压缩）</td>
<td style="text-align:center">4096</td>
</tr>
<tr>
<td style="text-align:center">retryTimesWhenSendFaild</td>
<td style="text-align:center">在同步发送消息的模式下，消息发送失败的重试次数</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">trtryNextServer</td>
<td style="text-align:center">消息发送失败的情况下是否重试其他的broker</td>
<td style="text-align:center">false</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>RockerMQ Consumer Properties</p>
</blockquote>
<p>以 spring.cloud.stream.rocketmq.bindings.<channelName>.consumer. 为前缀的 RocketMQ Consumer 相关的配置</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">作用</th>
<th style="text-align:center">默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">enable</td>
<td style="text-align:center">是否启用consumer</td>
<td style="text-align:center">true</td>
</tr>
<tr>
<td style="text-align:center">tags</td>
<td style="text-align:center">consumer基于tags订阅，多个以\</td>
<td style="text-align:center">\</td>
<td>分割</td>
<td>空的</td>
</tr>
<tr>
<td style="text-align:center">sql</td>
<td style="text-align:center">consumer基于sql订阅</td>
<td style="text-align:center">空的</td>
</tr>
<tr>
<td style="text-align:center">broadcasting</td>
<td style="text-align:center">consumer是否广播消费模式，如果想让所有的订阅者都能接收到消息，可以使用</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">orderly</td>
<td style="text-align:center">consumer是否同步消费者模式</td>
<td style="text-align:center">false</td>
</tr>
<tr>
<td style="text-align:center">delayLevelWhenNextConsumer</td>
<td style="text-align:center">异步消费者模式下消息失败重试策略；-1=不重复，直接放入死信队列。0=broker，控制重试策略。&gt;0=client控制重设策略</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">superendCurrentQueueTimeMillis</td>
<td style="text-align:center">同步消费模式下消息失败后再次消费的时间间隔</td>
<td style="text-align:center">1000</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>RocketMQ Binder Properties</p>
</blockquote>
<div class="table-container">
<table>
<thead>
<tr>
<th>名称</th>
<th>作用</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>spring.cloud.stream.rocketmq.binder.name-server</td>
<td>RocketMQ NameServer 地址</td>
<td>127.0.0.1:9876</td>
</tr>
<tr>
<td>spring.cloud.stream.rocketmq.binder.access-key</td>
<td>阿里云账号 AccessKey</td>
<td>null</td>
</tr>
<tr>
<td>spring.cloud.stream.rocketmq.binder.secret-key</td>
<td>阿里云账号 SecretKey</td>
<td>null</td>
</tr>
<tr>
<td>spring.cloud.stream.rocketmq.binder.enable-msg-trace</td>
<td>是否为producer和consumer开启消息轨迹功能</td>
<td>true</td>
</tr>
<tr>
<td>spring.cloud.stream.rocketmq.binder.customized-trace-topic</td>
<td>消息轨迹开启后存储的topic名称</td>
<td>RMQ_SYS_TRACE_TOPIC</td>
</tr>
</tbody>
</table>
</div>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">七月</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.isfate.xyz/article/f3b61b38.html">https://www.isfate.xyz/article/f3b61b38.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.isfate.xyz" target="_blank">七月のBlog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></div><div class="post_share"><div class="social-share" data-image="http://api.mtyqx.cn/api/random.php?35" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.zhimg.com/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.zhimg.com/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/article/fc7b4587.html"><img class="prev-cover" src="http://api.mtyqx.cn/api/random.php?29" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">rabbitmq学习(一)</div></div></a></div><div class="next-post pull-right"><a href="/article/6dd28e9b.html"><img class="next-cover" src="http://api.mtyqx.cn/api/random.php?34" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring Cloud Alibaba学习-一</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/article/1db87a14.html" title="Spring Cloud Netflix学习-一"><img class="cover" src="http://api.mtyqx.cn/api/random.php?36" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-08</div><div class="title">Spring Cloud Netflix学习-一</div></div></a></div><div><a href="/article/6dd28e9b.html" title="Spring Cloud Alibaba学习-一"><img class="cover" src="http://api.mtyqx.cn/api/random.php?34" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-02</div><div class="title">Spring Cloud Alibaba学习-一</div></div></a></div><div><a href="/article/84b12bae.html" title="Spring Cloud Netflix学习-二"><img class="cover" src="http://api.mtyqx.cn/api/random.php?37" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-06-10</div><div class="title">Spring Cloud Netflix学习-二</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/my-zhb/CDN/blog/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">七月</div><div class="author-info__description">起心动念皆是因,当下所受皆是果</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">38</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">14</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:myiszhb@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=410808509" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS订阅"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">大家好我是七月，请多多关照！</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Gateway"><span class="toc-number">1.</span> <span class="toc-text">Gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">1.2.</span> <span class="toc-text">核心概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GateWay%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.3.</span> <span class="toc-text">GateWay如何工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%93%E8%AF%8D%E5%B7%A5%E5%8E%82"><span class="toc-number">1.4.</span> <span class="toc-text">谓词工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#After"><span class="toc-number">1.4.1.</span> <span class="toc-text">After</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Before"><span class="toc-number">1.4.2.</span> <span class="toc-text">Before</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Between"><span class="toc-number">1.4.3.</span> <span class="toc-text">Between</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cookie"><span class="toc-number">1.4.4.</span> <span class="toc-text">cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#header"><span class="toc-number">1.4.5.</span> <span class="toc-text">header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Host"><span class="toc-number">1.4.6.</span> <span class="toc-text">Host</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method"><span class="toc-number">1.4.7.</span> <span class="toc-text">Method</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Path"><span class="toc-number">1.4.8.</span> <span class="toc-text">Path</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Query"><span class="toc-number">1.4.9.</span> <span class="toc-text">Query</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RemoteAddr"><span class="toc-number">1.4.10.</span> <span class="toc-text">RemoteAddr</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Weight"><span class="toc-number">1.4.11.</span> <span class="toc-text">Weight</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%B7%A5%E5%8E%82"><span class="toc-number">1.5.</span> <span class="toc-text">过滤工厂</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B0%93%E8%AF%8D"><span class="toc-number">1.6.</span> <span class="toc-text">自定义谓词</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B1%EF%BC%9A%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.6.1.</span> <span class="toc-text">案例1：实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B2%EF%BC%9A%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.6.2.</span> <span class="toc-text">案例2：实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%93%E8%AF%8D%E4%B8%8D%E5%8C%B9%E9%85%8D%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%94%E5%9B%9E"><span class="toc-number">1.6.3.</span> <span class="toc-text">谓词不匹配自定义返回</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.7.</span> <span class="toc-text">自定义网关过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%B8%AA%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.7.1.</span> <span class="toc-text">单个网关过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E7%BD%91%E5%85%B3%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.7.2.</span> <span class="toc-text">全局网关过滤器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90ribbon%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.8.</span> <span class="toc-text">集成ribbon负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E9%9B%86%E6%88%90sentienl"><span class="toc-number">1.9.</span> <span class="toc-text">网关集成sentienl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E6%B5%81"><span class="toc-number">1.9.1.</span> <span class="toc-text">限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.9.2.</span> <span class="toc-text">自定义错误页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6"><span class="toc-number">1.9.3.</span> <span class="toc-text">持久化本地文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E5%88%B0Nacos"><span class="toc-number">1.9.4.</span> <span class="toc-text">持久化到Nacos</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CORS%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-number">1.10.</span> <span class="toc-text">CORS跨域问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.11.</span> <span class="toc-text">内部执行流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SkyWalking"><span class="toc-number">2.</span> <span class="toc-text">SkyWalking</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFSkyWalking"><span class="toc-number">2.1.</span> <span class="toc-text">什么是SkyWalking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%E7%89%B9%E6%80%A7"><span class="toc-number">2.2.</span> <span class="toc-text">主要功能特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%9E%84%E6%88%90"><span class="toc-number">2.3.</span> <span class="toc-text">整体构成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.4.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA"><span class="toc-number">2.5.</span> <span class="toc-text">链路追踪</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#idea%E6%9C%AC%E5%9C%B0%E8%B0%83%E8%AF%95"><span class="toc-number">2.5.1.</span> <span class="toc-text">idea本地调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jar%E5%8C%85%E5%90%AF%E5%8A%A8"><span class="toc-number">2.5.2.</span> <span class="toc-text">jar包启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#war%E5%8C%85%E5%90%AF%E5%8A%A8"><span class="toc-number">2.5.3.</span> <span class="toc-text">war包启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SkyWalking%E4%B8%89%E4%B8%AA%E6%A6%82%E5%BF%B5"><span class="toc-number">2.5.4.</span> <span class="toc-text">SkyWalking三个概念</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SkyWalking%E5%91%8A%E8%AD%A6"><span class="toc-number">2.6.</span> <span class="toc-text">SkyWalking告警</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">2.7.</span> <span class="toc-text">持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql"><span class="toc-number">2.7.1.</span> <span class="toc-text">mysql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ElasticSearch"><span class="toc-number">2.7.2.</span> <span class="toc-text">ElasticSearch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%93%BE%E8%B7%AF"><span class="toc-number">2.8.</span> <span class="toc-text">自定义链路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96TraceId"><span class="toc-number">2.8.1.</span> <span class="toc-text">获取TraceId</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Trace%E6%B3%A8%E8%A7%A3"><span class="toc-number">2.8.2.</span> <span class="toc-text">@Trace注解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SkyWalking%E9%9B%86%E6%88%90%E6%97%A5%E5%BF%97"><span class="toc-number">2.9.</span> <span class="toc-text">SkyWalking集成日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SkyWalking-UI"><span class="toc-number">2.10.</span> <span class="toc-text">SkyWalking UI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="toc-number">2.10.1.</span> <span class="toc-text">仪表盘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%93%E6%89%91%E5%9B%BE"><span class="toc-number">2.10.2.</span> <span class="toc-text">拓扑图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%BD%E8%B8%AA"><span class="toc-number">2.10.3.</span> <span class="toc-text">追踪</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E5%89%96%E6%9E%90"><span class="toc-number">2.10.4.</span> <span class="toc-text">性能剖析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%8A%E8%AD%A6"><span class="toc-number">2.10.5.</span> <span class="toc-text">告警</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6"><span class="toc-number">2.10.6.</span> <span class="toc-text">事件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SkyWalking%E9%9B%86%E7%BE%A4"><span class="toc-number">2.11.</span> <span class="toc-text">SkyWalking集群</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Seata"><span class="toc-number">3.</span> <span class="toc-text">Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">3.1.</span> <span class="toc-text">分布式事务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFSeata"><span class="toc-number">3.2.</span> <span class="toc-text">什么是Seata</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TC-Server%E9%83%A8%E7%BD%B2"><span class="toc-number">3.3.</span> <span class="toc-text">TC Server部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AT%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.4.</span> <span class="toc-text">AT模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">3.4.1.</span> <span class="toc-text">案例代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%9C%BA%E5%88%B6"><span class="toc-number">3.4.2.</span> <span class="toc-text">工作机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E9%9A%94%E7%A6%BB"><span class="toc-number">3.4.3.</span> <span class="toc-text">写隔离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E9%9A%94%E7%A6%BB"><span class="toc-number">3.4.4.</span> <span class="toc-text">读隔离</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TC-Server%E9%9B%86%E7%BE%A4"><span class="toc-number">3.5.</span> <span class="toc-text">TC Server集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCC%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.6.</span> <span class="toc-text">TCC模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="toc-number">3.6.1.</span> <span class="toc-text">执行机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">3.6.2.</span> <span class="toc-text">案例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Stream"><span class="toc-number">4.</span> <span class="toc-text">Stream</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5"><span class="toc-number">4.1.</span> <span class="toc-text">重要概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90RocketMq"><span class="toc-number">4.2.</span> <span class="toc-text">集成RocketMq</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BF%A1%E9%81%93"><span class="toc-number">4.3.</span> <span class="toc-text">自定义信道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-number">4.4.</span> <span class="toc-text">事务消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E6%A0%87%E7%AD%BE%E6%B6%88%E6%81%AF"><span class="toc-number">4.5.</span> <span class="toc-text">对象标签消息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="toc-number">4.6.</span> <span class="toc-text">相关配置</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/article/a464cc4f.html" title="ubuntu开启root登录"><img src="https://cdn.jsdelivr.net/gh/wayne0926/myphoto/img/dbd.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ubuntu开启root登录"/></a><div class="content"><a class="title" href="/article/a464cc4f.html" title="ubuntu开启root登录">ubuntu开启root登录</a><time datetime="2022-03-03T12:07:43.000Z" title="发表于 2022-03-03 20:07:43">2022-03-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/5cf35c25.html" title="Java中文汉字转拼音工具类"><img src="http://api.mtyqx.cn/api/random.php?28" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java中文汉字转拼音工具类"/></a><div class="content"><a class="title" href="/article/5cf35c25.html" title="Java中文汉字转拼音工具类">Java中文汉字转拼音工具类</a><time datetime="2021-12-09T05:34:00.000Z" title="发表于 2021-12-09 13:34:00">2021-12-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/5cf352a9.html" title="mybatis中sql语句调用Java代码"><img src="http://api.mtyqx.cn/api/random.php?27" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mybatis中sql语句调用Java代码"/></a><div class="content"><a class="title" href="/article/5cf352a9.html" title="mybatis中sql语句调用Java代码">mybatis中sql语句调用Java代码</a><time datetime="2021-12-07T03:21:00.000Z" title="发表于 2021-12-07 11:21:00">2021-12-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/2db9fece.html" title="rabbitmq学习(三)"><img src="http://api.mtyqx.cn/api/random.php?31" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rabbitmq学习(三)"/></a><div class="content"><a class="title" href="/article/2db9fece.html" title="rabbitmq学习(三)">rabbitmq学习(三)</a><time datetime="2021-08-06T11:20:27.000Z" title="发表于 2021-08-06 19:20:27">2021-08-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/534adee5.html" title="rabbitmq学习(二)"><img src="http://api.mtyqx.cn/api/random.php?30" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rabbitmq学习(二)"/></a><div class="content"><a class="title" href="/article/534adee5.html" title="rabbitmq学习(二)">rabbitmq学习(二)</a><time datetime="2021-08-06T11:03:10.000Z" title="发表于 2021-08-06 19:03:10">2021-08-06</time></div></div></div></div></div></div></main><footer id="footer" style="background: rgba(255,255,255,0)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 七月</div><div class="footer_custom_text"><p><a target="_blank" href="https://hexo.io/"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为Hexo"></a>&nbsp;<a target="_blank" href="https://demo.jerryc.me/"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用butterfly"></a>&nbsp;<a target="_blank" href="https://metroui.org.ua/index.html "><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&logo=jsDelivr" title="本站使用JsDelivr为静态资源提供CDN加速"></a> &nbsp;<a target="_blank" href="https://vercel.com/ "><img src="https://img.shields.io/badge/Hosted-Vervel-brightgreen?style=flat&logo=Vercel" title="本站采用双线部署，默认线路托管于Vercel"></a>&nbsp;<a target="_blank" href="https://vercel.com/ "></a>&nbsp;<a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由Gtihub托管"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a>&nbsp;<a target="_blank" href="https://beian.miit.gov.cn"><img src="https://img.shields.io/badge/%E8%9C%80ICP%E5%A4%87-2021030114%E5%8F%B7-e1d492?style=flat&logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAdCAYAAAC9pNwMAAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+nhxg7wAACNlJREFUSInF1mmMVeUdx/Hv2e+5+519mJWBYQZkGxZZxLKJqBXGoLS1iXWrmihotFXaJiTWWlsbl6q1aetWd5u0VkKjNG4YEJSlOCibDLMwM8x679z9nnPP1jcVJUxf+7z6J8+LT37/Z4VvaQhfFS8+sBXbctCDGrVTKlBUH4mxAbI9Hfj0IJLsp6paJ5/tmn20N/D0wKDRMq9F/c3M2U1/V0vDfWMFh+tv/Ig1zYPMabDImPJ52OaXO87W580KggCiiOsJOJ6I3wcNFaaeNKxrt72f2fLGu4FpJ/sDQABRzD22fH7/Yze069vGc6mrDLNIJCDik10sxz2by3VdPM87xzkP9jwPTZFRVI1YUJKH+oy7n3tbvv/P2wW/UQxRWe6w4ZJRptYLHDoCuz8v5cP92XbI762O+h6UVWHnUFbPpU0fEb2A60mMJ7MUi9b/b7UgKhiZMaIxm8YLplLMDPz8hl/EH+rs8TNlUpFf32uyZJGLPDwCiTGUyTWodTN49eUCdz2YwXb9NNcObp1X98WDoufynzMVCEKGn27ayPTWBi5ad8P5iQUkJEnFLjqM9Z+hrVX0vfDe6K2dPRWsW2bwyp9EUifSJB84gdxrkR0eRgv1o/3I4fbbprJ6scqamzVO9pffec1S5ZWY2Nfz5qEy/FqOC2Y3s3j53HMSi18VRjFPwSwg+1RfVbl115vvJrsfej7UGIsYPPGgQ7JXoO+Xx5B3dHEomyJ9x1qiQozkr95h5937aFnVyouPlgJK+Ss7Fxz64OTSxSX+LHYxT2IsRW5kbGI4oHcR0jqoqTjV9se3I7/f8rS/ClS23GxSXhph6L5d9Akm7qqZhHWBQGUJ+CWGFzcg7e7m6D3/ZuW1Ea5YKdA3EojuONi813TqNi+YPYOKUhXDtCeGL26/hakLLiEcdsaHRkRAoLRc4fJrmhnekyF0apgZowWSwwkaa+rw3f8WA1GZZsPP5JEChX8dhZTN6iU6kAcs5s+dHd183SJ0VVKL57pfw6YdRQw23aeWTns47DPTALWlRTR7kMLew6hGgYqUhWXYFFUdPZ6lUBahLA8hVcOftckfi7No7VRAAQqsX1dybfvG1qwriM9mM5mJ4e4jO5Cc01dPqixbr8tWGBQUL4vjGigEEShi+xUmZ2RiR/sJ1pbS8NkgZrKAGw0TsgQsQyFaF/nfYTGprAlMFysbA1pI3mhkR6snhGsaymYGvPyFEb9IdbUE2AzFFTwpRqCtBY0wmdER+hZW4j63gcJj38V+/ErSUZXsYBfjIZHIRW0c2Z8BskCAqN+CbBJBFnyyKjR+Ez57nBxLqpfMUeSISElMBFz6x2Q6OxzWrYjyxWVzEewioU3LCS5vQY6nMUrLwNaxXvoQ59IloFSx54PPAZtQLExVZZDxsVE8J4dn6v4JYatgbSjk0owPw7RGH2ADMo88Z7L20ip8f7gC7fAo0q4+0rt7kEQDvaghVZbiPHUHcyeXcfLjT3jmpR7AYsnSScya3UR8bARVMck7Y/cB75/X6rDf3Fg2dw2jKZm5dXGm1LuAzO5DCo9v6aT0ibco5kzOvLOP+NGTFJtDpPYeZKijk/Rn3QxsfZV7txwhX7ABiZUXBsGvIvguQApNQQva9RMmTvZ2dpVUls+tX/UD7GN/Y8Ws05w6rQF+9vyzg1vZjbvMRJhXiRSU8DpTFFe0QE8S6SfPkOkZoktrB2oAhZWrwljxOPmchiSMYOWNoxNuruFU5vWeXdsojiUon345113dBBQBmTYlTimgdB8nfPo4WjaNFgN9OMEkJ02dnadVt5ki54Esqy+bzKJltVhSPbI3iN2zCyMTeXNCuG7Omm2Zok7PR2+R7jvD8ouruHhmCrB5jVZeYxLdrTP4sr4Vtd9g4MA4qc4c+6cu5NPamfw4P59t2WrA4YdXKkASf7SFivo6PDdEPmf1fRM++zp1bH/0r4I1dD1ODtOWaW4IsvPjL7nqXhloQiSPwjjgMYkMASyGEBkjhISCQwkwzve/18AbT+pk8pVY4UacQi9y+gyZ0eRAw4qHa89LXEx1LXMSPfhDJYRb59BtlLKg2WPT2l6qYl1svtGkrLYckyA1S+t5+2ATm37WCui0LSynsckDNH5zTxAchbQtkx08hDHYiW6NgC0enHBzEZ102UDH8QORdEckjEzZrNWkRydzyx17uGnDXqbUnGZ6dRPjSY91q2TqwjFuvTxLo5Zn5Qo/pumRSFcTLQtybEhGE0fQrDhhJ0VvH2lTnnHPhGtsmWan469apERjI2MH3qN7+7MEfH6ql29CbV7PvsMG32k6yU2XDhEKyZw66eJaRdrXR7CzCcqUNC3zwgymPJRCH4KRRLINimpL14A5Y4GDeOqbsPRVcfuN7Xj44pav/hFfrNT2kr2rsqf2Ibp5pEA14ZIImUyW3t5REkkTXRGQ/DGGhtLginhqCWknQDE5hKf5UFSF9Lj020Q2ul5V1AR2hr+8vuP8Vlc2zMPRxoSjnx7XBC14sDoydahSGq7KdO/HFyrBchxCVfX4fDKp4T7SCQejYODZLrYgIqgKFsNIgQqEYob8mW6yiUyb7Z64LVK/+B85xznnJ3AWzqTzuIX46mr5wLs+UUTyIriBCjRNxguHMJIFDLEEvXEOVRWnSJ0+jCd4CJoGjoedM1CLcXQziW3nMV2TSMBeOx7vWZvPt1r+cMPzE8KunaUkFn0vNrvtqXj34c1W6gzxlEQ6naIoBahtnkMwoFMwIVzSRNguMt53Aj2s4nkSlgPoGqLkICsRNF0gl8rYWuP8+11/w/OOJDEhHPKLCIpOXmi+M9AgP+maiesLifF2T1Rn5ZNj5Lo/Qc/GcPMmhdoqlEgIGzCK4PiCmJKK68p4KfF3qYGuF0qCRUkJTzleUbvQyWRTuE5xYthxQbBs7EISAbkzUFG3VfXXbK2YFi3X/eryfKKnqVBItNjJxDzH8erddC4SqWwcN5WyTtlyO1RP/Lh3eHD76MB40swmiDVJyDLYRhpc5+ub6tse/wWKbvSQEAw1awAAAABJRU5ErkJggg==" title="本站已在工信部备案，备案号蜀ICP备2021030114号"></a>&nbsp;</p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})
setTimeout(function(){preloader.endLoading();}, 3000);</script></div><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-tan.vercel.app',
      region: ''
    }, null))
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'https://twikoo-tan.vercel.app',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://unpkg.zhimg.com/twikoo@1.4.15/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script data-pjax defer src="/js/custom/fixed_card_widget.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '700ms');
    arr[i].setAttribute('data-wow-delay', '700ms');
    arr[i].setAttribute('data-wow-offset', '100');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://unpkg.zhimg.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://unpkg.zhimg.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>